<!DOCTYPE html>

<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CRM ×§×¤×•××™×</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #080b14;
  --sf: #0f1320;
  --s2: #161c2e;
  --s3: #1e2640;
  --br: #252d45;
  --br2: #2d3855;
  --ac: #3b82f6;
  --ac2: #60a5fa;
  --gr: #10b981;
  --rd: #ef4444;
  --yw: #f59e0b;
  --pu: #8b5cf6;
  --or: #f97316;
  --tx: #e2e8f8;
  --t2: #6b7aa8;
  --t3: #3a4468;
  --r: 16px;
  --shadow: 0 8px 32px rgba(0,0,0,.4);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'Heebo', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--tx);
  max-width: 430px;
  margin: 0 auto;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}

/* BG GRADIENT */
body::before {
  content: '';
  position: fixed;
  top: -200px; right: -200px;
  width: 500px; height: 500px;
  background: radial-gradient(circle, rgba(59,130,246,.08) 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}

/* TOPBAR */
.topbar {
  background: rgba(15,19,32,.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--br);
  padding: 12px 16px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 100;
}
.tl { display: flex; align-items: center; gap: 10px; }
.logo {
  width: 36px; height: 36px; border-radius: 10px;
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 900; color: #fff;
  box-shadow: 0 4px 16px rgba(59,130,246,.35);
  flex-shrink: 0;
}
.ttl { font-size: 15px; font-weight: 800; letter-spacing: -.3px; }
.tsub { font-size: 10px; color: var(--t2); margin-top: 1px; }
.hbtns { display: flex; gap: 6px; }
.ibtn {
  width: 34px; height: 34px; border-radius: 10px;
  background: var(--s2); border: 1px solid var(--br);
  color: var(--t2); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; transition: all .15s;
}
.ibtn:active { background: var(--s3); transform: scale(.93); }

/* BOTTOM NAV */
.bnav {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 430px;
  background: rgba(15,19,32,.96);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--br);
  display: flex; z-index: 100;
  padding: 6px 0 calc(6px + env(safe-area-inset-bottom));
}
.ni {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; gap: 2px; cursor: pointer;
  padding: 7px 2px; color: var(--t3); transition: color .2s;
  position: relative;
}
.ni.active { color: var(--ac); }
.ni svg { width: 22px; height: 22px; }
.ni em { font-size: 10px; font-weight: 700; font-style: normal; }
.nbadge {
  position: absolute; top: 3px; right: calc(50% - 18px);
  background: var(--rd); color: #fff; font-size: 9px; font-weight: 800;
  padding: 1px 4px; border-radius: 8px; min-width: 14px; text-align: center; display: none;
}
.nbadge.on { display: block; }

/* PAGES */
.page { display: none; padding: 14px 14px 90px; animation: fadeUp .22s ease; }
.page.active { display: block; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

/* CARDS */
.card {
  background: var(--sf); border: 1px solid var(--br);
  border-radius: var(--r); padding: 14px;
  margin-bottom: 10px; cursor: pointer;
  transition: border-color .15s, transform .1s;
}
.card:active { border-color: var(--ac); transform: scale(.99); }

/* STAT GRID */
.sgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.sbox {
  background: var(--sf); border: 1px solid var(--br);
  border-radius: var(--r); padding: 14px;
  position: relative; overflow: hidden;
}
.sbox::after {
  content: '';
  position: absolute; top: -20px; left: -20px;
  width: 80px; height: 80px; border-radius: 50%;
  opacity: .06;
}
.sbox.b { border-color: rgba(59,130,246,.3); background: rgba(59,130,246,.06); }
.sbox.b::after { background: var(--ac); }
.sbox.r { border-color: rgba(239,68,68,.3); background: rgba(239,68,68,.06); }
.sbox.r::after { background: var(--rd); }
.sbox.g { border-color: rgba(16,185,129,.3); background: rgba(16,185,129,.06); }
.sbox.g::after { background: var(--gr); }
.sbox.p { border-color: rgba(139,92,246,.3); background: rgba(139,92,246,.06); }
.sbox.p::after { background: var(--pu); }
.sv { font-size: 26px; font-weight: 900; line-height: 1.1; }
.sv.b { color: var(--ac); } .sv.r { color: var(--rd); }
.sv.g { color: var(--gr); } .sv.p { color: var(--pu); }
.sl { font-size: 11px; color: var(--t2); margin-top: 4px; font-weight: 500; }
.sicon { font-size: 22px; margin-bottom: 4px; }

/* SECTION HEADER */
.sh { display: flex; align-items: center; justify-content: space-between; margin: 16px 0 10px; }
.st { font-size: 11px; font-weight: 800; color: var(--t2); letter-spacing: .8px; text-transform: uppercase; }
.sa { font-size: 12px; font-weight: 700; color: var(--ac); background: none; border: none; cursor: pointer; }

/* SEARCH */
.sbar {
  background: var(--s2); border: 1px solid var(--br);
  border-radius: 12px; display: flex; align-items: center; gap: 8px;
  padding: 10px 13px; margin-bottom: 12px;
}
.sbar input { flex: 1; background: none; border: none; outline: none; color: var(--tx); font-family: 'Heebo', sans-serif; font-size: 14px; text-align: right; }
.sbar input::placeholder { color: var(--t3); }

/* TABS */
.tabs { display: flex; gap: 6px; margin-bottom: 12px; overflow-x: auto; scrollbar-width: none; }
.tabs::-webkit-scrollbar { display: none; }
.tab {
  padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700;
  white-space: nowrap; cursor: pointer; border: 1px solid var(--br);
  background: var(--sf); color: var(--t2); transition: all .15s; flex-shrink: 0;
}
.tab.active { background: var(--ac); border-color: var(--ac); color: #fff; }

/* CUSTOMER CARD */
.ccard { background: var(--sf); border: 1px solid var(--br); border-radius: var(--r); padding: 14px; margin-bottom: 10px; cursor: pointer; transition: border-color .15s, transform .1s; }
.ccard:active { border-color: var(--ac); transform: scale(.99); }
.crow { display: flex; align-items: center; gap: 12px; }
.av { width: 44px; height: 44px; border-radius: 13px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px; flex-shrink: 0; }
.av1 { background: linear-gradient(135deg,#1e3d8f,#3b82f6); color:#fff; }
.av2 { background: linear-gradient(135deg,#4a2a9f,#8b5cf6); color:#fff; }
.av3 { background: linear-gradient(135deg,#0d5c35,#10b981); color:#fff; }
.av4 { background: linear-gradient(135deg,#8f3d10,#f97316); color:#fff; }
.av5 { background: linear-gradient(135deg,#8f1818,#ef4444); color:#fff; }
.cname { font-size: 15px; font-weight: 800; }
.cmeta { font-size: 11px; color: var(--t2); margin-top: 2px; }
.ctail { margin-right: auto; text-align: left; }
.damount { font-size: 16px; font-weight: 900; }
.damount.r { color: var(--rd); } .damount.g { color: var(--gr); } .damount.z { color: var(--t3); }
.dlabel { font-size: 10px; color: var(--t2); margin-top: 1px; text-align: left; }
.cfooter { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--br); }

/* CHIPS */
.chip { display: inline-flex; align-items: center; gap: 3px; padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 700; }
.cb { background: rgba(59,130,246,.15); color: var(--ac2); }
.cg { background: rgba(16,185,129,.15); color: var(--gr); }
.cr { background: rgba(239,68,68,.15); color: var(--rd); }
.cy { background: rgba(245,158,11,.15); color: var(--yw); }
.cp { background: rgba(139,92,246,.15); color: var(--pu); }

/* EQUIPMENT */
.ecard { background: var(--sf); border: 1px solid var(--br); border-radius: var(--r); padding: 14px; margin-bottom: 10px; cursor: pointer; transition: border-color .15s; }
.ecard:active { border-color: var(--ac); }
.eicon { width: 44px; height: 44px; border-radius: 12px; background: var(--s2); border: 1px solid var(--br); display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
.edot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
.dg { background: var(--gr); box-shadow: 0 0 6px var(--gr); }
.dy { background: var(--yw); }
.dr { background: var(--rd); box-shadow: 0 0 6px var(--rd); }

/* DEBT CARDS */
.dcard { background: var(--sf); border: 1px solid var(--br); border-radius: var(--r); padding: 14px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: border-color .15s; }
.dcard:active { border-color: var(--ac); }
.bigamt { font-size: 19px; font-weight: 900; }
.agebadge { font-size: 10px; font-weight: 800; padding: 2px 7px; border-radius: 10px; margin-top: 3px; text-align: center; }
.age-ok { background: rgba(16,185,129,.15); color: var(--gr); }
.age-warn { background: rgba(245,158,11,.15); color: var(--yw); }
.age-bad { background: rgba(239,68,68,.15); color: var(--rd); }

/* FAB */
.fab {
  position: fixed; bottom: 76px; left: 16px;
  width: 54px; height: 54px; border-radius: 16px;
  background: linear-gradient(135deg, var(--ac), var(--pu));
  border: none; color: #fff; font-size: 28px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 24px rgba(59,130,246,.5);
  transition: transform .15s, box-shadow .15s;
  z-index: 90;
}
.fab:active { transform: scale(.92); box-shadow: 0 2px 10px rgba(59,130,246,.4); }

/* OVERLAY / SHEET */
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.75); z-index: 200; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
.overlay.open { display: flex; }
.overlay.layer2 { z-index: 400; }
.overlay.layer3 { z-index: 600; }
.sheet {
  background: var(--sf); border-radius: 22px 22px 0 0;
  width: 100%; max-width: 430px; max-height: 92vh; overflow-y: auto;
  padding-bottom: calc(20px + env(safe-area-inset-bottom));
  animation: slideUp .28s cubic-bezier(.32,.72,0,1);
  border-top: 1px solid var(--br2);
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: none; } }
.shandle { width: 36px; height: 4px; border-radius: 2px; background: var(--br2); margin: 12px auto 0; }
.shead { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px 12px; border-bottom: 1px solid var(--br); }
.stitle { font-size: 16px; font-weight: 800; }
.xbtn { width: 30px; height: 30px; border-radius: 8px; background: var(--s2); border: none; color: var(--t2); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.sbody { padding: 16px 18px; }

/* FORM */
.fg { margin-bottom: 14px; }
.fl { font-size: 12px; font-weight: 700; color: var(--t2); margin-bottom: 6px; display: block; }
.fi {
  width: 100%; background: var(--s2); border: 1px solid var(--br);
  border-radius: 11px; padding: 11px 13px; color: var(--tx);
  font-family: 'Heebo', sans-serif; font-size: 14px; outline: none;
  transition: border-color .15s; text-align: right; appearance: none;
}
.fi:focus { border-color: var(--ac); }
.fi option { background: var(--s2); }
textarea.fi { resize: none; }
.frow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* BUTTONS */
.btnp {
  width: 100%; padding: 13px;
  background: linear-gradient(135deg, var(--ac), var(--pu));
  border: none; border-radius: 13px; color: #fff;
  font-family: 'Heebo', sans-serif; font-size: 15px; font-weight: 800;
  cursor: pointer; transition: opacity .15s; margin-top: 6px;
  box-shadow: 0 4px 16px rgba(59,130,246,.3);
}
.btnp:active { opacity: .85; }
.btno {
  width: 100%; padding: 12px; background: none; border: 1px solid var(--br);
  border-radius: 12px; color: var(--tx); font-family: 'Heebo', sans-serif;
  font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 8px;
}
.btnd {
  width: 100%; padding: 12px; background: rgba(239,68,68,.1);
  border: 1px solid rgba(239,68,68,.3); border-radius: 12px; color: var(--rd);
  font-family: 'Heebo', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px;
}
.btnwa {
  width: 100%; padding: 12px; background: rgba(37,211,102,.12);
  border: 1px solid rgba(37,211,102,.35); border-radius: 12px; color: #25d366;
  font-family: 'Heebo', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-sm {
  padding: 6px 12px; border-radius: 10px; font-size: 12px; font-weight: 700;
  border: 1px solid var(--br); background: var(--s2); color: var(--tx); cursor: pointer;
}

/* ACTION ROW */
.arow { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; width: 100%; }
.abtn {
  padding: 10px 6px; border-radius: 13px; border: 1px solid var(--br);
  background: var(--s2); color: var(--tx); font-size: 11px; font-weight: 700;
  display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer;
  flex: 1 1 calc(25% - 6px); min-width: 64px; max-width: calc(25% - 6px);
  transition: all .15s;
}
.abtn:active { background: var(--s3); transform: scale(.96); }
.abtn span { font-size: 20px; display: block; }

/* KV */
.dkv { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--br); }
.dkv:last-child { border-bottom: none; }
.dk { font-size: 12px; color: var(--t2); font-weight: 500; }
.dv { font-size: 14px; font-weight: 600; }

/* TOAST */
.toast {
  position: fixed; bottom: 86px; left: 50%; transform: translateX(-50%);
  background: var(--s3); border: 1px solid var(--br2); color: var(--tx);
  font-size: 13px; font-weight: 700; padding: 10px 22px; border-radius: 30px;
  z-index: 300; white-space: nowrap; opacity: 0; transition: opacity .2s; pointer-events: none;
  box-shadow: 0 8px 24px rgba(0,0,0,.4);
}
.toast.show { opacity: 1; }

/* EMPTY */
.empty { text-align: center; padding: 44px 20px; color: var(--t2); }
.empty-icon { font-size: 44px; margin-bottom: 12px; }
.empty-title { font-size: 15px; font-weight: 800; color: var(--tx); margin-bottom: 6px; }
.empty-sub { font-size: 13px; color: var(--t2); }

/* HISTORY */
.hist-item { display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--br); }
.hist-item:last-child { border-bottom: none; }
.hdot { width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }

/* ALERT BANNER */
.alert-banner {
  border-radius: 14px; padding: 14px; margin-bottom: 12px; color: #fff;
}

/* PHOTO */
.photo-upload-area {
  border: 2px dashed var(--br2); border-radius: 12px; padding: 20px;
  text-align: center; cursor: pointer; transition: border-color .2s;
  margin-bottom: 14px; position: relative;
}
.photo-upload-area input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
.photo-preview-wrap { position: relative; margin-bottom: 14px; }
.photo-preview { width: 100%; border-radius: 12px; object-fit: cover; max-height: 200px; display: block; border: 1px solid var(--br); }
.photo-del-btn { position: absolute; top: 8px; left: 8px; width: 28px; height: 28px; border-radius: 8px; background: rgba(239,68,68,.85); border: none; color: #fff; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.photo-gallery { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 4px; }
.photo-gallery-item { position: relative; border-radius: 10px; overflow: hidden; cursor: pointer; }
.photo-gallery-item img { width: 100%; height: 90px; object-fit: cover; display: block; }
.photo-gallery-del { position: absolute; top: 4px; left: 4px; width: 24px; height: 24px; border-radius: 6px; background: rgba(239,68,68,.85); border: none; color: #fff; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.photo-date { position: absolute; bottom: 0; right: 0; left: 0; background: rgba(0,0,0,.55); color: #fff; font-size: 10px; padding: 3px 6px; font-weight: 600; }
.photo-fullscreen { position: fixed; inset: 0; background: rgba(0,0,0,.95); z-index: 500; display: flex; align-items: center; justify-content: center; flex-direction: column; }
.photo-fullscreen img { max-width: 100%; max-height: 80vh; border-radius: 8px; object-fit: contain; }
.photo-fullscreen-close { position: absolute; top: 20px; left: 20px; background: var(--s2); border: none; color: var(--tx); font-size: 22px; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

/* REPORT */
.rep-row { display: flex; justify-content: space-between; align-items: center; padding: 11px 0; border-bottom: 1px solid var(--br); }
.rep-row:last-child { border-bottom: none; }
.rep-l { font-size: 13px; color: var(--t2); }
.rep-v { font-size: 14px; font-weight: 800; }
.rep-total { background: var(--s2); border-radius: 13px; padding: 16px; margin-top: 14px; display: flex; justify-content: space-between; align-items: center; }

/* EXPORT */
.export-btn { width: 100%; padding: 13px; border-radius: 12px; border: 1px solid var(--br); background: var(--s2); color: var(--tx); font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all .15s; }
.export-btn:active { background: var(--s3); }
.export-btn.green { border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.08); color: var(--gr); }

/* LOGIN */
#login-screen {
  position: fixed; inset: 0; background: var(--bg); z-index: 999;
  display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px 24px;
}
.login-logo {
  width: 76px; height: 76px; border-radius: 22px;
  background: linear-gradient(135deg, var(--ac), var(--pu));
  display: flex; align-items: center; justify-content: center;
  font-size: 34px; font-weight: 900; color: #fff; margin-bottom: 28px;
  box-shadow: 0 12px 40px rgba(59,130,246,.4);
}
.login-title { font-size: 26px; font-weight: 900; margin-bottom: 6px; }
.login-sub { font-size: 14px; color: var(--t2); margin-bottom: 36px; }
.login-form { width: 100%; max-width: 340px; }
.login-err { background: rgba(239,68,68,.12); border: 1px solid rgba(239,68,68,.3); border-radius: 11px; padding: 10px 14px; color: var(--rd); font-size: 13px; font-weight: 700; margin-bottom: 14px; display: none; text-align: center; }
.login-err.show { display: block; }

/* INVENTORY SPECIFIC */
.inv-card { background: var(--sf); border: 1px solid var(--br); border-radius: var(--r); padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all .15s; }
.inv-card:active { border-color: var(--ac); transform: scale(.99); }
.inv-bar-wrap { margin-top: 8px; height: 4px; background: var(--s3); border-radius: 4px; overflow: hidden; }
.inv-bar { height: 100%; border-radius: 4px; transition: width .3s; }

/* SECTION DIVIDER */
.sec-div { font-size: 11px; font-weight: 800; color: var(--t2); letter-spacing: .8px; text-transform: uppercase; padding: 12px 0 6px; border-top: 1px solid var(--br); margin-top: 10px; }

/* STATUS TAG */
.status-tag { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }

/* ORDER CARD */
.ord-card { background: var(--sf); border: 1px solid var(--br); border-radius: var(--r); padding: 14px; margin-bottom: 10px; cursor: pointer; transition: border-color .15s; }
.ord-card.pending { border-right: 3px solid var(--yw); }
.ord-card.delivered { border-right: 3px solid var(--gr); }
.ord-card.cancelled { border-right: 3px solid var(--rd); }

/* INPUT ROW */
.qty-input { width: 60px; text-align: center; padding: 6px; font-size: 14px; font-weight: 700; }
</style>

<!-- Firebase ××•×©×‘×ª ×–×× ×™×ª -->

</head>
<body>

<!-- LOGIN SCREEN -->

<div id="login-screen">
  <div style="position:absolute;top:40px;left:50%;transform:translateX(-50%);width:200px;height:200px;background:radial-gradient(circle,rgba(59,130,246,.15),transparent 70%);pointer-events:none"></div>
  <div class="login-logo">â„ï¸</div>
  <div class="login-title">CRM ×§×¤×•××™×</div>
  <div class="login-sub">××¢×¨×›×ª × ×™×”×•×œ ×œ×§×•×—×•×ª ×•×”×¤×¦×”</div>
  <div class="login-form">
    <div class="login-err" id="login-err">×©× ××©×ª××© ××• ×¡×™×¡×× ×©×’×•×™×™×</div>
    <div class="fg"><label class="fl">×©× ××©×ª××©</label><input class="fi" id="login-user" placeholder="tzahi" autocomplete="username" autocapitalize="none"></div>
    <div class="fg"><label class="fl">×¡×™×¡××</label><input class="fi" id="login-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
    <button class="btnp" style="margin-top:8px" onclick="doLogin()">×›× ×™×¡×” ×œ××¢×¨×›×ª â†</button>
  </div>
</div>

<!-- TOPBAR -->

<div class="topbar">
  <div class="tl">
    <div class="logo">â„ï¸</div>
    <div>
      <div class="ttl">CRM ×§×¤×•××™×</div>
      <div class="tsub" id="tsub">××ª×—×‘×¨... <span id="sync-status" style="color:var(--gr);font-weight:700;transition:opacity 1s"></span></div>
    </div>
  </div>
  <div class="hbtns">
    <button class="ibtn" id="thu-btn" onclick="openEnvelopeUpload()" style="opacity:.3" title="××¢×˜×¤×”">ğŸ“¬</button>
    <button class="ibtn" onclick="openReport()">ğŸ“Š</button>
    <button class="ibtn" onclick="openModal('modal-export');populateExportCustSel()">ğŸ“¤</button>
  </div>
</div>

<!-- ===================== PAGES ===================== -->

<!-- DASHBOARD -->

<div class="page active" id="pg-dash">
  <div id="visit-alerts-banner" class="alert-banner" style="display:none;background:linear-gradient(135deg,#1a4a8f,#2563eb)"></div>
  <div id="alerts-banner" class="alert-banner" style="display:none;background:linear-gradient(135deg,#8f1818,#c0392b)"></div>
  <div class="sgrid">
    <div class="sbox b"><div class="sicon">ğŸ‘¥</div><div class="sv b" id="s-cust">0</div><div class="sl">×œ×§×•×—×•×ª ×¤×¢×™×œ×™×</div></div>
    <div class="sbox r"><div class="sicon">ğŸ’¸</div><div class="sv r" id="s-debt">â‚ª0</div><div class="sl">×¡×”"×› ×—×•×‘×•×ª</div></div>
    <div class="sbox g"><div class="sicon">âœ…</div><div class="sv g" id="s-paid">â‚ª0</div><div class="sl">×’×‘×•×™ ×”×—×•×“×©</div></div>
    <div class="sbox p"><div class="sicon">ğŸ“¦</div><div class="sv p" id="s-eq">0</div><div class="sl">×¦×™×•×“ ×‘×©×˜×—</div></div>
  </div>
  <div class="sh"><span class="st">âš¡ ×—×•×‘×•×ª ×“×—×•×¤×™×</span><button class="sa" onclick="goPage('debt',document.getElementById('ni-debt'))">×”×›×œ â†’</button></div>
  <div id="urgent-list"></div>
  <div class="sh"><span class="st">ğŸ• ×œ×§×•×—×•×ª ××—×¨×•× ×™×</span><button class="sa" onclick="goPage('cust',document.getElementById('ni-cust'))">×”×›×œ â†’</button></div>
  <div id="recent-list"></div>
</div>

<!-- CUSTOMERS -->

<div class="page" id="pg-cust">
  <div class="sbar">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" placeholder="×—×™×¤×•×© ×œ×§×•×—..." id="cust-search" oninput="renderCustomers()">
  </div>
  <div class="tabs">
    <div class="tab active" onclick="setTab(this,'all')">×”×›×œ</div>
    <div class="tab" onclick="setTab(this,'debt')">×¢× ×—×•×‘</div>
    <div class="tab" onclick="setTab(this,'ok')">××¡×•×œ×§</div>
    <div class="tab" onclick="setTab(this,'sun')">×¨××©×•×Ÿ</div>
    <div class="tab" onclick="setTab(this,'mon')">×©× ×™</div>
    <div class="tab" onclick="setTab(this,'tue')">×©×œ×™×©×™</div>
    <div class="tab" onclick="setTab(this,'wed')">×¨×‘×™×¢×™</div>
    <div class="tab" onclick="setTab(this,'thu')">×—××™×©×™</div>
  </div>
  <div id="cust-list"></div>
</div>

<!-- EQUIPMENT -->

<div class="page" id="pg-eq">
  <div class="sbar">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" placeholder="×—×™×¤×•×© ×¦×™×•×“..." id="eq-search" oninput="renderEquipment()">
  </div>
  <div class="tabs">
    <div class="tab active" onclick="setEqTab(this,'all')">×”×›×œ</div>
    <div class="tab" onclick="setEqTab(this,'ok')">×ª×§×™×Ÿ</div>
    <div class="tab" onclick="setEqTab(this,'broken')">×ª×§×•×œ</div>
    <div class="tab" onclick="setEqTab(this,'debt')">×—×•×‘ ×¦×™×•×“</div>
  </div>
  <div id="eq-list"></div>
</div>

<!-- DEBT -->

<div class="page" id="pg-debt">
  <div class="sgrid">
    <div class="sbox r"><div class="sv r" id="d-total">â‚ª0</div><div class="sl">×¡×”"×› ×—×•×‘×•×ª</div></div>
    <div class="sbox g"><div class="sv g" id="d-count">0</div><div class="sl">×œ×§×•×—×•×ª ×—×™×™×‘×™×</div></div>
  </div>
  <div class="sbar">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" placeholder="×—×™×¤×•×©..." id="debt-search" oninput="renderDebts()">
  </div>
  <div class="tabs">
    <div class="tab active" onclick="setDebtTab(this,'all')">×”×›×œ</div>
    <div class="tab" onclick="setDebtTab(this,'new')">×¢×“ 30 ×™×•×</div>
    <div class="tab" onclick="setDebtTab(this,'old')">30-60 ×™×•×</div>
    <div class="tab" onclick="setDebtTab(this,'urgent')">60+ ×™×•×</div>
  </div>
  <div id="debt-list"></div>
</div>

<!-- INVENTORY -->

<div class="page" id="pg-inv">
  <div class="sgrid">
    <div class="sbox r"><div class="sv r" id="inv-low">0</div><div class="sl">××œ××™ × ××•×š</div></div>
    <div class="sbox b"><div class="sv b" id="inv-total-prods">0</div><div class="sl">×¡×”"×› ××•×¦×¨×™×</div></div>
  </div>
  <div id="inv-alerts-section"></div>
  <div class="sbar">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" placeholder="×—×™×¤×•×© ××•×¦×¨..." id="inv-search" oninput="renderInventory()">
  </div>
  <div class="tabs">
    <div class="tab active" onclick="setInvTab(this,'all')">×”×›×œ</div>
    <div class="tab" onclick="setInvTab(this,'low')">××œ××™ × ××•×š</div>
    <div class="tab" onclick="setInvTab(this,'icecream')">×’×œ×™×“×•×ª</div>
    <div class="tab" onclick="setInvTab(this,'vegetables')">×™×¨×§×•×ª</div>
    <div class="tab" onclick="setInvTab(this,'dough')">×‘×¦×§</div>
    <div class="tab" onclick="setInvTab(this,'other')">××—×¨</div>
  </div>
  <div id="inv-list"></div>
</div>

<!-- ORDERS -->

<div class="page" id="pg-orders">
  <div class="sgrid">
    <div class="sbox p"><div class="sv p" id="ord-pending">0</div><div class="sl">×××ª×™× ×•×ª</div></div>
    <div class="sbox g"><div class="sv g" id="ord-today">0</div><div class="sl">×”×–×× ×•×ª ×”×™×•×</div></div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="setOrdTab(this,'all')">×”×›×œ</div>
    <div class="tab" onclick="setOrdTab(this,'pending')">×××ª×™×Ÿ</div>
    <div class="tab" onclick="setOrdTab(this,'delivered')">× ××¡×¨</div>
  </div>
  <div id="ord-list"></div>
</div>

<!-- HISTORY -->

<div class="page" id="pg-hist">
  <div class="sgrid" id="hist-stats"></div>
  <div class="sbar">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" placeholder="×—×™×¤×•×© ×ª×©×œ×•×..." id="hist-search" oninput="renderHistory()">
  </div>
  <div class="tabs">
    <div class="tab active" onclick="setHistTab(this,'all')">×”×›×œ</div>
    <div class="tab" onclick="setHistTab(this,'cash')">××–×•××Ÿ</div>
    <div class="tab" onclick="setHistTab(this,'check')">×©×™×§</div>
    <div class="tab" onclick="setHistTab(this,'transfer')">×”×¢×‘×¨×”</div>
    <div class="tab" onclick="setHistTab(this,'credit')">×–×™×›×•×™</div>
  </div>
  <div id="hist-list"></div>
</div>

<!-- MONTHLY COLLECTION -->

<div class="page" id="pg-monthly">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
    <span style="font-size:14px;font-weight:800">×œ×•×— ×’×‘×™×™×” ×œ×¤×™ ×©×•×˜×£</span>
    <span style="font-size:11px;color:var(--t2)">×××•×™×Ÿ ×œ×¤×™ ×ª××¨×™×š ×™×¢×“</span>
  </div>
  <div id="monthly-list"></div>
</div>

<!-- BOTTOM NAV -->

<nav class="bnav">
  <div class="ni active" onclick="goPage('dash',this)" id="ni-dash">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    <em>×¨××©×™</em>
  </div>
  <div class="ni" onclick="goPage('cust',this)" id="ni-cust">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    <em>×œ×§×•×—×•×ª</em>
  </div>
  <div class="ni" onclick="goPage('inv',this)" id="ni-inv">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
    <em>××œ××™</em>
    <div class="nbadge" id="inv-badge"></div>
  </div>
  <div class="ni" onclick="goPage('orders',this)" id="ni-orders">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
    <em>×”×–×× ×•×ª</em>
    <div class="nbadge" id="ord-badge"></div>
  </div>
  <div class="ni" onclick="goPage('debt',this)" id="ni-debt">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
    <em>×’×‘×™×™×”</em>
    <div class="nbadge" id="debt-badge"></div>
  </div>
  <div class="ni" onclick="goPage('hist',this)" id="ni-hist">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    <em>×”×™×¡×˜×•×¨×™×”</em>
  </div>
  <div class="ni" onclick="goPage('monthly',this)" id="ni-monthly">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    <em>×’×‘×™×™×”</em>
  </div>
</nav>

<button class="fab" id="fab-btn" onclick="openAddModal()">+</button>

<div class="toast" id="toast"></div>

<!-- ===================== MODALS ===================== -->

<!-- ADD CUSTOMER -->

<div class="overlay" id="modal-add-cust">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">ğŸ‘¤ ×œ×§×•×— ×—×“×©</span><button class="xbtn" onclick="closeModal('modal-add-cust')">âœ•</button></div>
    <div class="sbody">
      <div class="fg"><label class="fl">×©× ×¢×¡×§ / ×œ×§×•×— *</label><input class="fi" id="nc-name" placeholder="××¨×›×•×œ ×›×”×Ÿ"></div>
      <div class="fg"><label class="fl">×©× ××™×© ×§×©×¨ *</label><input class="fi" id="nc-contact" placeholder="××©×” ×›×”×Ÿ"></div>
      <div class="frow">
        <div class="fg"><label class="fl">×˜×œ×¤×•×Ÿ *</label><input class="fi" id="nc-phone" type="tel" placeholder="050-0000000" dir="ltr"></div>
        <div class="fg"><label class="fl">×¢×™×¨ *</label><input class="fi" id="nc-city" placeholder="×—×™×¤×”"></div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">×ª× ××™ ×ª×©×œ×•× *</label>
          <select class="fi" id="nc-terms" onchange="toggleTermsOther('nc')">
            <option value="">×‘×—×¨...</option>
            <option value="30">×©×•×˜×£ 30</option>
            <option value="60">×©×•×˜×£ 60</option>
            <option value="90">×©×•×˜×£ 90</option>
            <option value="other">××—×¨</option>
          </select>
        </div>
        <div class="fg"><label class="fl">×§×• (××¡×œ×•×œ) *</label>
          <select class="fi" id="nc-route">
            <option value="">×‘×—×¨...</option>
            <option value="×¨××©×•×Ÿ">×¨××©×•×Ÿ</option>
            <option value="×©× ×™">×©× ×™</option>
            <option value="×©×œ×™×©×™">×©×œ×™×©×™</option>
            <option value="×¨×‘×™×¢×™">×¨×‘×™×¢×™</option>
            <option value="×—××™×©×™">×—××™×©×™</option>
          </select>
        </div>
      </div>
      <div class="fg" id="nc-terms-other-wrap" style="display:none"><label class="fl">×¤×™×¨×•×˜ ×ª× ××™× *</label><input class="fi" id="nc-terms-other" placeholder="×œ×“×•×’×³: ×©×•×˜×£ 45"></div>
      <div class="frow">
        <div class="fg"><label class="fl">×ª×“×™×¨×•×ª ×‘×™×§×•×¨ *</label>
          <select class="fi" id="nc-visit-freq">
            <option value="">×‘×—×¨...</option>
            <option value="weekly">×¤×¢× ×‘×©×‘×•×¢</option>
            <option value="biweekly">×¤×¢× ×‘×©×‘×•×¢×™×™×</option>
            <option value="monthly">×¤×¢× ×‘×—×•×“×©</option>
          </select>
        </div>
        <div class="fg"><label class="fl">×™×•× ×‘×™×§×•×¨ *</label>
          <select class="fi" id="nc-visit-day">
            <option value="">×‘×—×¨...</option>
            <option value="×¨××©×•×Ÿ">×¨××©×•×Ÿ</option>
            <option value="×©× ×™">×©× ×™</option>
            <option value="×©×œ×™×©×™">×©×œ×™×©×™</option>
            <option value="×¨×‘×™×¢×™">×¨×‘×™×¢×™</option>
            <option value="×—××™×©×™">×—××™×©×™</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">×”×¢×¨×•×ª</label><input class="fi" id="nc-notes" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></div>
      <button class="btnp" onclick="saveCustomer()">×©××•×¨ ×œ×§×•×— âœ“</button>
    </div>
  </div>
</div>

<!-- EDIT CUSTOMER -->

<div class="overlay layer2" id="modal-edit-cust">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">âœï¸ ×¢×¨×™×›×ª ×œ×§×•×—</span><button class="xbtn" onclick="closeModal('modal-edit-cust')">âœ•</button></div>
    <div class="sbody">
      <div class="fg"><label class="fl">×©× ×¢×¡×§ *</label><input class="fi" id="ec-name"></div>
      <div class="fg"><label class="fl">×©× ××™×© ×§×©×¨ *</label><input class="fi" id="ec-contact"></div>
      <div class="frow">
        <div class="fg"><label class="fl">×˜×œ×¤×•×Ÿ *</label><input class="fi" id="ec-phone" type="tel" dir="ltr"></div>
        <div class="fg"><label class="fl">×¢×™×¨ *</label><input class="fi" id="ec-city"></div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">×ª× ××™ ×ª×©×œ×•× *</label>
          <select class="fi" id="ec-terms" onchange="toggleTermsOther('ec')">
            <option value="">×‘×—×¨...</option>
            <option value="30">×©×•×˜×£ 30</option>
            <option value="60">×©×•×˜×£ 60</option>
            <option value="90">×©×•×˜×£ 90</option>
            <option value="other">××—×¨</option>
          </select>
        </div>
        <div class="fg"><label class="fl">×§×•/××¡×œ×•×œ</label>
          <select class="fi" id="ec-route">
            <option value="">×‘×—×¨...</option>
            <option value="×¨××©×•×Ÿ">×¨××©×•×Ÿ</option>
            <option value="×©× ×™">×©× ×™</option>
            <option value="×©×œ×™×©×™">×©×œ×™×©×™</option>
            <option value="×¨×‘×™×¢×™">×¨×‘×™×¢×™</option>
            <option value="×—××™×©×™">×—××™×©×™</option>
          </select>
        </div>
      </div>
      <div class="fg" id="ec-terms-other-wrap" style="display:none"><label class="fl">×¤×™×¨×•×˜ ×ª× ××™× *</label><input class="fi" id="ec-terms-other"></div>
      <div class="frow">
        <div class="fg"><label class="fl">×ª×“×™×¨×•×ª ×‘×™×§×•×¨</label>
          <select class="fi" id="ec-visit-freq">
            <option value="">×‘×—×¨...</option>
            <option value="weekly">×¤×¢× ×‘×©×‘×•×¢</option>
            <option value="biweekly">×¤×¢× ×‘×©×‘×•×¢×™×™×</option>
            <option value="monthly">×¤×¢× ×‘×—×•×“×©</option>
          </select>
        </div>
        <div class="fg"><label class="fl">×™×•× ×‘×™×§×•×¨</label>
          <select class="fi" id="ec-visit-day">
            <option value="">×‘×—×¨...</option>
            <option value="×¨××©×•×Ÿ">×¨××©×•×Ÿ</option>
            <option value="×©× ×™">×©× ×™</option>
            <option value="×©×œ×™×©×™">×©×œ×™×©×™</option>
            <option value="×¨×‘×™×¢×™">×¨×‘×™×¢×™</option>
            <option value="×—××™×©×™">×—××™×©×™</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">×”×¢×¨×•×ª</label><textarea class="fi" id="ec-notes" rows="2"></textarea></div>
      <button class="btnp" onclick="saveEditCust()">×©××•×¨ ×©×™× ×•×™×™× âœ“</button>
    </div>
  </div>
</div>

<!-- ADD EQUIPMENT -->

<div class="overlay layer2" id="modal-add-eq">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">ğŸ“¦ ×¦×™×•×“ ×—×“×©</span><button class="xbtn" onclick="closeModal('modal-add-eq')">âœ•</button></div>
    <div class="sbody">
      <div class="fg"><label class="fl">×¡×•×’ ×¦×™×•×“ *</label>
        <select class="fi" id="ne-type">
          <option value="××§×¨×¨">ğŸ§Š ××§×¨×¨</option>
          <option value="××§×¤×™× ×¢×•××“">â„ï¸ ××§×¤×™× ×¢×•××“</option>
          <option value="××§×¤×™× ×©×•×›×‘">ğŸ§Š ××§×¤×™× ×©×•×›×‘</option>
          <option value="××“×£">ğŸª ××“×£</option>
          <option value="××—×¨">ğŸ”§ ××—×¨</option>
        </select>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">××¡×¤×¨ ×¡×™×“×•×¨×™ *</label><input class="fi" id="ne-serial" placeholder="SN-001" dir="ltr"></div>
        <div class="fg"><label class="fl">×œ×§×•×— *</label><select class="fi" id="ne-cust"></select></div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">×ª××¨×™×š ×”×¦×‘×”</label><input class="fi" id="ne-placed" type="date"></div>
        <div class="fg"><label class="fl">××™×¡×•×£ ××ª×•×›× ×Ÿ</label><input class="fi" id="ne-collect" type="date"></div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">××¦×‘</label>
          <select class="fi" id="ne-status">
            <option value="ok">âœ… ×ª×§×™×Ÿ</option>
            <option value="broken">âŒ ×ª×§×•×œ</option>
            <option value="maintenance">ğŸ”§ ×ª×—×–×•×§×”</option>
          </select>
        </div>
        <div class="fg"><label class="fl">×—×•×‘ ×¦×™×•×“ â‚ª</label><input class="fi" id="ne-debt" type="number" placeholder="0" dir="ltr"></div>
      </div>
      <div class="fg"><label class="fl">×”×¢×¨×•×ª</label><input class="fi" id="ne-notes" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></div>
      <button class="btnp" onclick="saveEquipment()">×©××•×¨ ×¦×™×•×“ âœ“</button>
    </div>
  </div>
</div>

<!-- CUSTOMER INVENTORY ITEM DETAIL -->

<div class="overlay layer2" id="modal-cust-inv-item">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle" id="cii-title">××•×¦×¨</span><button class="xbtn" onclick="closeModal('modal-cust-inv-item')">âœ•</button></div>
    <div class="sbody" id="cii-body"></div>
  </div>
</div>

<!-- CUSTOMER INVENTORY FORM (add/edit) -->

<div class="overlay layer2" id="modal-cust-inv-form">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">ğŸ“¦ ××•×¦×¨ ×‘×¨×©×™××ª ×œ×§×•×—</span><button class="xbtn" onclick="closeModal('modal-cust-inv-form')">âœ•</button></div>
    <div class="sbody">
      <div class="fg"><label class="fl">×©× ××•×¦×¨ *</label><input class="fi" id="cif-name" placeholder="×’×œ×™×“×” ×©×•×§×•×œ×“ 1×§×´×’"></div>
      <div class="fg"><label class="fl">×§×˜×’×•×¨×™×”</label>
        <select class="fi" id="cif-cat">
          <option value="icecream">ğŸ¦ ×’×œ×™×“×•×ª</option>
          <option value="vegetables">ğŸ¥¦ ×™×¨×§×•×ª ×§×¤×•××™×</option>
          <option value="dough">ğŸ¥ ××•×¦×¨×™ ×‘×¦×§</option>
          <option value="fruit">ğŸ“ ×¤×™×¨×•×ª ×§×¤×•××™×</option>
          <option value="other">ğŸ“¦ ××—×¨</option>
        </select>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">×›××•×ª ×‘×¨×©×•×ª×•</label><input class="fi" id="cif-qty" type="number" placeholder="0" dir="ltr"></div>
        <div class="fg"><label class="fl">×›××•×ª ××™× ×™××•×</label><input class="fi" id="cif-min" type="number" placeholder="0" dir="ltr"></div>
      </div>
      <div class="fg"><label class="fl">××—×™×¨ ××›×™×¨×” â‚ª</label><input class="fi" id="cif-price" type="number" placeholder="0" dir="ltr"></div>
      <div class="fg"><label class="fl">×ª××¨×™×š ×ª×¤×•×’×”</label><input class="fi" id="cif-exp" type="date"></div>
      <div class="fg"><label class="fl">×”×¢×¨×•×ª</label><input class="fi" id="cif-notes" placeholder="×¤×¨×˜×™×..."></div>
      <button class="btnp" id="cif-save-btn">×©××•×¨ âœ“</button>
    </div>
  </div>
</div>

<!-- CUSTOMER ORDER FORM -->

<div class="overlay layer2" id="modal-cust-order">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle" id="cord-title">ğŸ“‹ ×”×–×× ×” ×—×“×©×”</span><button class="xbtn" onclick="closeModal('modal-cust-order')">âœ•</button></div>
    <div class="sbody">
      <div id="cord-inv-notice" style="display:none;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:10px;padding:10px;margin-bottom:12px;font-size:13px;color:var(--yw)">
        âš ï¸ ×œ×œ×§×•×— ×–×” ××™×Ÿ ××•×¦×¨×™× ××•×’×“×¨×™×. ×”×•×¡×£ ××•×¦×¨×™× ×ª×—×™×œ×” ×‘×˜××‘ "××œ××™".
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">×ª××¨×™×š</label><input class="fi" id="cord-date" type="date"></div>
        <div class="fg"><label class="fl">××¡×™×¨×”</label><input class="fi" id="cord-deliver-date" type="date"></div>
      </div>
      <div class="sec-div">×¤×¨×™×˜×™× ×œ×”×–×× ×”</div>
      <div id="cord-items-list"></div>
      <button class="btno" onclick="addCustOrderItem()" style="margin-top:8px">+ ×”×•×¡×£ ×¤×¨×™×˜</button>
      <div class="fg" style="margin-top:12px"><label class="fl">×”×¢×¨×•×ª</label><textarea class="fi" id="cord-notes" rows="2" placeholder="×”×•×¨××•×ª ××™×•×—×“×•×ª..."></textarea></div>
      <div id="cord-total-preview" style="background:var(--s2);border-radius:12px;padding:12px;margin-top:8px;display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:13px;color:var(--t2)">×¡×”"×› ×”×–×× ×”</span>
          <span id="cord-total-val" style="font-size:18px;font-weight:900;color:var(--ac)">â‚ª0</span>
        </div>
      </div>
      <button class="btnp" onclick="saveCustOrder()">×¦×•×¨ ×”×–×× ×” âœ“</button>
    </div>
  </div>
</div>

<!-- ORDER DETAIL -->

<div class="overlay layer2" id="modal-ord-detail">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle" id="ordd-title">×¤×¨×˜×™ ×”×–×× ×”</span><button class="xbtn" onclick="closeModal('modal-ord-detail')">âœ•</button></div>
    <div class="sbody" id="ordd-body"></div>
  </div>
</div>

<!-- PAYMENT -->

<div class="overlay layer2" id="modal-payment">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">ğŸ’° ×¨×™×©×•× ×ª×©×œ×•×</span><button class="xbtn" onclick="closeModal('modal-payment')">âœ•</button></div>
    <div class="sbody">
      <div class="fg"><label class="fl">×œ×§×•×—</label><input class="fi" id="pay-cust-name" readonly></div>
      <div class="fg"><label class="fl">×™×ª×¨×ª ×—×•×‘</label><input class="fi" id="pay-balance" readonly dir="ltr"></div>
      <div class="frow">
        <div class="fg"><label class="fl">×¡×›×•× â‚ª *</label><input class="fi" id="pay-amount" type="number" placeholder="0" dir="ltr"></div>
        <div class="fg"><label class="fl">×××¦×¢×™ ×ª×©×œ×•× *</label>
          <select class="fi" id="pay-method" onchange="onPayMethodChange()">
            <option value="××–×•××Ÿ">ğŸ’µ ××–×•××Ÿ</option>
            <option value="×©×™×§">ğŸ“ ×©×™×§</option>
            <option value="×”×¢×‘×¨×”">ğŸ¦ ×”×¢×‘×¨×”</option>
            <option value="×–×™×›×•×™">ğŸ’° ×–×™×›×•×™</option>
          </select>
        </div>
      </div>
      <div class="fg" id="pay-check-wrap" style="display:none"><label class="fl">××¡×¤×¨ ×©×™×§ *</label><input class="fi" id="pay-check" placeholder="123456" dir="ltr"></div>
      <div class="fg" id="pay-check-date-wrap" style="display:none"><label class="fl">×ª××¨×™×š ×¢×œ ×”×©×™×§ *</label><input class="fi" id="pay-check-date" type="date"></div>
      <div class="fg" id="pay-docref-wrap" style="display:none"><label class="fl">××¡×¤×¨ ××¡××š (×œ×–×™×›×•×™) *</label><input class="fi" id="pay-docref" placeholder="ZK-001" dir="ltr"></div>
      <div class="fg"><label class="fl">×ª××¨×™×š</label><input class="fi" id="pay-date" type="date"></div>
      <div class="fg"><label class="fl">×‘×—×¨ ××¡××š ×œ×¡×’×™×¨×”</label>
        <select class="fi" id="pay-doc-select"><option value="">-- ×œ×œ× ×©×™×•×š --</option></select>
      </div>
      <div class="fg"><label class="fl">×”×¢×¨×” *</label><input class="fi" id="pay-note" placeholder="×—×•×‘×” ×œ×”×–×™×Ÿ ×”×¢×¨×”..."></div>
      <button class="btnp" onclick="savePayment()">××©×¨ ×ª×©×œ×•× âœ“</button>
    </div>
  </div>
</div>

<!-- ADD DEBT -->

<div class="overlay layer2" id="modal-add-debt">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">ğŸ“‹ ×”×•×¡×¤×ª ×—×•×‘</span><button class="xbtn" onclick="closeModal('modal-add-debt')">âœ•</button></div>
    <div class="sbody">
      <div class="fg" id="ad-cust-wrap"><label class="fl">×œ×§×•×— *</label><select class="fi" id="ad-cust-sel"></select></div>
      <div class="frow">
        <div class="fg"><label class="fl">××¡×¤×¨ ××¡××š *</label><input class="fi" id="ad-docnum" type="text" placeholder="12345" dir="ltr"></div>
        <div class="fg"><label class="fl">×ª××¨×™×š</label><input class="fi" id="ad-date" type="date"></div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">×¡×›×•× â‚ª *</label><input class="fi" id="ad-amount" type="number" placeholder="0" dir="ltr"></div>
        <div class="fg"><label class="fl">×ª×™××•×¨</label><input class="fi" id="ad-desc" placeholder="×¢×‘×•×¨ ××”..."></div>
      </div>
      <button class="btnp" onclick="saveDebt()">×”×•×¡×£ ×—×•×‘ âœ“</button>
    </div>
  </div>
</div>

<!-- CUSTOMER DETAIL -->

<div class="overlay" id="modal-cust-detail">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead">
      <span class="stitle" id="cd-title">×¤×¨×˜×™ ×œ×§×•×—</span>
      <div style="display:flex;gap:6px">
        <button onclick="deleteActiveCust()" style="color:var(--rd);background:none;border:none;font-size:12px;cursor:pointer;padding:2px 6px">ğŸ—‘ï¸</button>
        <button class="xbtn" onclick="closeModal('modal-cust-detail')">âœ•</button>
      </div>
    </div>
    <div class="sbody">
      <div class="arow" id="cd-actions"></div>
      <!-- Tabs -->
      <div class="tabs" style="margin-top:12px">
        <div class="tab active" id="cdt-info" onclick="setCustDetailTab('info')">×¤×¨×˜×™×</div>
        <div class="tab" id="cdt-inv" onclick="setCustDetailTab('inv')">ğŸ“¦ ××œ××™</div>
        <div class="tab" id="cdt-orders" onclick="setCustDetailTab('orders')">ğŸ›’ ×”×–×× ×•×ª</div>
        <div class="tab" id="cdt-debts" onclick="setCustDetailTab('debts')">×—×•×‘×•×ª</div>
      </div>
      <!-- Info tab -->
      <div id="cd-tab-info">
        <div style="margin-top:4px"><div id="cd-info"></div></div>
        <div style="margin-top:4px"><div class="sh"><span class="st">×¦×™×•×“ ××¦×œ ×œ×§×•×—</span></div><div id="cd-equipment"></div></div>
        <div style="margin-top:4px"><div class="sh"><span class="st">×”×™×¡×˜×•×¨×™×” ××—×¨×•× ×”</span></div><div id="cd-history"></div></div>
      </div>
      <!-- Inventory tab -->
      <div id="cd-tab-inv" style="display:none">
        <div class="sh" style="margin-top:4px">
          <span class="st">××œ××™ ×”×œ×§×•×—</span>
          <button onclick="openAddCustInv(activeCid)" style="font-size:12px;font-weight:700;color:var(--ac);background:none;border:none;cursor:pointer">+ ×”×•×¡×£ ××•×¦×¨</button>
        </div>
        <div class="sbar" style="margin-bottom:8px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" placeholder="×—×™×¤×•×© ××•×¦×¨..." id="inv-search-cust" oninput="renderCustDetailInv(activeCid)" style="flex:1;background:none;border:none;outline:none;color:var(--tx);font-family:'Heebo',sans-serif;font-size:13px;text-align:right">
        </div>
        <div id="cd-inventory"></div>
      </div>
      <!-- Orders tab -->
      <div id="cd-tab-orders" style="display:none">
        <div class="sh" style="margin-top:4px">
          <span class="st">×”×–×× ×•×ª</span>
          <button onclick="openAddCustOrder(activeCid)" style="font-size:12px;font-weight:700;color:var(--ac);background:none;border:none;cursor:pointer">+ ×”×–×× ×” ×—×“×©×”</button>
        </div>
        <div class="sbar" style="margin-bottom:8px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" placeholder="×—×™×¤×•×© ×”×–×× ×”..." id="ord-search-cust" oninput="renderCustDetailOrders(activeCid)" style="flex:1;background:none;border:none;outline:none;color:var(--tx);font-family:'Heebo',sans-serif;font-size:13px;text-align:right">
        </div>
        <div id="cd-orders"></div>
      </div>
      <!-- Debts tab -->
      <div id="cd-tab-debts" style="display:none">
        <div class="sh" style="margin-top:4px;margin-bottom:6px">
          <span class="st">×—×•×‘×•×ª ×¤×ª×•×—×™×</span>
          <button onclick="openDebtModal(activeCid)" style="font-size:12px;font-weight:700;color:var(--ac);background:none;border:none;cursor:pointer">+ ×”×•×¡×£</button>
        </div>
        <div class="sbar" style="margin-bottom:8px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" placeholder="×—×™×¤×•×© ×—×•×‘ / ××¡××š..." id="debt-search-cust" oninput="renderCustDetailDebts(activeCid)" style="flex:1;background:none;border:none;outline:none;color:var(--tx);font-family:'Heebo',sans-serif;font-size:13px;text-align:right">
        </div>
        <div id="cd-debts"></div>
      </div>
    </div>
  </div>
</div>

<!-- EQUIPMENT DETAIL -->

<div class="overlay" id="modal-eq-detail">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle" id="ed-title">×¤×¨×˜×™ ×¦×™×•×“</span><button class="xbtn" onclick="closeModal('modal-eq-detail')">âœ•</button></div>
    <div class="sbody">
      <div class="arow" id="ed-actions"></div>
      <div style="margin-top:16px" id="ed-info"></div>
    </div>
  </div>
</div>

<!-- VISIT MODAL -->

<div class="overlay layer2" id="modal-visit">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">ğŸ“¸ ×¢×“×›×•×Ÿ ×‘×™×§×•×¨</span><button class="xbtn" onclick="closeModal('modal-visit')">âœ•</button></div>
    <div class="sbody">
      <div id="visit-alert-banner" style="display:none;background:var(--rd);color:#fff;border-radius:10px;padding:10px;margin-bottom:12px;font-size:13px"></div>
      <div class="fg"><label class="fl">×ª××•× ×” ××”×‘×™×§×•×¨ *</label>
        <input type="file" accept="image/*" id="visit-photo" capture="environment" class="fi" style="padding:8px">
      </div>
      <div class="fg"><label class="fl">×”×¢×¨×•×ª ×‘×™×§×•×¨</label>
        <textarea class="fi" id="visit-notes" rows="3" placeholder="××” × ×¢×©×” ×‘×‘×™×§×•×¨?"></textarea>
      </div>
      <div id="visit-skip-wrap" style="display:none">
        <div style="font-weight:700;color:var(--rd);margin-bottom:6px;font-size:13px">âš ï¸ ×‘×™×§×•×¨ ×œ× ×‘×•×¦×¢:</div>
        <div class="fg"><textarea class="fi" id="visit-skip-reason" rows="2" placeholder="×¡×™×‘×” ×œ××™-×‘×™×§×•×¨ (×—×•×‘×”)..."></textarea></div>
      </div>
      <button class="btnp" onclick="saveVisit()">×©××•×¨ ×‘×™×§×•×¨ âœ“</button>
      <button onclick="markVisitSkipped()" style="width:100%;margin-top:8px;padding:12px;border-radius:12px;background:none;border:1px solid var(--br);color:var(--t2);font-size:14px;cursor:pointer">×œ× ×‘×™×§×¨×ª×™ â€” ×¨×©×•× ×¡×™×‘×”</button>
    </div>
  </div>
</div>

<!-- CUSTOMER HISTORY MODAL -->

<div class="overlay layer2" id="modal-cust-hist">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle" id="ch-title">×”×™×¡×˜×•×¨×™×”</span><button class="xbtn" onclick="closeModal('modal-cust-hist')">âœ•</button></div>
    <div class="sbody" id="ch-body"></div>
  </div>
</div>

<!-- ADD PICKER -->

<div class="overlay" id="modal-picker">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">â• ×”×•×¡×¤×” ×—×“×©×”</span><button class="xbtn" onclick="closeModal('modal-picker')">âœ•</button></div>
    <div class="sbody">
      <button class="btno" style="margin-top:0" onclick="closeModal('modal-picker');openModal('modal-add-cust')">ğŸ‘¤ ×œ×§×•×— ×—×“×©</button>
      <button class="btno" onclick="closeModal('modal-picker');openAddEq()">ğŸ“¦ ×¦×™×•×“ ×—×“×©</button>
      <button class="btno" onclick="closeModal('modal-picker');openAddDebtGeneral()">ğŸ’¸ ×—×•×‘ ×—×“×©</button>
      <button class="btno" onclick="closeModal('modal-picker');openPaymentGeneral()">âœ… ×ª×©×œ×•×</button>
      <div style="margin-top:8px;padding:10px;background:var(--s3);border-radius:10px;font-size:12px;color:var(--t2);text-align:center">ğŸ“¦ ××œ××™ ×•×”×–×× ×•×ª â€” ×¤×ª×— ×›×¨×˜×™×¡ ×œ×§×•×—</div>
    </div>
  </div>
</div>

<!-- EXPORT MODAL -->

<div class="overlay" id="modal-export">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">ğŸ“¤ ×™×¦×•× / ×™×‘×•×</span><button class="xbtn" onclick="closeModal('modal-export')">âœ•</button></div>
    <div class="sbody">

```
  <!-- FULL BACKUP -->
  <div style="background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.25);border-radius:14px;padding:14px;margin-bottom:12px">
    <div style="font-size:12px;font-weight:800;color:var(--ac);margin-bottom:10px">ğŸ’¾ ×’×™×‘×•×™ ××œ× (JSON)</div>
    <button class="export-btn green" style="margin-top:0" onclick="exportFullBackup()">ğŸ“¥ ×”×•×¨×“ ×’×™×‘×•×™ ××œ×</button>
    <div style="margin-top:8px">
      <label style="display:block;font-size:12px;color:var(--t2);margin-bottom:6px;font-weight:700">ğŸ“¤ ×©×—×–×¨ ××’×™×‘×•×™</label>
      <div style="position:relative;border:2px dashed var(--br2);border-radius:10px;padding:12px;text-align:center;cursor:pointer" onclick="document.getElementById('import-json-file').click()">
        <div style="font-size:12px;color:var(--t2)" id="import-json-label">×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×•×‘×¥ JSON...</div>
        <input type="file" id="import-json-file" accept=".json" style="position:absolute;inset:0;opacity:0;cursor:pointer" onchange="importFromJSON(this)">
      </div>
    </div>
  </div>

  <!-- CSV EXPORT -->
  <div style="background:var(--s2);border:1px solid var(--br);border-radius:14px;padding:14px;margin-bottom:12px">
    <div style="font-size:12px;font-weight:800;color:var(--t2);margin-bottom:10px">ğŸ“Š ×™×¦×•× CSV ×œ××§×¡×œ</div>
    <button class="export-btn green" style="margin-top:0" onclick="exportCSV('customers')">ğŸ‘¤ ×œ×§×•×—×•×ª</button>
    <button class="export-btn green" onclick="exportCSV('debts')">ğŸ“‹ ×—×•×‘×•×ª</button>
    <button class="export-btn green" onclick="exportCSV('payments')">ğŸ’° ×ª×©×œ×•××™×</button>
    <button class="export-btn green" onclick="exportCSV('inventory')">ğŸ“¦ ××œ××™</button>
    <button class="export-btn green" onclick="exportCSV('equipment')">ğŸ§Š ×¦×™×•×“</button>
  </div>

  <!-- CSV IMPORT -->
  <div style="background:var(--s2);border:1px solid var(--br);border-radius:14px;padding:14px">
    <div style="font-size:12px;font-weight:800;color:var(--t2);margin-bottom:10px">ğŸ“¥ ×™×‘×•× ×-CSV</div>
    <div class="fg" style="margin-bottom:8px">
      <label class="fl">×¡×•×’ ×™×™×‘×•×</label>
      <select class="fi" id="import-csv-type" style="font-size:13px">
        <option value="customers">ğŸ‘¤ ×œ×§×•×—×•×ª</option>
        <option value="debts">ğŸ“‹ ×—×•×‘×•×ª</option>
        <option value="payments">ğŸ’° ×ª×©×œ×•××™×</option>
        <option value="inventory">ğŸ“¦ ××œ××™</option>
      </select>
    </div>
    <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:10px;padding:10px;margin-bottom:8px;font-size:11px;color:var(--yw);line-height:1.6">
      âš ï¸ ×”×§×•×‘×¥ ×—×™×™×‘ ×œ×”×™×•×ª ×‘×“×™×•×§ ×‘××•×ª×• ×¤×•×¨××˜ ×©×œ ×”×™×¦×•×. ×¨×©×•××•×ª ×§×™×™××•×ª ×¢× ××•×ª×• ××–×”×” ×™×•×—×œ×¤×•.
    </div>
    <div style="position:relative;border:2px dashed var(--br2);border-radius:10px;padding:12px;text-align:center;cursor:pointer" onclick="document.getElementById('import-csv-file').click()">
      <div style="font-size:12px;color:var(--t2)" id="import-csv-label">×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×•×‘×¥ CSV...</div>
      <input type="file" id="import-csv-file" accept=".csv" style="position:absolute;inset:0;opacity:0;cursor:pointer" onchange="importFromCSV(this)">
    </div>
    <div id="import-result" style="display:none;margin-top:10px;font-size:12px;font-weight:700;text-align:center;padding:8px;border-radius:8px"></div>
  </div>

</div>
```

  </div>
</div>

<!-- REPORT MODAL -->

<div class="overlay" id="modal-report">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">ğŸ“Š ×“×•×— ×’×‘×™×™×”</span><button class="xbtn" onclick="closeModal('modal-report')">âœ•</button></div>
    <div class="sbody" id="report-body"></div>
  </div>
</div>

<!-- ENVELOPE MODAL -->

<div class="overlay" id="modal-envelope">
  <div class="sheet">
    <div class="shandle"></div>
    <div class="shead"><span class="stitle">ğŸ“¬ ××¢×˜×¤×” â€” ×™×•× ×—××™×©×™</span><button class="xbtn" onclick="closeModal('modal-envelope')">âœ•</button></div>
    <div class="sbody">
      <div style="text-align:center;padding:12px 0;color:var(--yw);font-size:14px;font-weight:700">âš ï¸ ×—×•×‘×” ×œ×”×¢×œ×•×ª ×ª××•× ×” ×©×œ ×”××¢×˜×¤×”</div>
      <div class="fg"><label class="fl">×ª××•× ×ª ×”××¢×˜×¤×” *</label>
        <input type="file" accept="image/*" id="envelope-photo" capture="environment" class="fi" style="padding:8px">
      </div>
      <div class="fg"><label class="fl">×”×¢×¨×”</label><input class="fi" id="envelope-note" placeholder="×ª×•×›×Ÿ ×”××¢×˜×¤×”..."></div>
      <button class="btnp" onclick="saveEnvelope()">××©×¨ ×”×¢×œ××” âœ…</button>
      <div id="envelope-status" style="text-align:center;margin-top:8px;font-size:12px;color:var(--gr)"></div>
    </div>
  </div>
</div>

<!-- PHOTO FULLSCREEN -->

<div class="photo-fullscreen" id="photo-fullscreen" style="display:none" onclick="closeFullscreen()">
  <button class="photo-fullscreen-close" onclick="closeFullscreen()">âœ•</button>
  <img id="photo-fullscreen-img" src="">
  <div style="color:var(--t2);font-size:12px;margin-top:12px" id="photo-fullscreen-date"></div>
</div>

<script>
// ===================== LOCAL ONLY (Firebase ××•×©×‘×ª ×–×× ×™×ª) =====================
function saveToCloud() {
  // Firebase ××•×©×‘×ª â€” ×©×•××¨ ×¨×§ ×‘-localStorage
}

function loadFromCloud() {
  showSyncStatus('ğŸ’¾ ××§×•××™ ×‘×œ×‘×“');
}

function showSyncStatus(msg) {
  const el = document.getElementById('sync-status');
  if (!el) return;
  el.textContent = msg;
  el.style.opacity = '1';
  setTimeout(() => { if(el) el.style.opacity = '0.4'; }, 3000);
}

function updateTopSub() {
  const el = document.getElementById('tsub');
  if (el) el.innerHTML = DB.customers.length + ' ×œ×§×•×—×•×ª Â· ' + DB.equipment.length + ' ×¦×™×•×“ <span id="sync-status" style="color:var(--gr);font-weight:700;transition:opacity 1s"></span>';
}

// ===================== DATA =====================
const SK = 'crm_v5';
function load() {
  try { const d = localStorage.getItem(SK); if (d) return JSON.parse(d); } catch(e) {}
  try { const old = localStorage.getItem('crm_v4'); if (old) { const db = JSON.parse(old); db.customers.forEach(c => { if (!c.inventory) c.inventory = []; if (!c.orders) c.orders = []; }); return db; } } catch(e) {}
  return { customers: [], equipment: [], payments: [], debts: [], visits: [] };
}
function save() {
  if (!DB.visits) DB.visits = [];
  DB.customers.forEach(c => { if (!c.inventory) c.inventory = []; if (!c.orders) c.orders = []; });
  localStorage.setItem(SK, JSON.stringify(DB));
  saveToCloud();
}
let DB = load();
if (!DB.visits) DB.visits = [];
DB.customers.forEach(c => { if (!c.inventory) c.inventory = []; if (!c.orders) c.orders = []; });
function custInventory(cid) { const c = getCust(cid); return c ? (c.inventory || []) : []; }
function custOrders(cid) { const c = getCust(cid); return c ? (c.orders || []) : []; }

// ===================== UTILS =====================
function uid() { return '_' + Math.random().toString(36).substr(2, 9); }
function fmt(n) { return 'â‚ª' + Number(n).toLocaleString('he-IL'); }
function today() { return new Date().toISOString().split('T')[0]; }
function daysDiff(d) { if (!d) return 0; return Math.floor((Date.now() - new Date(d)) / 86400000); }
function fmtDate(d) { if (!d) return 'â€”'; const p = d.split('-'); return p[2]+'/'+p[1]+'/'+p[0]; }
function getCust(id) { return DB.customers.find(c => c.id === id); }
function avClass(i) { return 'av' + (i % 5 + 1); }
function avLetter(n) { return n ? n.charAt(0) : '?'; }

function custDebt(cid) {
  let total = 0;
  DB.debts.filter(x => x.custId === cid && !x.isCredit).forEach(x => {
    if (!x.closed) total += Number(x.amount) - (x.paidAmount || 0);
  });
  const cr = DB.debts.filter(x => x.custId === cid && x.isCredit).reduce((s, x) => s + Math.abs(Number(x.amount)), 0);
  const p = DB.payments.filter(x => x.custId === cid && !x.linkedDoc).reduce((s, x) => s + Number(x.amount), 0);
  return total - cr - p;
}
function eqDebt(cid) { return DB.equipment.filter(e => e.custId === cid).reduce((s, e) => s + Number(e.eqDebt || 0), 0); }
function totalDebt(cid) { return custDebt(cid) + eqDebt(cid); }

// ===================== NAVIGATION =====================
let curPage = 'dash', activeCid = null, activeEid = null, activeInvId = null, activeOrdId = null;
let curTab = { cust: 'all', eq: 'all', debt: 'all', inv: 'all', ord: 'all' };

function goPage(name, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));
  document.getElementById('pg-' + name).classList.add('active');
  (el || document.getElementById('ni-' + name)).classList.add('active');
  curPage = name;
  const hideFab = ['dash', 'hist', 'monthly'];
  document.getElementById('fab-btn').style.display = hideFab.includes(name) ? 'none' : 'flex';
  renderAll();
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(o => o.addEventListener('click', e => {
  if (e.target === o) {
    // Only close the topmost open overlay
    const allOpen = [...document.querySelectorAll('.overlay.open')];
    if (allOpen.length === 0) return;
    // Find highest z-index open overlay
    let top = allOpen[0];
    allOpen.forEach(ov => {
      const z = parseInt(getComputedStyle(ov).zIndex) || 0;
      const topZ = parseInt(getComputedStyle(top).zIndex) || 0;
      if (z > topZ) top = ov;
    });
    if (top === o) o.classList.remove('open');
  }
}));

function openAddModal() {
  if (curPage === 'cust') openModal('modal-add-cust');
  else if (curPage === 'eq') openAddEq();
  else if (curPage === 'debt') openAddDebtGeneral();
  else openModal('modal-picker');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ===================== TABS =====================
function setTab(el, f) { document.querySelectorAll('#pg-cust .tab').forEach(t => t.classList.remove('active')); el.classList.add('active'); curTab.cust = f; renderCustomers(); }
function setEqTab(el, f) { document.querySelectorAll('#pg-eq .tab').forEach(t => t.classList.remove('active')); el.classList.add('active'); curTab.eq = f; renderEquipment(); }
function setDebtTab(el, f) { document.querySelectorAll('#pg-debt .tab').forEach(t => t.classList.remove('active')); el.classList.add('active'); curTab.debt = f; renderDebts(); }
function setInvTab(el, f) { document.querySelectorAll('#pg-inv .tab').forEach(t => t.classList.remove('active')); el.classList.add('active'); curTab.inv = f; renderInventory(); }
function setOrdTab(el, f) { document.querySelectorAll('#pg-orders .tab').forEach(t => t.classList.remove('active')); el.classList.add('active'); curTab.ord = f; renderOrders(); }
let histTab = 'all';
function setHistTab(el, f) { document.querySelectorAll('#pg-hist .tab').forEach(t => t.classList.remove('active')); el.classList.add('active'); histTab = f; renderHistory(); }

// ===================== DASHBOARD =====================
function renderDashboard() {
  const totalD = DB.customers.reduce((s, c) => s + Math.max(0, totalDebt(c.id)), 0);
  const m = new Date().toISOString().substr(0, 7);
  const paid = DB.payments.filter(p => p.date.startsWith(m)).reduce((s, p) => s + Number(p.amount), 0);
  document.getElementById('s-cust').textContent = DB.customers.filter(c => c.active).length;
  document.getElementById('s-debt').textContent = fmt(totalD);
  document.getElementById('s-paid').textContent = fmt(paid);
  document.getElementById('s-eq').textContent = DB.equipment.length;

  const seen = {};
  const urgent = DB.debts
    .filter(d => daysDiff(d.date) > 30 && totalDebt(d.custId) > 0 && !seen[d.custId] && (seen[d.custId] = true))
    .slice(0, 4).map(d => getCust(d.custId)).filter(Boolean);
  document.getElementById('urgent-list').innerHTML = urgent.length
    ? urgent.map((c, i) => custCardHtml(c, i)).join('')
    : '<div class="empty"><div class="empty-icon">âœ…</div><div class="empty-title">××™×Ÿ ×—×•×‘×•×ª ×“×—×•×¤×™×</div></div>';

  const recent = [...DB.customers].sort((a, b) => b.created > a.created ? 1 : -1).slice(0, 3);
  document.getElementById('recent-list').innerHTML = recent.length
    ? recent.map((c, i) => custCardHtml(c, i)).join('')
    : '<div class="empty"><div class="empty-icon">ğŸ‘¤</div><div class="empty-title">××™×Ÿ ×œ×§×•×—×•×ª ×¢×“×™×™×Ÿ</div><div class="empty-sub">×œ×—×¥ + ×œ×”×•×¡×¤×ª ×œ×§×•×— ×¨××©×•×Ÿ</div></div>';

  const dc = DB.customers.filter(c => totalDebt(c.id) > 0).length;
  const b = document.getElementById('debt-badge');
  if (dc > 0) { b.textContent = dc; b.classList.add('on'); } else b.classList.remove('on');

  let lowInv = 0;
  DB.customers.forEach(c => { (c.inventory || []).forEach(i => { if (Number(i.qty) <= Number(i.minQty || 0) && Number(i.minQty || 0) > 0) lowInv++; }); });
  const ib = document.getElementById('inv-badge');
  if (lowInv > 0) { ib.textContent = lowInv; ib.classList.add('on'); } else ib.classList.remove('on');

  let pendOrd = 0;
  DB.customers.forEach(c => { (c.orders || []).forEach(o => { if (o.status === 'pending') pendOrd++; }); });
  const ob = document.getElementById('ord-badge');
  if (pendOrd > 0) { ob.textContent = pendOrd; ob.classList.add('on'); } else ob.classList.remove('on');

  checkVisitAlerts();
  checkCollectionAlerts();
  checkThursdayReminder();
}

// ===================== CUSTOMER CARD HTML =====================
function custCardHtml(c, i) {
  const debt = totalDebt(c.id);
  const dc = debt > 0 ? 'r' : debt < 0 ? 'g' : 'z';
  const dl = debt > 0 ? '×—×•×‘' : debt < 0 ? '×–×›×•×ª' : '×××•×–×Ÿ';
  const eqC = DB.equipment.filter(e => e.custId === c.id).length;
  const oldest = DB.debts.filter(d => d.custId === c.id).sort((a, b) => a.date > b.date ? 1 : -1)[0];
  const days = oldest ? daysDiff(oldest.date) : 0;
  const dChip = days > 60 ? `<span class="chip cr">âš ï¸ ${days} ×™×•×</span>` : days > 30 ? `<span class="chip cy">${days} ×™×•×</span>` : '';
  const visitAlert = getVisitAlert(c.id);
  return `<div class="ccard" onclick="openCustDetail('${c.id}')">
    <div class="crow">
      <div class="av ${avClass(i)}">${avLetter(c.name)}</div>
      <div><div class="cname">${c.name}</div><div class="cmeta">${c.contact || 'â€”'} Â· ${c.city || 'â€”'}</div></div>
      <div class="ctail"><div class="damount ${dc}">${fmt(Math.abs(debt))}</div><div class="dlabel">${dl}</div></div>
    </div>
    <div class="cfooter">
      <span class="chip cb">×©×•×˜×£ ${c.terms || '?'}</span>
      ${eqC ? `<span class="chip cp">ğŸ“¦ ${eqC}</span>` : ''}
      ${c.visitDay ? `<span class="chip" style="background:var(--s3);color:var(--t2)">${c.visitDay}</span>` : ''}
      ${dChip}
      ${visitAlert ? '<span class="chip cr">ğŸ“… ×‘×™×§×•×¨ × ×“×¨×©</span>' : ''}
    </div>
  </div>`;
}

// ===================== RENDER CUSTOMERS =====================
function renderCustomers() {
  const q = (document.getElementById('cust-search')?.value || '').toLowerCase();
  let list = DB.customers.filter(c => c.active);
  if (q) list = list.filter(c => c.name.toLowerCase().includes(q) || (c.contact || '').toLowerCase().includes(q) || (c.phone || '').includes(q));
  if (curTab.cust === 'debt') list = list.filter(c => totalDebt(c.id) > 0);
  if (curTab.cust === 'ok') list = list.filter(c => totalDebt(c.id) <= 0);
  const dayMap = { sun: '×¨××©×•×Ÿ', mon: '×©× ×™', tue: '×©×œ×™×©×™', wed: '×¨×‘×™×¢×™', thu: '×—××™×©×™' };
  if (dayMap[curTab.cust]) list = list.filter(c => c.visitDay === dayMap[curTab.cust]);
  document.getElementById('cust-list').innerHTML = list.length
    ? list.map((c, i) => custCardHtml(c, i)).join('')
    : '<div class="empty"><div class="empty-icon">ğŸ‘¤</div><div class="empty-title">×œ× × ××¦××• ×œ×§×•×—×•×ª</div><div class="empty-sub">×œ×—×¥ + ×œ×”×•×¡×¤×ª ×œ×§×•×—</div></div>';
}

// ===================== RENDER EQUIPMENT =====================
function renderEquipment() {
  const q = (document.getElementById('eq-search')?.value || '').toLowerCase();
  let list = [...DB.equipment];
  if (q) list = list.filter(e => { const c = getCust(e.custId); return e.type.toLowerCase().includes(q) || (e.serial || '').toLowerCase().includes(q) || (c && c.name.toLowerCase().includes(q)); });
  if (curTab.eq === 'ok') list = list.filter(e => e.status === 'ok');
  if (curTab.eq === 'broken') list = list.filter(e => e.status !== 'ok');
  if (curTab.eq === 'debt') list = list.filter(e => Number(e.eqDebt || 0) > 0);
  document.getElementById('eq-list').innerHTML = list.length
    ? list.map(e => eqCardHtml(e)).join('')
    : '<div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-title">×œ× × ××¦× ×¦×™×•×“</div></div>';
}

function eqCardHtml(e) {
  const c = getCust(e.custId);
  const dotC = e.status === 'ok' ? 'dg' : e.status === 'broken' ? 'dr' : 'dy';
  const stLbl = e.status === 'ok' ? '×ª×§×™×Ÿ' : e.status === 'broken' ? '×ª×§×•×œ' : '×ª×—×–×•×§×”';
  const debt = Number(e.eqDebt || 0);
  const dp = e.placed ? daysDiff(e.placed) : 0;
  const emoji = { '××§×¨×¨': 'ğŸ§Š', '××§×¤×™× ×¢×•××“': 'â„ï¸', '××§×¤×™× ×©×•×›×‘': 'ğŸ§Š', '××“×£': 'ğŸª' }[e.type] || 'ğŸ“¦';
  return `<div class="ecard" onclick="openEqDetail('${e.id}')">
    <div class="crow">
      <div class="eicon">${emoji}</div>
      <div style="flex:1">
        <div style="font-size:14px;font-weight:800">${e.type} ${e.serial ? 'Â· ' + e.serial : ''}</div>
        <div style="font-size:11px;color:var(--t2)">${c ? c.name : 'â€”'} Â· ${dp} ×™××™× ×‘×©×˜×—</div>
      </div>
      <div class="ctail" style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <div style="display:flex;align-items:center;gap:5px"><div class="edot ${dotC}"></div><span style="font-size:11px;color:var(--t2)">${stLbl}</span></div>
        ${debt > 0 ? `<div style="font-size:13px;font-weight:900;color:var(--rd)">${fmt(debt)}</div>` : ''}
      </div>
    </div>
  </div>`;
}

// ===================== RENDER DEBTS =====================
function renderDebts() {
  const q = (document.getElementById('debt-search')?.value || '').toLowerCase();
  let list = DB.customers.filter(c => c.active).map(c => {
    const debt = totalDebt(c.id);
    const oldest = DB.debts.filter(d => d.custId === c.id).sort((a, b) => a.date > b.date ? 1 : -1)[0];
    const days = oldest ? daysDiff(oldest.date) : 0;
    return { c, debt, days };
  }).filter(x => x.debt > 0);
  if (q) list = list.filter(x => x.c.name.toLowerCase().includes(q) || (x.c.contact || '').toLowerCase().includes(q));
  if (curTab.debt === 'new') list = list.filter(x => x.days <= 30);
  if (curTab.debt === 'old') list = list.filter(x => x.days > 30 && x.days <= 60);
  if (curTab.debt === 'urgent') list = list.filter(x => x.days > 60);
  list.sort((a, b) => b.debt - a.debt);
  const td = list.reduce((s, x) => s + x.debt, 0);
  document.getElementById('d-total').textContent = fmt(td);
  document.getElementById('d-count').textContent = list.length;
  document.getElementById('debt-list').innerHTML = list.length
    ? list.map(({ c, debt, days }) => {
      const ac = days <= 30 ? 'age-ok' : days <= 60 ? 'age-warn' : 'age-bad';
      const al = days > 60 ? `âš ï¸ ${days} ×™×•×` : `${days} ×™×•×`;
      const idx = DB.customers.indexOf(c);
      return `<div class="dcard" onclick="openCustDetail('${c.id}')">
        <div class="av ${avClass(idx)}" style="width:40px;height:40px;border-radius:11px;font-size:15px">${avLetter(c.name)}</div>
        <div style="flex:1"><div style="font-size:14px;font-weight:800">${c.name}</div><div style="font-size:11px;color:var(--t2)">${c.phone} Â· ${c.city || 'â€”'}</div></div>
        <div style="text-align:left"><div class="bigamt" style="color:var(--rd)">${fmt(debt)}</div><div class="agebadge ${ac}">${al}</div></div>
      </div>`;
    }).join('')
    : '<div class="empty"><div class="empty-icon">ğŸ‰</div><div class="empty-title">××™×Ÿ ×—×•×‘×•×ª!</div></div>';
}

// ===================== INVENTORY (per customer) =====================
function renderInventory() {
  const q = (document.getElementById('inv-search')?.value || '').toLowerCase();
  // Build list of customers with their inventory
  let custs = DB.customers.filter(c => c.active && (c.inventory || []).length > 0);
  if (q) custs = custs.filter(c => c.name.toLowerCase().includes(q) || (c.inventory || []).some(i => i.name.toLowerCase().includes(q)));

  // Stats
  let totalProds = 0, lowCount = 0;
  DB.customers.forEach(c => {
    (c.inventory || []).forEach(i => {
      totalProds++;
      if (Number(i.qty) <= Number(i.minQty || 0)) lowCount++;
    });
  });
  document.getElementById('inv-low').textContent = lowCount;
  document.getElementById('inv-total-prods').textContent = totalProds;

  // Alerts for low stock
  const alerts = [];
  DB.customers.forEach(c => {
    (c.inventory || []).forEach(i => {
      if (Number(i.qty) <= Number(i.minQty || 0) && Number(i.minQty || 0) > 0) alerts.push({ cust: c, item: i });
    });
  });
  const alertsEl = document.getElementById('inv-alerts-section');
  if (alertsEl && alerts.length) {
    alertsEl.innerHTML = `<div style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:14px;padding:12px;margin:0 16px 12px">
      <div style="font-weight:800;color:var(--rd);font-size:13px;margin-bottom:8px">âš ï¸ ××œ××™ × ××•×š (${alerts.length})</div>
      ${alerts.map(a => `<div style="display:flex;justify-content:space-between;padding:5px 0;border-top:1px solid rgba(239,68,68,.2);cursor:pointer" onclick="openCustDetail('${a.cust.id}')">
        <span style="font-size:12px;font-weight:700">${a.cust.name} Â· ${a.item.name}</span>
        <span style="font-size:12px;font-weight:900;color:var(--rd)">${a.item.qty} ×™×—'</span>
      </div>`).join('')}
    </div>`;
  } else if (alertsEl) alertsEl.innerHTML = '';

  document.getElementById('inv-list').innerHTML = custs.length
    ? custs.map(c => {
        const inv = (c.inventory || []).filter(i => !q || i.name.toLowerCase().includes(q) || c.name.toLowerCase().includes(q));
        const pendOrd = (c.orders || []).filter(o => o.status === 'pending').length;
        return `<div style="background:var(--sf);border:1px solid var(--br);border-radius:16px;margin:0 16px 10px;overflow:hidden">
          <div style="display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;border-bottom:1px solid var(--br)" onclick="openCustDetail('${c.id}')">
            <div class="av ${avClass(DB.customers.indexOf(c))}" style="width:36px;height:36px;border-radius:10px;font-size:14px">${avLetter(c.name)}</div>
            <div style="flex:1"><div style="font-size:14px;font-weight:800">${c.name}</div><div style="font-size:11px;color:var(--t2)">${inv.length} ××•×¦×¨×™×${pendOrd ? ' Â· ' + pendOrd + ' ×”×–×× ×•×ª ×××ª×™× ×•×ª' : ''}</div></div>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
          </div>
          ${inv.map(item => {
            const qty = Number(item.qty);
            const minQty = Number(item.minQty || 0);
            const isLow = minQty > 0 && qty <= minQty;
            return `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--br)">
              <div style="font-size:20px">${catIcons[item.category] || 'ğŸ“¦'}</div>
              <div style="flex:1">
                <div style="font-size:13px;font-weight:700">${item.name}</div>
                ${item.expiry ? `<div style="font-size:10px;color:var(--t2)">×ª×¤×•×’×”: ${fmtDate(item.expiry)}</div>` : ''}
              </div>
              <div style="text-align:left">
                <div style="font-size:17px;font-weight:900;color:${isLow ? 'var(--rd)' : 'var(--gr)'}">${qty}</div>
                ${item.salePrice ? `<div style="font-size:10px;color:var(--t2)">${fmt(item.salePrice)}</div>` : ''}
              </div>
              ${isLow ? '<span class="chip cr" style="font-size:9px">× ××•×š</span>' : ''}
            </div>`;
          }).join('')}
        </div>`;
      }).join('')
    : '<div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-title">××™×Ÿ ××œ××™ ××•×’×“×¨</div><div class="empty-sub">×¤×ª×— ×œ×§×•×— ×•×”×•×¡×£ ××•×¦×¨×™× ×××¡×š ×”×œ×§×•×—</div></div>';
}

const catIcons = { icecream: 'ğŸ¦', vegetables: 'ğŸ¥¦', dough: 'ğŸ¥', fruit: 'ğŸ“', other: 'ğŸ“¦' };
const catNames = { icecream: '×’×œ×™×“×•×ª', vegetables: '×™×¨×§×•×ª', dough: '×‘×¦×§', fruit: '×¤×™×¨×•×ª', other: '××—×¨' };

// Per-customer inventory management
function openCustInvItem(cid, iid) {
  const c = getCust(cid); if (!c) return;
  const item = (c.inventory || []).find(x => x.id === iid); if (!item) return;
  const qty = Number(item.qty);
  const minQty = Number(item.minQty || 0);
  const isLow = minQty > 0 && qty <= minQty;
  const modal = document.getElementById('modal-cust-inv-item');
  document.getElementById('cii-title').textContent = item.name;
  document.getElementById('cii-body').innerHTML = `
    <div style="text-align:center;padding:16px 0 10px">
      <div style="font-size:40px">${catIcons[item.category] || 'ğŸ“¦'}</div>
      <div style="font-size:36px;font-weight:900;color:${isLow ? 'var(--rd)' : 'var(--gr)'};margin-top:6px">${qty}</div>
      <div style="font-size:12px;color:var(--t2)">×™×—×™×“×•×ª ×‘×¨×©×•×ª×•</div>
    </div>
    ${item.salePrice ? `<div class="dkv"><span class="dk">××—×™×¨</span><span class="dv">${fmt(item.salePrice)}</span></div>` : ''}
    ${item.minQty ? `<div class="dkv"><span class="dk">××™× ×™××•×</span><span class="dv">${item.minQty} ×™×—'</span></div>` : ''}
    ${item.expiry ? `<div class="dkv"><span class="dk">×ª×¤×•×’×”</span><span class="dv">${fmtDate(item.expiry)}</span></div>` : ''}
    ${item.notes ? `<div class="dkv"><span class="dk">×”×¢×¨×•×ª</span><span class="dv">${item.notes}</span></div>` : ''}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px">
      <button class="btno" style="margin:0" onclick="adjustCustInv('${cid}','${iid}',1)">+ ×”×•×¡×£</button>
      <button class="btno" style="margin:0" onclick="adjustCustInv('${cid}','${iid}',-1)">âˆ’ ×”×•×¦×</button>
    </div>
    <button class="btno" style="margin-top:8px;width:100%" onclick="editCustInvItem('${cid}','${iid}')">âœï¸ ×¢×¨×™×›×”</button>
    <button class="btnd" onclick="deleteCustInvItem('${cid}','${iid}')">ğŸ—‘ï¸ ××—×§ ××•×¦×¨</button>`;
  openModal('modal-cust-inv-item');
}

function adjustCustInv(cid, iid, dir) {
  const c = getCust(cid); if (!c) return;
  const item = (c.inventory || []).find(x => x.id === iid); if (!item) return;
  const val = prompt(dir > 0 ? '×›××” ×™×—×™×“×•×ª ×œ×”×•×¡×™×£?' : '×›××” ×™×—×™×“×•×ª ×œ×”×•×¦×™×?', '1');
  if (val === null || isNaN(val)) return;
  item.qty = Math.max(0, Number(item.qty) + (dir > 0 ? Number(val) : -Number(val)));
  save(); renderAll(); closeModal('modal-cust-inv-item');
  showToast(dir > 0 ? `+${val} ×™×—×™×“×•×ª × ×•×¡×¤×• âœ…` : `-${val} ×™×—×™×“×•×ª ×”×•×¦××•`);
  if (document.getElementById('modal-cust-detail').classList.contains('open')) { renderCustDetailInv(cid); }
}

function editCustInvItem(cid, iid) {
  const c = getCust(cid); if (!c) return;
  const item = (c.inventory || []).find(x => x.id === iid); if (!item) return;
  document.getElementById('cif-name').value = item.name;
  document.getElementById('cif-cat').value = item.category || 'icecream';
  document.getElementById('cif-qty').value = item.qty;
  document.getElementById('cif-min').value = item.minQty || '';
  document.getElementById('cif-price').value = item.salePrice || '';
  document.getElementById('cif-exp').value = item.expiry || '';
  document.getElementById('cif-notes').value = item.notes || '';
  document.getElementById('cif-save-btn').onclick = () => saveCustInvEdit(cid, iid);
  closeModal('modal-cust-inv-item');
  openModal('modal-cust-inv-form');
}

function deleteCustInvItem(cid, iid) {
  if (!confirm('×œ××—×•×§ ××•×¦×¨ ×–×” ××”×œ×§×•×—?')) return;
  const c = getCust(cid); if (!c) return;
  c.inventory = (c.inventory || []).filter(x => x.id !== iid);
  save(); renderAll(); closeModal('modal-cust-inv-item');
  showToast('××•×¦×¨ × ××—×§');
  if (document.getElementById('modal-cust-detail').classList.contains('open')) { renderCustDetailInv(cid); }
}

function openAddCustInv(cid) {
  document.getElementById('cif-name').value = '';
  document.getElementById('cif-cat').value = 'icecream';
  document.getElementById('cif-qty').value = '0';
  document.getElementById('cif-min').value = '';
  document.getElementById('cif-price').value = '';
  document.getElementById('cif-exp').value = '';
  document.getElementById('cif-notes').value = '';
  document.getElementById('cif-save-btn').onclick = () => saveNewCustInv(cid);
  openModal('modal-cust-inv-form');
}

function saveNewCustInv(cid) {
  const c = getCust(cid); if (!c) return;
  const name = document.getElementById('cif-name').value.trim();
  if (!name) { alert('×©× ××•×¦×¨ ×—×•×‘×”'); return; }
  if (!c.inventory) c.inventory = [];
  c.inventory.push({
    id: uid(), name,
    category: document.getElementById('cif-cat').value,
    qty: Number(document.getElementById('cif-qty').value) || 0,
    minQty: Number(document.getElementById('cif-min').value) || 0,
    salePrice: Number(document.getElementById('cif-price').value) || 0,
    expiry: document.getElementById('cif-exp').value,
    notes: document.getElementById('cif-notes').value.trim(),
    created: today()
  });
  save(); renderAll(); closeModal('modal-cust-inv-form');
  showToast('××•×¦×¨ × ×•×¡×£ âœ…');
  if (document.getElementById('modal-cust-detail').classList.contains('open')) { renderCustDetailInv(cid); }
}

function saveCustInvEdit(cid, iid) {
  const c = getCust(cid); if (!c) return;
  const item = (c.inventory || []).find(x => x.id === iid); if (!item) return;
  const name = document.getElementById('cif-name').value.trim();
  if (!name) { alert('×©× ××•×¦×¨ ×—×•×‘×”'); return; }
  item.name = name;
  item.category = document.getElementById('cif-cat').value;
  item.qty = Number(document.getElementById('cif-qty').value) || 0;
  item.minQty = Number(document.getElementById('cif-min').value) || 0;
  item.salePrice = Number(document.getElementById('cif-price').value) || 0;
  item.expiry = document.getElementById('cif-exp').value;
  item.notes = document.getElementById('cif-notes').value.trim();
  save(); renderAll(); closeModal('modal-cust-inv-form');
  showToast('××•×¦×¨ ×¢×•×“×›×Ÿ âœ…');
  if (document.getElementById('modal-cust-detail').classList.contains('open')) { renderCustDetailInv(cid); }
}

// ===================== ORDERS (per customer) =====================
function renderOrders() {
  let list = [];
  DB.customers.forEach(c => {
    (c.orders || []).forEach(o => list.push({ ...o, custName: c.name, custId: c.id }));
  });
  list.sort((a, b) => b.created > a.created ? 1 : -1);
  if (curTab.ord === 'pending') list = list.filter(o => o.status === 'pending');
  if (curTab.ord === 'delivered') list = list.filter(o => o.status === 'delivered');

  const pending = list.filter(o => o.status === 'pending').length;
  const todayOrds = list.filter(o => o.deliverDate === today() || o.created === today()).length;
  document.getElementById('ord-pending').textContent = pending;
  document.getElementById('ord-today').textContent = todayOrds;

  document.getElementById('ord-list').innerHTML = list.length
    ? list.map(o => ordCardHtml(o)).join('')
    : '<div class="empty"><div class="empty-icon">ğŸ›’</div><div class="empty-title">××™×Ÿ ×”×–×× ×•×ª</div><div class="empty-sub">×¤×ª×— ×œ×§×•×— ×•×¦×•×¨ ×”×–×× ×”</div></div>';
}

function ordCardHtml(o) {
  const c = getCust(o.custId);
  const statusLabel = { pending: '×××ª×™×Ÿ', delivered: '× ××¡×¨', cancelled: '×‘×•×˜×œ' };
  const statusColor = { pending: 'cy', delivered: 'cg', cancelled: 'cr' };
  const total = (o.items || []).reduce((s, i) => s + (Number(i.qty) * Number(i.price || 0)), 0);
  return `<div class="ord-card ${o.status}" onclick="openOrdDetail('${o.custId}','${o.id}')">
    <div class="crow">
      <div style="flex:1">
        <div style="font-size:14px;font-weight:800">${c ? c.name : 'â€”'}</div>
        <div style="font-size:11px;color:var(--t2)">×”×–×× ×” ${fmtDate(o.created)} Â· ××¡×™×¨×” ${o.deliverDate ? fmtDate(o.deliverDate) : 'â€”'}</div>
      </div>
      <div style="text-align:left">
        ${total > 0 ? `<div style="font-size:15px;font-weight:900;color:var(--ac)">${fmt(total)}</div>` : ''}
        <span class="chip ${statusColor[o.status] || 'cb'}">${statusLabel[o.status] || o.status}</span>
      </div>
    </div>
    ${(o.items || []).length > 0 ? `<div style="margin-top:8px;font-size:11px;color:var(--t2)">${o.items.map(i => `${i.name} Ã— ${i.qty}`).join(' Â· ')}</div>` : ''}
  </div>`;
}

let activeOrderCid = null, activeOrderItems = [];

function openAddCustOrder(cid) {
  activeOrderCid = cid;
  activeOrderItems = [];
  const c = getCust(cid); if (!c) return;
  const inv = c.inventory || [];
  document.getElementById('cord-title').textContent = 'ğŸ“‹ ×”×–×× ×” â€” ' + c.name;
  document.getElementById('cord-date').value = today();
  document.getElementById('cord-deliver-date').value = '';
  document.getElementById('cord-notes').value = '';
  document.getElementById('cord-items-list').innerHTML = '';

  document.getElementById('cord-total-preview').style.display = 'none';
  document.getElementById('cord-inv-notice').style.display = inv.length ? 'none' : 'block';
  openModal('modal-cust-order');
  if (inv.length > 0) addCustOrderItem(); // auto-add first row
}

function addCustOrderItem() {
  const cid = activeOrderCid;
  const c = getCust(cid); if (!c) return;
  const inv = c.inventory || [];
  const itemId = uid();
  activeOrderItems.push({ itemId, productId: null });
  const wrap = document.getElementById('cord-items-list');
  const div = document.createElement('div');
  div.id = 'coi-' + itemId;
  div.style.cssText = 'background:var(--s2);border:1px solid var(--br);border-radius:12px;padding:10px;margin-bottom:8px;position:relative';
  div.innerHTML = `
    <div style="display:flex;gap:6px;align-items:center;margin-bottom:8px">
      <div style="flex:1;position:relative">
        <input class="fi" id="coi-search-${itemId}" placeholder="×—×™×¤×•×© ××•×¦×¨..." autocomplete="off"
          oninput="showProdDropdown('${itemId}')"
          onfocus="showProdDropdown('${itemId}')"
          style="font-size:13px;padding-left:8px"
          dir="rtl">
        <div id="coi-drop-${itemId}" style="display:none;position:absolute;right:0;left:0;top:100%;margin-top:2px;background:var(--sf);border:1px solid var(--br2);border-radius:10px;z-index:9999;max-height:180px;overflow-y:auto;box-shadow:0 8px 24px rgba(0,0,0,.5)"></div>
      </div>
      <input class="fi qty-input" id="coi-qty-${itemId}" type="number" value="1" min="1" style="width:64px;flex-shrink:0" oninput="calcCustOrderTotal()">
      <button onclick="removeCustOrderItem('${itemId}')" style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:var(--rd);border-radius:10px;padding:8px 10px;cursor:pointer;font-size:14px;flex-shrink:0">âœ•</button>
    </div>
    <div id="coi-selected-${itemId}" style="display:none;font-size:12px;color:var(--t2);margin-top:2px"></div>
    <input type="hidden" id="coi-prod-${itemId}" value="">`;
  wrap.appendChild(div);
  calcCustOrderTotal();
  document.getElementById('coi-search-' + itemId).focus();
}

function showProdDropdown(itemId) {
  const c = getCust(activeOrderCid); if (!c) return;
  const inv = c.inventory || [];
  const q = (document.getElementById('coi-search-' + itemId)?.value || '').trim().toLowerCase();
  const drop = document.getElementById('coi-drop-' + itemId); if (!drop) return;
  const filtered = q ? inv.filter(i => i.name.toLowerCase().includes(q)) : inv;
  if (!filtered.length) { drop.style.display = 'none'; return; }
  drop.innerHTML = filtered.map(i => {
    const isLow = Number(i.minQty || 0) > 0 && Number(i.qty) <= Number(i.minQty);
    return `<div onclick="selectOrderProd('${itemId}','${i.id}')"
      style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--br);transition:background .1s"
      onmouseenter="this.style.background='var(--s3)'" onmouseleave="this.style.background=''">
      <div>
        <div style="font-size:13px;font-weight:700">${i.name}</div>
        ${i.salePrice ? `<div style="font-size:11px;color:var(--t2)">${fmt(i.salePrice)} ×œ×³×™×—</div>` : ''}
      </div>
      <span style="font-size:13px;font-weight:900;color:${isLow ? 'var(--rd)' : 'var(--gr)'}">${i.qty} ×™×—×³</span>
    </div>`;
  }).join('');
  drop.style.display = 'block';
  // close on outside click
  setTimeout(() => {
    const close = (e) => {
      const inp = document.getElementById('coi-search-' + itemId);
      if (inp && !inp.contains(e.target) && !drop.contains(e.target)) {
        drop.style.display = 'none';
        document.removeEventListener('click', close);
      }
    };
    document.addEventListener('click', close);
  }, 0);
}

function selectOrderProd(itemId, productId) {
  const c = getCust(activeOrderCid); if (!c) return;
  const item = (c.inventory || []).find(i => i.id === productId); if (!item) return;
  document.getElementById('coi-prod-' + itemId).value = productId;
  document.getElementById('coi-search-' + itemId).value = item.name;
  const drop = document.getElementById('coi-drop-' + itemId); if (drop) drop.style.display = 'none';
  const sel = document.getElementById('coi-selected-' + itemId);
  if (sel) {
    sel.style.display = 'block';
    sel.innerHTML = `<span style="color:var(--gr)">âœ“</span> ${item.name}${item.salePrice ? ' Â· ' + fmt(item.salePrice) + ' ×œ×³×™×—' : ''}`;
  }
  const itemObj = activeOrderItems.find(x => x.itemId === itemId);
  if (itemObj) itemObj.productId = productId;
  calcCustOrderTotal();
}

function removeCustOrderItem(itemId) {
  activeOrderItems = activeOrderItems.filter(x => x.itemId !== itemId);
  const el = document.getElementById('coi-' + itemId); if (el) el.remove();
  calcCustOrderTotal();
}

function calcCustOrderTotal() {
  const c = getCust(activeOrderCid); if (!c) return;
  const inv = c.inventory || [];
  let total = 0;
  activeOrderItems.forEach(({ itemId }) => {
    const prodEl = document.getElementById('coi-prod-' + itemId);
    const qtyEl = document.getElementById('coi-qty-' + itemId);
    if (!prodEl || !qtyEl) return;
    const productId = prodEl.value;
    const invItem = inv.find(i => i.id === productId);
    const price = invItem ? Number(invItem.salePrice || 0) : 0;
    const qty = Number(qtyEl.value) || 0;
    total += price * qty;
  });
  const prev = document.getElementById('cord-total-preview');
  const val = document.getElementById('cord-total-val');
  if (activeOrderItems.length > 0) { prev.style.display = 'block'; val.textContent = fmt(total); }
  else prev.style.display = 'none';
}

function saveCustOrder() {
  const cid = activeOrderCid;
  const c = getCust(cid); if (!c) return;
  if (activeOrderItems.length === 0) { alert('×™×© ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×¤×¨×™×˜ ××—×“'); return; }

  const inv = c.inventory || [];
  const items = [];
  let valid = true;

  activeOrderItems.forEach(({ itemId }) => {
    const sel = document.getElementById('coi-prod-' + itemId);
    const qtyEl = document.getElementById('coi-qty-' + itemId);
    if (!sel || !sel.value) { alert('× × ×œ×‘×—×•×¨ ××•×¦×¨ ×œ×›×œ ×©×•×¨×” (×”×§×œ×“ ×‘×©×“×” ×”×—×™×¤×•×© ×•×‘×—×¨)'); valid = false; return; }
    const invItem = inv.find(x => x.id === sel.value);
    if (!invItem) return;
    items.push({ productId: sel.value, name: invItem.name, qty: Number(qtyEl.value) || 1, price: invItem.salePrice || 0 });
  });

  if (!valid || items.length === 0) return;

  if (!c.orders) c.orders = [];
  c.orders.push({
    id: uid(), custId: cid,
    created: today(),
    deliverDate: document.getElementById('cord-deliver-date').value,
    notes: document.getElementById('cord-notes').value.trim(),
    status: 'pending', items
  });

  save();
  renderAll();
  closeModal('modal-cust-order');
  showToast('×”×–×× ×” × ×•×¦×¨×” âœ… â€” ××©×¨ ××¡×™×¨×” ×œ×¢×“×›×•×Ÿ ××œ××™ ×•×—×•×‘');
  if (document.getElementById('modal-cust-detail').classList.contains('open')) { renderCustDetailOrders(cid); setCustDetailTab('orders'); }
}

function openOrdDetail(cid, oid) {
  const c = getCust(cid); if (!c) return;
  const o = (c.orders || []).find(x => x.id === oid); if (!o) return;
  const total = (o.items || []).reduce((s, i) => s + (Number(i.qty) * Number(i.price || 0)), 0);
  document.getElementById('ordd-title').textContent = 'ğŸ“‹ ×”×–×× ×” â€” ' + c.name;
  document.getElementById('ordd-body').innerHTML = `
    <div class="dkv"><span class="dk">×œ×§×•×—</span><span class="dv">${c.name}</span></div>
    <div class="dkv"><span class="dk">×ª××¨×™×š ×”×–×× ×”</span><span class="dv">${fmtDate(o.created)}</span></div>
    <div class="dkv"><span class="dk">×ª××¨×™×š ××¡×™×¨×”</span><span class="dv">${o.deliverDate ? fmtDate(o.deliverDate) : 'â€”'}</span></div>
    <div class="dkv"><span class="dk">×¡×˜×˜×•×¡</span><span class="dv"><span class="chip ${o.status === 'pending' ? 'cy' : o.status === 'delivered' ? 'cg' : 'cr'}">${o.status === 'pending' ? '×××ª×™×Ÿ' : o.status === 'delivered' ? '× ××¡×¨' : '×‘×•×˜×œ'}</span></span></div>
    <div class="sec-div" style="border-top:none">×¤×¨×™×˜×™×</div>
    ${(o.items || []).map(item => `
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--br)">
        <span style="font-size:13px;font-weight:600">${item.name}</span>
        <span style="font-size:13px;font-weight:800;color:var(--ac)">Ã—${item.qty}${item.price ? ' = ' + fmt(item.qty * item.price) : ''}</span>
      </div>`).join('')}
    ${total > 0 ? `<div style="display:flex;justify-content:space-between;padding:12px 0;font-weight:900"><span>×¡×”"×›</span><span style="color:var(--ac)">${fmt(total)}</span></div>` : ''}
    ${o.notes ? `<div style="font-size:12px;color:var(--t2);margin-top:8px">×”×¢×¨×•×ª: ${o.notes}</div>` : ''}
    ${o.status === 'pending' ? `
      <div style="background:var(--s2);border-radius:12px;padding:14px;margin-top:8px">
        <div style="font-size:12px;font-weight:700;color:var(--t2);margin-bottom:8px">ğŸ“‹ ×¤×¨×˜×™ ×—×•×‘ ×œ××¡×™×¨×”</div>
        <div class="fg"><label class="fl">××¡×¤×¨ ××¡××š *</label><input class="fi" id="ord-docnum-input" placeholder="×—×©×‘×•× ×™×ª ××¡×³..." dir="ltr" value=""></div>
        <div class="fg" style="margin-top:6px"><label class="fl">×ª××¨×™×š ×—×•×‘</label><input class="fi" id="ord-debt-date" type="date" value="${today()}"></div>
      </div>
      <button class="btnp" style="margin-top:12px" onclick="markCustOrderDelivered('${cid}','${oid}')">âœ… ××©×¨ ××¡×™×¨×” + ×¨×©×•× ×—×•×‘</button>
      <button class="btnd" onclick="cancelCustOrder('${cid}','${oid}')">ğŸ—‘ï¸ ×‘×˜×œ ×”×–×× ×”</button>
    ` : ''}`;
  openModal('modal-ord-detail');
}

function markCustOrderDelivered(cid, oid) {
  const docnum = (document.getElementById('ord-docnum-input')?.value || '').trim();
  if (!docnum) { alert('× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ××¡××š'); return; }
  const debtDate = document.getElementById('ord-debt-date')?.value || today();

  const c = getCust(cid); if (!c) return;
  const o = (c.orders || []).find(x => x.id === oid); if (!o) return;

  // Check for duplicate docnum
  if (DB.debts.find(d => d.docnum === docnum)) {
    if (!confirm('××¡×¤×¨ ××¡××š ' + docnum + ' ×›×‘×¨ ×§×™×™×. ×œ×”××©×™×š?')) return;
  }

  o.status = 'delivered';
  o.deliveredDate = today();

  // Update customer inventory quantities (add what was delivered)
  (o.items || []).forEach(item => {
    if (!c.inventory) c.inventory = [];
    const invItem = c.inventory.find(x => x.id === item.productId);
    if (invItem) {
      invItem.qty = Number(invItem.qty) + Number(item.qty);
    }
  });

  // Create debt automatically
  const total = (o.items || []).reduce((s, i) => s + (Number(i.qty) * Number(i.price || 0)), 0);
  if (total > 0) {
    DB.debts.push({
      id: uid(),
      custId: cid,
      amount: total,
      docnum: docnum,
      date: debtDate,
      desc: '×”×–×× ×”: ' + (o.items || []).map(i => i.name + ' Ã—' + i.qty).join(', ')
    });
    showToast('âœ… × ××¡×¨ Â· ×—×•×‘ ' + fmt(total) + ' × ×¨×©×');
  } else {
    showToast('âœ… ×”×–×× ×” × ××¡×¨×”');
  }

  save(); renderAll(); closeModal('modal-ord-detail');
  if (document.getElementById('modal-cust-detail').classList.contains('open')) { renderCustDetailOrders(cid); renderCustDetailDebts(cid); setCustDetailTab('debts'); }
}

function cancelCustOrder(cid, oid) {
  if (!confirm('×œ×‘×˜×œ ×”×–×× ×” ×–×•?')) return;
  const c = getCust(cid); if (!c) return;
  const o = (c.orders || []).find(x => x.id === oid); if (!o) return;
  o.status = 'cancelled';
  save(); renderAll(); closeModal('modal-ord-detail');
  showToast('×”×–×× ×” ×‘×•×˜×œ×”');
  if (document.getElementById('modal-cust-detail').classList.contains('open')) { renderCustDetailOrders(cid); }
}

function setCustDetailTab(tab) {
  const tabs = ['info','inv','orders','debts'];
  tabs.forEach(t => {
    const tabEl = document.getElementById('cd-tab-' + t);
    const btnEl = document.getElementById('cdt-' + t);
    if (tabEl) tabEl.style.display = t === tab ? 'block' : 'none';
    if (btnEl) btnEl.classList.toggle('active', t === tab);
  });
  // Clear search on tab switch
  const searchMap = { inv: 'inv-search-cust', orders: 'ord-search-cust', debts: 'debt-search-cust' };
  if (searchMap[tab]) { const el = document.getElementById(searchMap[tab]); if (el) el.value = ''; }
  if (tab === 'inv') renderCustDetailInv(activeCid);
  if (tab === 'orders') renderCustDetailOrders(activeCid);
  if (tab === 'debts') renderCustDetailDebts(activeCid);
}

function renderCustDetailInv(cid) {
  const c = getCust(cid); if (!c) return;
  const q = (document.getElementById('inv-search-cust')?.value || '').trim().toLowerCase();
  let inv = c.inventory || [];
  if (q) inv = inv.filter(i => i.name.toLowerCase().includes(q) || (i.notes || '').toLowerCase().includes(q) || (catNames[i.category] || '').toLowerCase().includes(q));
  document.getElementById('cd-inventory').innerHTML = inv.length
    ? inv.map(item => {
        const qty = Number(item.qty);
        const minQty = Number(item.minQty || 0);
        const isLow = minQty > 0 && qty <= minQty;
        return `<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--br);cursor:pointer" onclick="openCustInvItem('${cid}','${item.id}')">
          <div style="font-size:22px">${catIcons[item.category] || 'ğŸ“¦'}</div>
          <div style="flex:1">
            <div style="font-size:13px;font-weight:700">${item.name}</div>
            ${item.expiry ? `<div style="font-size:10px;color:var(--t2)">×ª×¤×•×’×”: ${fmtDate(item.expiry)}</div>` : ''}
          </div>
          <div style="text-align:left">
            <div style="font-size:18px;font-weight:900;color:${isLow ? 'var(--rd)' : 'var(--gr)'}">${qty}</div>
            ${item.salePrice ? `<div style="font-size:10px;color:var(--t2)">${fmt(item.salePrice)}</div>` : ''}
          </div>
          ${isLow ? '<span class="chip cr" style="font-size:9px">× ××•×š</span>' : ''}
        </div>`;
      }).join('')
    : '<div style="color:var(--t3);font-size:13px;padding:12px 0;text-align:center">××™×Ÿ ××•×¦×¨×™× â€” ×œ×—×¥ "+ ×”×•×¡×£ ××•×¦×¨"</div>';
}

function renderCustDetailOrders(cid) {
  const c = getCust(cid); if (!c) return;
  const q = (document.getElementById('ord-search-cust')?.value || '').trim().toLowerCase();
  let orders = (c.orders || []).sort((a, b) => b.created > a.created ? 1 : -1);
  if (q) orders = orders.filter(o =>
    (o.items || []).some(i => i.name.toLowerCase().includes(q)) ||
    (o.notes || '').toLowerCase().includes(q) ||
    fmtDate(o.created).includes(q) ||
    ({ pending:'×××ª×™×Ÿ', delivered:'× ××¡×¨', cancelled:'×‘×•×˜×œ' }[o.status] || '').includes(q)
  );
  document.getElementById('cd-orders').innerHTML = orders.length
    ? orders.map(o => {
        const total = (o.items || []).reduce((s, i) => s + (Number(i.qty) * Number(i.price || 0)), 0);
        const statusLabel = { pending: '×××ª×™×Ÿ', delivered: '× ××¡×¨', cancelled: '×‘×•×˜×œ' };
        const statusColor = { pending: 'cy', delivered: 'cg', cancelled: 'cr' };
        return `<div style="background:var(--s2);border:1px solid var(--br);border-radius:12px;padding:12px;margin-bottom:8px;cursor:pointer" onclick="openOrdDetail('${cid}','${o.id}')">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:13px;font-weight:700">${fmtDate(o.created)}</div>
              <div style="font-size:11px;color:var(--t2)">${(o.items || []).map(i => i.name + 'Ã—' + i.qty).join(', ')}</div>
            </div>
            <div style="text-align:left">
              ${total > 0 ? `<div style="font-size:14px;font-weight:900;color:var(--ac)">${fmt(total)}</div>` : ''}
              <span class="chip ${statusColor[o.status] || 'cb'}" style="font-size:10px">${statusLabel[o.status] || o.status}</span>
            </div>
          </div>
        </div>`;
      }).join('')
    : '<div style="color:var(--t3);font-size:13px;padding:12px 0;text-align:center">××™×Ÿ ×”×–×× ×•×ª â€” ×œ×—×¥ "+ ×”×–×× ×” ×—×“×©×”"</div>';
}

function renderCustDetailDebts(cid) {
  const q = (document.getElementById('debt-search-cust')?.value || '').trim().toLowerCase();
  let custDebts = DB.debts.filter(d => d.custId === cid && !d.closed && !d.isCredit).sort((a, b) => b.date.localeCompare(a.date));
  if (q) custDebts = custDebts.filter(d =>
    (d.docnum || '').toLowerCase().includes(q) ||
    (d.desc || '').toLowerCase().includes(q) ||
    fmtDate(d.date).includes(q) ||
    String(d.amount).includes(q)
  );
  let debtHtml = '';
  if (custDebts.length) {
    debtHtml = '<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><button onclick="toggleSelectAllDebts(\'' + cid + '\')" style="font-size:12px;font-weight:700;color:var(--ac);background:none;border:none;cursor:pointer" id="btn-sel-all-' + cid + '">â˜ ×‘×—×¨ ×”×›×œ</button><button onclick="deleteSelectedDebts(\'' + cid + '\')" style="font-size:12px;font-weight:700;color:var(--rd);background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:4px 10px;cursor:pointer;display:none" id="btn-del-sel-' + cid + '">ğŸ—‘ï¸ ××—×§ × ×‘×—×¨×™×</button></div>';
    custDebts.forEach(d => {
      const age = daysDiff(d.date);
      const ageColor = age > 60 ? 'var(--rd)' : age > 30 ? 'var(--yw)' : 'var(--t2)';
      const remaining = Number(d.amount) - (d.paidAmount || 0);
      debtHtml += '<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--br)"><input type="checkbox" id="chk-' + d.id + '" onchange="onDebtCheck(\'' + cid + '\')" style="width:18px;height:18px;accent-color:var(--ac);flex-shrink:0;cursor:pointer"><div style="flex:1"><div style="display:flex;align-items:center;gap:6px">' + (d.docnum ? '<span style="background:var(--s3);border:1px solid var(--br);border-radius:6px;padding:2px 7px;font-size:11px;font-weight:800">#' + d.docnum + '</span>' : '') + '<span style="font-size:13px;font-weight:800;color:var(--rd)">' + fmt(remaining) + '</span>' + (d.paidAmount ? '<span style="font-size:10px;color:var(--yw)">×©×•×œ× ×—×œ×§ ' + fmt(d.paidAmount) + '</span>' : '') + '</div>' + (d.desc ? '<div style="font-size:11px;color:var(--t2);margin-top:2px">' + d.desc + '</div>' : '') + '</div><div style="text-align:left"><div style="font-size:11px;color:var(--t2)">' + fmtDate(d.date) + '</div><div style="font-size:10px;font-weight:800;color:' + ageColor + '">' + age + ' ×™×•×</div></div></div>';
    });
    debtHtml += '</div>';
  } else {
    debtHtml = '<div style="color:var(--t3);font-size:13px;padding:8px 0;text-align:center">××™×Ÿ ×—×•×‘×•×ª ×¤×ª×•×—×™× âœ…</div>';
  }
  const el = document.getElementById('cd-debts');
  if (el) el.innerHTML = debtHtml;
}

// ===================== CUSTOMER DETAIL =====================
function openCustDetail(cid) {
  activeCid = cid;
  const c = getCust(cid); if (!c) return;
  const debt = totalDebt(cid);
  const idx = DB.customers.indexOf(c);
  document.getElementById('cd-title').innerHTML = `<span style="display:inline-flex;width:26px;height:26px;border-radius:7px;align-items:center;justify-content:center;font-size:12px;font-weight:800;margin-left:8px" class="${avClass(idx)}">${avLetter(c.name)}</span>${c.name}`;
  document.getElementById('cd-actions').innerHTML = `
    <button class="abtn" onclick="openPaymentModal('${cid}')"><span>ğŸ’°</span>×ª×©×œ×•×</button>
    <button class="abtn" onclick="openDebtModal('${cid}')"><span>ğŸ“‹</span>×—×•×‘ ×—×“×©</button>
    <button class="abtn" onclick="openEditCust('${cid}')"><span>âœï¸</span>×¢×¨×™×›×”</button>
    <button class="abtn" onclick="openCustHistory('${cid}')"><span>ğŸ“œ</span>×”×™×¡×˜×•×¨×™×”</button>
    <button class="abtn" onclick="openVisitUpdate('${cid}')"><span>ğŸ“¸</span>×‘×™×§×•×¨</button>
    <button class="abtn" onclick="sendWA('${cid}')"><span>ğŸ’¬</span>WhatsApp</button>
    <button class="abtn" onclick="callCust('${cid}')"><span>ğŸ“</span>×”×ª×§×©×¨</button>`;

  // Reset to info tab
  setCustDetailTab('info');
  document.getElementById('cd-info').innerHTML = `
    <div class="dkv"><span class="dk">×˜×œ×¤×•×Ÿ</span><span class="dv"><a href="tel:${c.phone}" style="color:var(--ac)">${c.phone}</a></span></div>
    <div class="dkv"><span class="dk">×¢×™×¨</span><span class="dv">${c.city || 'â€”'}</span></div>
    <div class="dkv"><span class="dk">××™×© ×§×©×¨</span><span class="dv">${c.contact || 'â€”'}</span></div>
    <div class="dkv"><span class="dk">×ª× ××™ ×ª×©×œ×•×</span><span class="dv"><span class="chip cb">${c.terms ? '×©×•×˜×£ ' + c.terms : '×œ× ×”×•×’×“×¨'}</span></span></div>
    <div class="dkv"><span class="dk">×—×•×‘ ×¨×›×©</span><span class="dv" style="color:${custDebt(cid) > 0 ? 'var(--rd)' : 'var(--gr)'}">${fmt(Math.abs(custDebt(cid)))}</span></div>
    <div class="dkv"><span class="dk">×—×•×‘ ×¦×™×•×“</span><span class="dv" style="color:${eqDebt(cid) > 0 ? 'var(--yw)' : 'var(--t2)'}">${fmt(eqDebt(cid))}</span></div>
    <div class="dkv"><span class="dk">×¡×”"×› ×—×•×‘</span><span class="dv" style="color:${debt > 0 ? 'var(--rd)' : debt < 0 ? 'var(--gr)' : 'var(--t2)'};font-size:17px;font-weight:900">${fmt(Math.abs(debt))} ${debt > 0 ? '×—×•×‘' : debt < 0 ? '×–×›×•×ª' : '×××•×–×Ÿ'}</span></div>
    ${c.notes ? `<div class="dkv"><span class="dk">×”×¢×¨×•×ª</span><span class="dv">${c.notes}</span></div>` : ''}
    <div class="dkv"><span class="dk">×§×•/××¡×œ×•×œ</span><span class="dv">${c.route || 'â€”'}</span></div>
    <div class="dkv"><span class="dk">×‘×™×§×•×¨</span><span class="dv">${c.visitDay || 'â€”'} Â· ${c.visitFreq === 'weekly' ? '×©×‘×•×¢×™' : c.visitFreq === 'biweekly' ? '×“×•-×©×‘×•×¢×™' : c.visitFreq === 'monthly' ? '×—×•×“×©×™' : 'â€”'}</span></div>
    <div class="dkv"><span class="dk">×‘×™×§×•×¨ ××—×¨×•×Ÿ</span><span class="dv">${c.lastVisit ? fmtDate(c.lastVisit) : '×œ× ×‘×•×¦×¢'}</span></div>`;

  const ceq = DB.equipment.filter(e => e.custId === cid);
  document.getElementById('cd-equipment').innerHTML = ceq.length
    ? ceq.map(e => `<div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--br);cursor:pointer" onclick="closeModal('modal-cust-detail');setTimeout(()=>openEqDetail('${e.id}'),200)">
        <div style="font-size:20px">${e.type.split(' ')[0]}</div>
        <div style="flex:1"><div style="font-size:13px;font-weight:700">${e.type} ${e.serial ? 'Â· ' + e.serial : ''}</div>
        <div style="font-size:11px;color:var(--t2)">×”×•×¦×‘ ${fmtDate(e.placed)} Â· <span style="color:${e.status === 'ok' ? 'var(--gr)' : 'var(--rd)'}">${e.status === 'ok' ? '×ª×§×™×Ÿ' : 'âš ï¸ ×ª×§×•×œ'}</span></div></div>
        ${Number(e.eqDebt || 0) > 0 ? `<span class="chip cr">${fmt(e.eqDebt)}</span>` : '<span class="chip cg">×ª×§×™×Ÿ</span>'}
      </div>`).join('')
    : '<div style="color:var(--t3);font-size:13px;padding:8px 0">××™×Ÿ ×¦×™×•×“ ×¨×©×•×</div>';

  // Debts
  renderCustDetailDebts(cid);
  renderPaymentHistory(cid);
  openModal('modal-cust-detail');
}

// ===================== EQUIPMENT DETAIL =====================
function openEqDetail(eid) {
  activeEid = eid;
  const e = DB.equipment.find(x => x.id === eid); if (!e) return;
  const c = getCust(e.custId);
  const debt = Number(e.eqDebt || 0);
  const dp = e.placed ? daysDiff(e.placed) : 0;
  const cd = e.collect ? Math.floor((new Date(e.collect) - Date.now()) / 86400000) : null;
  document.getElementById('ed-title').textContent = e.type;
  document.getElementById('ed-actions').innerHTML = `
    <button class="abtn" onclick="updEqStatus('${eid}','ok')"><span>âœ…</span>×ª×§×™×Ÿ</button>
    <button class="abtn" onclick="updEqStatus('${eid}','broken')"><span>âŒ</span>×ª×§×•×œ</button>
    <button class="abtn" onclick="addPhotoToEquipment('${eid}')"><span>ğŸ“·</span>×ª××•× ×”</button>
    <button class="abtn" onclick="updEqDebt('${eid}')"><span>ğŸ’°</span>×—×•×‘</button>
    <button class="abtn" onclick="collectEq('${eid}')"><span>ğŸ“¦</span>××¡×•×£</button>`;
  document.getElementById('ed-info').innerHTML = `
    <div class="dkv"><span class="dk">×œ×§×•×—</span><span class="dv" style="cursor:pointer;color:var(--ac)" onclick="closeModal('modal-eq-detail');setTimeout(()=>openCustDetail('${e.custId}'),200)">${c ? c.name : 'â€”'}</span></div>
    <div class="dkv"><span class="dk">××¡×¤×¨ ×¡×™×“×•×¨×™</span><span class="dv">${e.serial || 'â€”'}</span></div>
    <div class="dkv"><span class="dk">××¦×‘</span><span class="dv"><span class="chip ${e.status === 'ok' ? 'cg' : e.status === 'broken' ? 'cr' : 'cy'}">${e.status === 'ok' ? 'âœ… ×ª×§×™×Ÿ' : e.status === 'broken' ? 'âŒ ×ª×§×•×œ' : 'ğŸ”§ ×ª×—×–×•×§×”'}</span></span></div>
    <div class="dkv"><span class="dk">×ª××¨×™×š ×”×¦×‘×”</span><span class="dv">${fmtDate(e.placed)} (${dp} ×™××™×)</span></div>
    <div class="dkv"><span class="dk">××™×¡×•×£ ××ª×•×›× ×Ÿ</span><span class="dv">${e.collect ? fmtDate(e.collect) + ' (' + (cd >= 0 ? '×¢×•×“ ' + cd : Math.abs(cd) + ' ××™×—×•×¨') + ' ×™××™×)' : 'â€”'}</span></div>
    <div class="dkv"><span class="dk">×—×•×‘ ×¦×™×•×“</span><span class="dv" style="color:${debt > 0 ? 'var(--rd)' : 'var(--t2)'};font-weight:900;font-size:17px">${fmt(debt)}</span></div>
    ${e.notes ? `<div class="dkv"><span class="dk">×”×¢×¨×•×ª</span><span class="dv">${e.notes}</span></div>` : ''}
    ${e.photos && e.photos.length > 0 ? `
      <div class="sh" style="margin-top:16px"><span class="st">×ª××•× ×•×ª (${e.photos.length})</span></div>
      <div class="photo-gallery">
        ${e.photos.map(p => `<div class="photo-gallery-item" onclick="openFullscreen('${p.data}','${p.date}')"><img src="${p.data}"><button class="photo-gallery-del" onclick="event.stopPropagation();deleteEqPhoto('${eid}','${p.id}')">âœ•</button><div class="photo-date">${fmtDate(p.date)}</div></div>`).join('')}
      </div>` : '<div style="margin-top:12px;color:var(--t3);font-size:12px;text-align:center">××™×Ÿ ×ª××•× ×•×ª â€” ×œ×—×¥ ğŸ“· ×œ×”×•×¡×¤×”</div>'}
    <button class="btnd" onclick="delEq('${eid}')" style="margin-top:16px">ğŸ—‘ï¸ ××—×§ ×¦×™×•×“</button>`;
  openModal('modal-eq-detail');
}

function updEqStatus(eid, s) { DB.equipment.find(e => e.id === eid).status = s; save(); renderAll(); closeModal('modal-eq-detail'); showToast(s === 'ok' ? 'âœ… ×¡×•××Ÿ ×ª×§×™×Ÿ' : 'âŒ ×¡×•××Ÿ ×ª×§×•×œ'); }
function updEqDebt(eid) {
  const e = DB.equipment.find(x => x.id === eid);
  const v = prompt('×¢×“×›×Ÿ ×—×•×‘ ×¦×™×•×“ â‚ª (× ×•×›×—×™: ' + fmt(e.eqDebt || 0) + '):', e.eqDebt || 0);
  if (v !== null && !isNaN(v)) { e.eqDebt = Number(v); save(); renderAll(); closeModal('modal-eq-detail'); showToast('×—×•×‘ ×¦×™×•×“ ×¢×•×“×›×Ÿ'); setTimeout(() => openEqDetail(eid), 300); }
}
function collectEq(eid) { if (!confirm('×œ××¡×•×£ ×¦×™×•×“ ×–×”?')) return; DB.equipment = DB.equipment.filter(e => e.id !== eid); save(); renderAll(); closeModal('modal-eq-detail'); showToast('×¦×™×•×“ × ××¡×£ âœ…'); }
function delEq(eid) { if (!confirm('×œ××—×•×§ ×¦×™×•×“ ×–×”?')) return; DB.equipment = DB.equipment.filter(e => e.id !== eid); save(); renderAll(); closeModal('modal-eq-detail'); showToast('×¦×™×•×“ × ××—×§'); }

// ===================== PAYMENT =====================
function openPaymentGeneral() {
  const wrap = document.getElementById('pay-cust-name').parentElement;
  wrap.innerHTML = `<label class="fl">×œ×§×•×— *</label><select class="fi" id="pay-cust-sel" onchange="onPayCustChange(this.value)">${DB.customers.filter(c => c.active).map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select>`;
  const firstCid = DB.customers.find(c => c.active)?.id;
  if (firstCid) { activeCid = firstCid; document.getElementById('pay-balance').value = fmt(totalDebt(firstCid)); }
  document.getElementById('pay-amount').value = '';
  document.getElementById('pay-date').value = today();
  document.getElementById('pay-note').value = '';
  openModal('modal-payment');
}
function onPayCustChange(cid) { activeCid = cid; document.getElementById('pay-balance').value = fmt(totalDebt(cid)); }

function openPaymentModal(cid) {
  activeCid = cid;
  const cust = getCust(cid);
  const nameEl = document.getElementById('pay-cust-name');
  const balEl = document.getElementById('pay-balance');
  if (nameEl) nameEl.value = cust ? cust.name : '';
  if (balEl) balEl.value = cust ? fmt(totalDebt(cid)) : '';
  document.getElementById('pay-amount').value = '';
  document.getElementById('pay-method').value = '××–×•××Ÿ';
  document.getElementById('pay-date').value = today();
  document.getElementById('pay-note').value = '';
  document.getElementById('pay-check').value = '';
  document.getElementById('pay-check-date').value = '';
  document.getElementById('pay-docref').value = '';
  document.getElementById('pay-check-wrap').style.display = 'none';
  document.getElementById('pay-check-date-wrap').style.display = 'none';
  document.getElementById('pay-docref-wrap').style.display = 'none';
  const sel = document.getElementById('pay-doc-select');
  if (sel) {
    const openDebts = DB.debts.filter(d => d.custId === cid && !d.closed && !d.isCredit);
    sel.innerHTML = '<option value="">-- ×œ×œ× ×©×™×•×š --</option>' + openDebts.map(d => {
      const remaining = Number(d.amount) - (d.paidAmount || 0);
      return `<option value="${d.id}">#${d.docnum || ''} | × ×•×ª×¨: ${fmt(remaining)}${d.desc ? ' | ' + d.desc : ''}</option>`;
    }).join('');
  }
  openModal('modal-payment');
}

function onPayMethodChange() {
  const m = document.getElementById('pay-method').value;
  document.getElementById('pay-check-wrap').style.display = m === '×©×™×§' ? 'block' : 'none';
  document.getElementById('pay-check-date-wrap').style.display = m === '×©×™×§' ? 'block' : 'none';
  document.getElementById('pay-docref-wrap').style.display = m === '×–×™×›×•×™' ? 'block' : 'none';
}

function savePayment() {
  const amt = Number(document.getElementById('pay-amount').value);
  const method = document.getElementById('pay-method').value;
  const payDate = document.getElementById('pay-date').value;
  const note = document.getElementById('pay-note').value.trim();
  const docSel = document.getElementById('pay-doc-select').value;
  if (!amt || amt <= 0) { alert('× × ×œ×”×–×™×Ÿ ×¡×›×•×'); return; }
  if (!note) { alert('×”×¢×¨×” ×”×™× ×©×“×” ×—×•×‘×”'); return; }

  let checkNum = '', checkDate = '', docRef = '';
  if (method === '×©×™×§') {
    checkNum = document.getElementById('pay-check').value.trim();
    checkDate = document.getElementById('pay-check-date').value;
    if (!checkNum) { alert('××¡×¤×¨ ×©×™×§ ×”×•× ×—×•×‘×”'); return; }
  }
  if (method === '×–×™×›×•×™') {
    docRef = document.getElementById('pay-docref').value.trim();
    if (!docRef) { alert('××¡×¤×¨ ××¡××š ×”×•× ×—×•×‘×” ×œ×–×™×›×•×™'); return; }
    DB.debts.push({ id: uid(), custId: activeCid, amount: -Math.abs(amt), docnum: docRef, date: payDate, desc: '×–×™×›×•×™' + (note ? ' â€” ' + note : ''), isCredit: true, closed: true });
    save(); renderAll(); closeModal('modal-payment');
    showToast('×–×™×›×•×™ × ×¨×©× âœ… ' + fmt(amt));
    if (activeCid && document.getElementById('modal-cust-detail').classList.contains('open')) { renderCustDetailDebts(activeCid); setCustDetailTab('debts'); }
    return;
  }

  if (docSel) {
    const debt = DB.debts.find(d => d.id === docSel);
    if (debt) {
      const alreadyPaid = debt.paidAmount || 0;
      const remaining = Number(debt.amount) - alreadyPaid;
      if (amt >= remaining) { debt.paidAmount = Number(debt.amount); debt.closed = true; debt.closedDate = payDate; }
      else { debt.paidAmount = alreadyPaid + amt; }
    }
  }

  DB.payments.push({ id: uid(), custId: activeCid, amount: amt, method, date: payDate, note, check: checkNum, checkDate, linkedDoc: docSel || null });
  save(); renderAll(); closeModal('modal-payment');
  showToast('×ª×©×œ×•× × ×¨×©× âœ… ' + fmt(amt));
  if (document.getElementById('modal-cust-detail').classList.contains('open')) { renderCustDetailDebts(activeCid); setCustDetailTab('debts'); }
}

// ===================== DEBT =====================
function openDebtModal(cid) {
  activeCid = cid;
  const c = getCust(cid);
  document.getElementById('ad-cust-wrap').innerHTML = `<label class="fl">×œ×§×•×—</label><input class="fi" readonly value="${c.name}">`;
  document.getElementById('ad-date').value = today();
  document.getElementById('ad-amount').value = '';
  document.getElementById('ad-desc').value = '';
  openModal('modal-add-debt');
}

function openAddDebtGeneral() {
  const wrap = document.getElementById('ad-cust-wrap');
  wrap.innerHTML = `<label class="fl">×œ×§×•×— *</label><select class="fi" id="ad-cust-sel">${DB.customers.filter(c => c.active).map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select>`;
  activeCid = DB.customers.find(c => c.active)?.id || null;
  document.getElementById('ad-date').value = today();
  document.getElementById('ad-amount').value = '';
  document.getElementById('ad-desc').value = '';
  openModal('modal-add-debt');
}

function saveDebt() {
  const amt = Number(document.getElementById('ad-amount').value);
  const docnum = (document.getElementById('ad-docnum') || {}).value || '';
  if (!docnum.trim()) { alert('× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ××¡××š'); return; }
  if (!amt || amt <= 0) { alert('× × ×œ×”×–×™×Ÿ ×¡×›×•×'); return; }
  if (DB.debts.find(d => d.docnum === docnum.trim())) { if (!confirm('××¡×¤×¨ ××¡××š ' + docnum + ' ×›×‘×¨ ×§×™×™×. ×œ×”××©×™×š?')) return; }
  const sel = document.getElementById('ad-cust-sel');
  const cid = sel ? sel.value : activeCid;
  DB.debts.push({ id: uid(), custId: cid, amount: amt, docnum: docnum.trim(), date: document.getElementById('ad-date').value, desc: document.getElementById('ad-desc').value });
  const _dcid = activeCid;
  save(); renderAll(); closeModal('modal-add-debt');
  showToast('×—×•×‘ × ×•×¡×£ âœ…');
  if (_dcid && document.getElementById('modal-cust-detail').classList.contains('open')) { renderCustDetailDebts(_dcid); setCustDetailTab('debts'); }
}

// ===================== SAVE CUSTOMER =====================
function saveCustomer() {
  const name = document.getElementById('nc-name').value.trim();
  const contact = document.getElementById('nc-contact').value.trim();
  const phone = document.getElementById('nc-phone').value.trim();
  const city = document.getElementById('nc-city').value.trim();
  const termsVal = document.getElementById('nc-terms').value;
  const termsOther = document.getElementById('nc-terms-other').value.trim();
  const route = document.getElementById('nc-route').value;
  const visitFreq = document.getElementById('nc-visit-freq').value;
  const visitDay = document.getElementById('nc-visit-day').value;
  if (!name) { alert('× × ×œ×”×–×™×Ÿ ×©×'); return; }
  if (!contact) { alert('×©× ××™×© ×§×©×¨ ×—×•×‘×”'); return; }
  if (!phone) { alert('× × ×œ×”×–×™×Ÿ ×˜×œ×¤×•×Ÿ'); return; }
  if (!city) { alert('×¢×™×¨ ×—×•×‘×”'); return; }
  if (!termsVal) { alert('× × ×œ×‘×—×•×¨ ×ª× ××™ ×ª×©×œ×•×'); return; }
  if (termsVal === 'other' && !termsOther) { alert('× × ×œ×¤×¨×˜ ×ª× ××™×'); return; }
  if (!route) { alert('× × ×œ×‘×—×•×¨ ×§×•/××¡×œ×•×œ'); return; }
  if (!visitFreq) { alert('× × ×œ×‘×—×•×¨ ×ª×“×™×¨×•×ª ×‘×™×§×•×¨'); return; }
  if (!visitDay) { alert('× × ×œ×‘×—×•×¨ ×™×•× ×‘×™×§×•×¨'); return; }
  const terms = termsVal === 'other' ? termsOther : termsVal;
  DB.customers.push({ id: uid(), name, phone, contact, city, terms, route, visitFreq, visitDay, notes: document.getElementById('nc-notes').value.trim(), created: today(), lastVisit: null, active: true });
  save(); renderAll(); closeModal('modal-add-cust'); showToast('×œ×§×•×— × ×•×¡×£ âœ…');
  ['nc-name', 'nc-contact', 'nc-phone', 'nc-city', 'nc-notes'].forEach(id => document.getElementById(id).value = '');
}

// ===================== EDIT CUSTOMER =====================
function openEditCust(cid) {
  activeCid = cid;
  const cust = getCust(cid); if (!cust) return;
  document.getElementById('ec-name').value = cust.name || '';
  document.getElementById('ec-contact').value = cust.contact || '';
  document.getElementById('ec-phone').value = cust.phone || '';
  document.getElementById('ec-city').value = cust.city || '';
  document.getElementById('ec-notes').value = cust.notes || '';
  const terms = cust.terms || '';
  const isCustom = terms && terms !== '30' && terms !== '60' && terms !== '90';
  document.getElementById('ec-terms').value = isCustom ? 'other' : terms;
  document.getElementById('ec-terms-other-wrap').style.display = isCustom ? 'block' : 'none';
  document.getElementById('ec-terms-other').value = isCustom ? terms : '';
  document.getElementById('ec-route').value = cust.route || '';
  document.getElementById('ec-visit-freq').value = cust.visitFreq || '';
  document.getElementById('ec-visit-day').value = cust.visitDay || '';
  openModal('modal-edit-cust');
}

function saveEditCust() {
  const cust = getCust(activeCid); if (!cust) return;
  const name = document.getElementById('ec-name').value.trim();
  const contact = document.getElementById('ec-contact').value.trim();
  const phone = document.getElementById('ec-phone').value.trim();
  const city = document.getElementById('ec-city').value.trim();
  const termsVal = document.getElementById('ec-terms').value;
  const termsOther = document.getElementById('ec-terms-other').value.trim();
  if (!name) { alert('×©× ×—×•×‘×”'); return; }
  if (!contact) { alert('××™×© ×§×©×¨ ×—×•×‘×”'); return; }
  if (!phone) { alert('×˜×œ×¤×•×Ÿ ×—×•×‘×”'); return; }
  if (!termsVal) { alert('×ª× ××™ ×ª×©×œ×•× ×—×•×‘×”'); return; }
  if (termsVal === 'other' && !termsOther) { alert('×¤×¨×˜ ×ª× ××™×'); return; }
  cust.name = name; cust.contact = contact; cust.phone = phone; cust.city = city;
  cust.terms = termsVal === 'other' ? termsOther : termsVal;
  cust.route = document.getElementById('ec-route').value;
  cust.visitFreq = document.getElementById('ec-visit-freq').value;
  cust.visitDay = document.getElementById('ec-visit-day').value;
  cust.notes = document.getElementById('ec-notes').value.trim();
  const _ecid = activeCid;
  save(); renderAll(); closeModal('modal-edit-cust');
  showToast('×œ×§×•×— ×¢×•×“×›×Ÿ âœ…');
  if (_ecid && document.getElementById('modal-cust-detail').classList.contains('open')) { setTimeout(() => { openCustDetail(_ecid); }, 100); }
}

// ===================== SAVE EQUIPMENT =====================
function openAddEq() {
  const sel = document.getElementById('ne-cust');
  sel.innerHTML = DB.customers.filter(c => c.active).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('ne-placed').value = today();
  document.getElementById('ne-serial').value = '';
  document.getElementById('ne-collect').value = '';
  document.getElementById('ne-debt').value = '';
  document.getElementById('ne-notes').value = '';
  openModal('modal-add-eq');
}

function saveEquipment() {
  const cid = document.getElementById('ne-cust').value;
  const serial = document.getElementById('ne-serial').value.trim();
  if (!cid) { alert('× × ×œ×‘×—×•×¨ ×œ×§×•×—'); return; }
  if (!serial) { alert('××¡×¤×¨ ×¡×™×“×•×¨×™ ×—×•×‘×”'); return; }
  DB.equipment.push({ id: uid(), type: document.getElementById('ne-type').value, serial, custId: cid, placed: document.getElementById('ne-placed').value, collect: document.getElementById('ne-collect').value, status: document.getElementById('ne-status').value, eqDebt: Number(document.getElementById('ne-debt').value) || 0, notes: document.getElementById('ne-notes').value.trim(), photos: [] });
  save(); renderAll(); closeModal('modal-add-eq'); showToast('×¦×™×•×“ × ×•×¡×£ âœ…');
}

// ===================== WHATSAPP / CALL =====================
function sendWA(cid) {
  const c = getCust(cid);
  const debt = totalDebt(cid);
  let msg = `×©×œ×•× ${c.contact || c.name}, `;
  if (debt > 0) msg += `×× ×• ××–×›×™×¨×™× ×©×™×ª×¨×ª ×”×—×•×‘ ×©×œ×š ×¢×•××“×ª ×¢×œ ${fmt(debt)}. × ×©××— ×œ×ª×× ×ª×©×œ×•× × ×•×—. ×ª×•×“×” ğŸ™`;
  else msg += `×¨×¦×™× ×• ×œ×‘×¨×¨ ×œ×’×‘×™ ×”×–×× ×ª×š ×”×§×¨×•×‘×”. ××ª×™ × ×•×— ×œ×š?`;
  const ph = c.phone.replace(/\D/g, '').replace(/^0/, '972');
  window.open(`https://wa.me/${ph}?text=${encodeURIComponent(msg)}`, '_blank');
}
function callCust(cid) { window.open(`tel:${getCust(cid).phone}`); }

// ===================== REPORT =====================
function openReport() {
  const td = DB.customers.reduce((s, c) => s + Math.max(0, totalDebt(c.id)), 0);
  const teq = DB.equipment.reduce((s, e) => s + Number(e.eqDebt || 0), 0);
  const m = new Date().toISOString().substr(0, 7);
  const paid = DB.payments.filter(p => p.date.startsWith(m)).reduce((s, p) => s + Number(p.amount), 0);
  const debtors = DB.customers.filter(c => totalDebt(c.id) > 0);
  const urgent = debtors.filter(c => { const o = DB.debts.filter(d => d.custId === c.id).sort((a, b) => a.date > b.date ? 1 : -1)[0]; return o && daysDiff(o.date) > 60; });
  document.getElementById('report-body').innerHTML = `
    <div class="rep-row"><span class="rep-l">×—×•×‘×•×ª ×œ×§×•×—×•×ª</span><span class="rep-v" style="color:var(--rd)">${fmt(td)}</span></div>
    <div class="rep-row"><span class="rep-l">×—×•×‘×•×ª ×¦×™×•×“</span><span class="rep-v" style="color:var(--yw)">${fmt(teq)}</span></div>
    <div class="rep-row"><span class="rep-l">×’×‘×•×™ ×”×—×•×“×©</span><span class="rep-v" style="color:var(--gr)">${fmt(paid)}</span></div>
    <div class="rep-row"><span class="rep-l">×œ×§×•×—×•×ª ×—×™×™×‘×™×</span><span class="rep-v">${debtors.length}</span></div>
    <div class="rep-row"><span class="rep-l">×“×—×•×¤×™× 60+ ×™×•×</span><span class="rep-v" style="color:var(--rd)">${urgent.length}</span></div>
    <div class="rep-row"><span class="rep-l">×¦×™×•×“ ×‘×©×˜×—</span><span class="rep-v">${DB.equipment.length}</span></div>`;
  let totalInvItems = 0, lowInvItems = 0, pendingOrds = 0;
  DB.customers.forEach(c => {
    (c.inventory || []).forEach(i => { totalInvItems++; if (Number(i.qty) <= Number(i.minQty || 0) && Number(i.minQty || 0) > 0) lowInvItems++; });
    (c.orders || []).forEach(o => { if (o.status === 'pending') pendingOrds++; });
  });
  document.getElementById('report-body').innerHTML += `
    <div class="rep-row"><span class="rep-l">×¡×”"×› ×¤×¨×™×˜×™ ××œ××™</span><span class="rep-v">${totalInvItems}</span></div>
    <div class="rep-row"><span class="rep-l">××œ××™ × ××•×š</span><span class="rep-v" style="color:var(--rd)">${lowInvItems}</span></div>
    <div class="rep-row"><span class="rep-l">×”×–×× ×•×ª ×××ª×™× ×•×ª</span><span class="rep-v" style="color:var(--yw)">${pendingOrds}</span></div>
    <div class="rep-total"><span style="font-size:13px;color:var(--t2);font-weight:600">×¡×”"×› ×—×•×‘ ×›×•×œ×œ</span><span style="font-size:22px;font-weight:900;color:var(--rd)">${fmt(td + teq)}</span></div>
    ${urgent.length ? `<div class="sh" style="margin-top:16px"><span class="st">×“×—×•×¤×™× ×œ×˜×™×¤×•×œ</span></div>${urgent.slice(0, 5).map(c => `<div class="rep-row"><span class="rep-l">${c.name}</span><span class="rep-v" style="color:var(--rd)">${fmt(totalDebt(c.id))}</span></div>`).join('')}` : ''}`;
  openModal('modal-report');
}

// ===================== HISTORY =====================
function renderHistory() {
  const q = (document.getElementById('hist-search')?.value || '').toLowerCase();
  const methodMap = { cash: '××–×•××Ÿ', check: '×©×™×§', transfer: '×”×¢×‘×¨×”', credit: '×–×™×›×•×™' };
  let list = [...DB.payments].sort((a, b) => b.date.localeCompare(a.date));
  if (histTab !== 'all') list = list.filter(p => p.method === methodMap[histTab]);
  if (q) list = list.filter(p => { const c = getCust(p.custId); return (c && c.name.toLowerCase().includes(q)) || String(p.amount).includes(q) || (p.note || '').toLowerCase().includes(q); });
  const total = list.reduce((s, p) => s + Number(p.amount), 0);
  const m = new Date().toISOString().substr(0, 7);
  const thisMonth = list.filter(p => p.date.startsWith(m)).reduce((s, p) => s + Number(p.amount), 0);
  document.getElementById('hist-stats').innerHTML = '<div class="sbox g"><div class="sv g">' + fmt(total) + '</div><div class="sl">×¡×”"×› ×’×‘×•×™</div></div><div class="sbox b"><div class="sv b">' + fmt(thisMonth) + '</div><div class="sl">×”×—×•×“×©</div></div>';
  if (!list.length) { document.getElementById('hist-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">××™×Ÿ ×ª×©×œ×•××™×</div></div>'; return; }
  const groups = {};
  list.forEach(p => { const mo = p.date.substr(0, 7); if (!groups[mo]) groups[mo] = []; groups[mo].push(p); });
  const methodIcon = { '××–×•××Ÿ': 'ğŸ’µ', '×©×™×§': 'ğŸ“', '×”×¢×‘×¨×”': 'ğŸ¦', '×–×™×›×•×™': 'ğŸ’°' };
  let html = '';
  Object.keys(groups).sort((a, b) => b.localeCompare(a)).forEach(mo => {
    const ps = groups[mo];
    const moTotal = ps.reduce((s, p) => s + Number(p.amount), 0);
    const [yr, mn] = mo.split('-');
    const moNames = ['', '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0 6px;margin-top:6px"><span style="font-size:12px;font-weight:700;color:var(--t2);letter-spacing:.5px">${moNames[parseInt(mn)]} ${yr}</span><span style="font-size:13px;font-weight:800;color:var(--gr)">${fmt(moTotal)}</span></div>`;
    ps.forEach(p => {
      const c = getCust(p.custId);
      const icon = methodIcon[p.method] || 'ğŸ’°';
      html += `<div style="background:var(--sf);border:1px solid var(--br);border-radius:14px;padding:13px 14px;margin-bottom:8px;cursor:pointer" onclick="openCustDetail('${p.custId}')"><div style="display:flex;align-items:center;gap:12px"><div style="width:40px;height:40px;border-radius:11px;background:var(--s2);border:1px solid var(--br);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">${icon}</div><div style="flex:1"><div style="font-size:14px;font-weight:700">${c ? c.name : '×œ× ×™×“×•×¢'}</div><div style="font-size:11px;color:var(--t2);margin-top:2px">${p.method}${p.check ? ' Â· ×©×™×§ #' + p.check : ''}${p.note ? ' Â· ' + p.note : ''}</div></div><div style="text-align:left"><div style="font-size:16px;font-weight:900;color:var(--gr)">${fmt(p.amount)}</div><div style="font-size:11px;color:var(--t2)">${fmtDate(p.date)}</div></div></div></div>`;
    });
  });
  document.getElementById('hist-list').innerHTML = html;
}

// ===================== PAYMENT HISTORY =====================
function renderPaymentHistory(cid) {
  const el = document.getElementById('cd-history'); if (!el) return;
  const pays = DB.payments.filter(p => p.custId === cid);
  const debts = DB.debts.filter(d => d.custId === cid);
  if (!pays.length && !debts.length) { el.innerHTML = '<div style="color:var(--t2);font-size:12px;padding:8px">××™×Ÿ ×”×™×¡×˜×•×¨×™×”</div>'; return; }
  let items = [];
  debts.forEach(d => items.push({ type: d.isCredit ? 'credit' : 'debt', date: d.date, data: d }));
  pays.forEach(p => items.push({ type: 'pay', date: p.date, data: p }));
  items.sort((a, b) => a.date > b.date ? -1 : 1);
  el.innerHTML = items.slice(0, 20).map(item => {
    if (item.type === 'debt') {
      const d = item.data;
      const paid = d.paidAmount || 0;
      const remaining = Number(d.amount) - paid;
      let tag = d.closed ? '<span style="font-size:10px;color:var(--gr)">âœ“ ×¡×’×•×¨</span>' : paid > 0 ? '<span style="font-size:10px;color:var(--yw)">×—×œ×§×™</span>' : '<span style="font-size:10px;color:var(--rd)">×¤×ª×•×—</span>';
      return `<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--br)"><div><div style="font-size:12px;font-weight:700;color:var(--rd)">${d.docnum ? '#' + d.docnum + ' Â· ' : ''}${d.desc || '×—×•×‘'} ${tag}</div><div style="font-size:10px;color:var(--t2)">${fmtDate(d.date)}</div></div><div style="font-weight:800;color:var(--rd)">${fmt(d.amount)}</div></div>`;
    } else if (item.type === 'credit') {
      const d = item.data;
      return `<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--br)"><div><div style="font-size:12px;font-weight:700;color:var(--gr)">âœš ×–×™×›×•×™${d.docnum ? ' #' + d.docnum : ''}</div><div style="font-size:10px;color:var(--t2)">${fmtDate(d.date)}</div></div><div style="font-weight:800;color:var(--gr)">+${fmt(Math.abs(d.amount))}</div></div>`;
    } else {
      const p = item.data;
      return `<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--br)"><div><div style="font-size:12px;font-weight:700;color:var(--gr)">${p.method}${p.check ? ' #' + p.check : ''}${p.note ? ' Â· ' + p.note : ''}</div><div style="font-size:10px;color:var(--t2)">${fmtDate(p.date)}</div></div><div style="font-weight:800;color:var(--gr)">${fmt(p.amount)}<button onclick="deletePayment('${p.id}','${p.custId}')" style="display:block;font-size:9px;color:var(--rd);background:none;border:none;cursor:pointer;margin-top:2px">××—×§</button></div></div>`;
    }
  }).join('');
}

function deletePayment(pid, cid) {
  const p = DB.payments.find(x => x.id === pid);
  if (!p) return;
  if (!confirm('×œ××—×•×§ ×ª×©×œ×•× ' + fmt(p.amount) + '?')) return;
  DB.payments = DB.payments.filter(x => x.id !== pid);
  save(); renderAll(); showToast('×ª×©×œ×•× × ××—×§');
  if (document.getElementById('modal-cust-detail').classList.contains('open')) { openCustDetail(cid); }
}

// ===================== CUSTOMER HISTORY =====================
function openCustHistory(cid) {
  activeCid = cid;
  const cust = getCust(cid); if (!cust) return;
  document.getElementById('ch-title').textContent = 'ğŸ“œ ' + cust.name;
  const pays = DB.payments.filter(p => p.custId === cid);
  const debts = DB.debts.filter(d => d.custId === cid);
  const totalD = debts.filter(d => !d.isCredit).reduce((s, d) => s + Number(d.amount), 0);
  const totalP = pays.reduce((s, p) => s + Number(p.amount), 0);
  const totalC = debts.filter(d => d.isCredit).reduce((s, d) => s + Math.abs(Number(d.amount)), 0);
  const balance = totalD - totalP - totalC;
  let html = `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
    <div style="background:rgba(239,68,68,.1);border-radius:12px;padding:12px;text-align:center"><div style="font-size:10px;color:var(--t2)">×—×•×‘×•×ª</div><div style="font-size:16px;font-weight:900;color:var(--rd)">${fmt(totalD)}</div></div>
    <div style="background:rgba(16,185,129,.1);border-radius:12px;padding:12px;text-align:center"><div style="font-size:10px;color:var(--t2)">×’×‘×•×™</div><div style="font-size:16px;font-weight:900;color:var(--gr)">${fmt(totalP)}</div></div>
    <div style="background:rgba(59,130,246,.1);border-radius:12px;padding:12px;text-align:center"><div style="font-size:10px;color:var(--t2)">×™×ª×¨×”</div><div style="font-size:16px;font-weight:900;color:${balance > 0 ? 'var(--rd)' : 'var(--gr)'}">${fmt(Math.abs(balance))}</div></div>
  </div>`;
  let items = [];
  debts.forEach(d => items.push({ type: d.isCredit ? 'credit' : 'debt', date: d.date, data: d }));
  pays.forEach(p => items.push({ type: 'pay', date: p.date, data: p }));
  items.sort((a, b) => a.date > b.date ? -1 : 1);
  items.forEach(item => {
    if (item.type === 'debt') {
      const d = item.data;
      html += `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--br)"><div><div style="font-size:13px;font-weight:700;color:var(--rd)">${d.docnum ? '#' + d.docnum + ' Â· ' : ''}${d.desc || '×—×•×‘'}${d.closed ? ' âœ“' : ''}</div><div style="font-size:10px;color:var(--t2)">${fmtDate(d.date)}</div></div><div style="font-weight:800;color:var(--rd)">${fmt(d.amount)}</div></div>`;
    } else if (item.type === 'credit') {
      const d = item.data;
      html += `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--br)"><div><div style="font-size:13px;font-weight:700;color:var(--gr)">âœš ×–×™×›×•×™${d.docnum ? ' #' + d.docnum : ''}</div><div style="font-size:10px;color:var(--t2)">${fmtDate(d.date)}</div></div><div style="font-weight:800;color:var(--gr)">${fmt(Math.abs(d.amount))}</div></div>`;
    } else {
      const p = item.data;
      html += `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--br)"><div><div style="font-size:13px;font-weight:700;color:var(--gr)">${p.method}${p.check ? ' #' + p.check : ''}${p.note ? ' Â· ' + p.note : ''}</div><div style="font-size:10px;color:var(--t2)">${fmtDate(p.date)}</div></div><div style="font-weight:800;color:var(--gr)">${fmt(p.amount)}</div></div>`;
    }
  });
  if (!items.length) html += '<div style="color:var(--t2);text-align:center;padding:20px">××™×Ÿ ×¤×¢×™×œ×•×ª</div>';
  document.getElementById('ch-body').innerHTML = html;
  openModal('modal-cust-hist');
}

// ===================== DELETE CUSTOMER =====================
function deleteActiveCust() {
  const cust = getCust(activeCid); if (!cust) return;
  if (!confirm('×œ××—×•×§ ××ª ×”×œ×§×•×— ' + cust.name + '? ×›×œ ×”× ×ª×•× ×™× ×™×™××—×§×•.')) return;
  DB.customers = DB.customers.filter(c => c.id !== activeCid);
  DB.debts = DB.debts.filter(d => d.custId !== activeCid);
  DB.payments = DB.payments.filter(p => p.custId !== activeCid);
  DB.equipment = DB.equipment.filter(e => e.custId !== activeCid);
  DB.visits = (DB.visits || []).filter(v => v.custId !== activeCid);
  save(); closeModal('modal-cust-detail'); renderAll(); showToast('×œ×§×•×— × ××—×§');
}

// ===================== MULTI-SELECT DEBTS =====================
function onDebtCheck(cid) {
  const custDebts = DB.debts.filter(d => d.custId === cid);
  const checked = custDebts.filter(d => { const el = document.getElementById('chk-' + d.id); return el && el.checked; });
  const delBtn = document.getElementById('btn-del-sel-' + cid);
  const selAllBtn = document.getElementById('btn-sel-all-' + cid);
  if (delBtn) { delBtn.style.display = checked.length > 0 ? 'block' : 'none'; delBtn.textContent = 'ğŸ—‘ï¸ ××—×§ ' + checked.length + ' (' + fmt(checked.reduce((s, d) => s + Number(d.amount), 0)) + ')'; }
  if (selAllBtn) selAllBtn.textContent = (checked.length === custDebts.length ? 'â˜‘' : 'â˜') + ' ×‘×—×¨ ×”×›×œ';
}
function toggleSelectAllDebts(cid) {
  const custDebts = DB.debts.filter(d => d.custId === cid);
  const checked = custDebts.filter(d => { const el = document.getElementById('chk-' + d.id); return el && el.checked; });
  const allChecked = checked.length === custDebts.length;
  custDebts.forEach(d => { const el = document.getElementById('chk-' + d.id); if (el) el.checked = !allChecked; });
  onDebtCheck(cid);
}
function deleteSelectedDebts(cid) {
  const custDebts = DB.debts.filter(d => d.custId === cid);
  const toDelete = custDebts.filter(d => { const el = document.getElementById('chk-' + d.id); return el && el.checked; });
  if (!toDelete.length) return;
  const total = toDelete.reduce((s, d) => s + Number(d.amount), 0);
  if (!confirm('×œ××—×•×§ ' + toDelete.length + ' ×—×•×‘×•×ª ×‘×¡×š ' + fmt(total) + '?')) return;
  const ids = new Set(toDelete.map(d => d.id));
  DB.debts = DB.debts.filter(d => !ids.has(d.id));
  save(); renderAll(); showToast('âœ… ' + toDelete.length + ' ×—×•×‘×•×ª × ××—×§×•');
  renderCustDetailDebts(cid);
}

// ===================== VISIT =====================
function openVisitUpdate(cid) {
  activeCid = cid;
  document.getElementById('visit-photo').value = '';
  document.getElementById('visit-notes').value = '';
  document.getElementById('visit-skip-reason').value = '';
  document.getElementById('visit-skip-wrap').style.display = 'none';
  document.getElementById('visit-alert-banner').style.display = 'none';
  const alert = getVisitAlert(cid);
  if (alert) { document.getElementById('visit-alert-banner').style.display = 'block'; document.getElementById('visit-alert-banner').textContent = alert; }
  openModal('modal-visit');
}
function markVisitSkipped() { document.getElementById('visit-skip-wrap').style.display = 'block'; document.getElementById('visit-photo').closest('.fg').style.display = 'none'; }
function saveVisit() {
  const skipWrap = document.getElementById('visit-skip-wrap');
  const isSkipped = skipWrap.style.display !== 'none';
  if (isSkipped) {
    const reason = document.getElementById('visit-skip-reason').value.trim();
    if (!reason) { alert('×—×•×‘×” ×œ×¦×™×™×Ÿ ×¡×™×‘×”'); return; }
    DB.visits.push({ id: uid(), custId: activeCid, date: today(), skipped: true, reason });
    save(); renderAll(); closeModal('modal-visit'); showToast('×¡×™×‘×” × ×¨×©××”'); return;
  }
  const photoInput = document.getElementById('visit-photo');
  const notes = document.getElementById('visit-notes').value.trim();
  if (!photoInput.files || !photoInput.files[0]) { alert('×—×•×‘×” ×œ×¦×¨×£ ×ª××•× ×”'); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    DB.visits.push({ id: uid(), custId: activeCid, date: today(), skipped: false, photo: e.target.result, notes });
    const cust = getCust(activeCid);
    if (cust) { cust.lastVisit = today(); cust.lastVisitPhoto = e.target.result; }
    save(); renderAll(); closeModal('modal-visit'); showToast('×‘×™×§×•×¨ × ×¨×©× âœ…');
  };
  reader.readAsDataURL(photoInput.files[0]);
}
function getVisitAlert(cid) {
  const cust = getCust(cid);
  if (!cust || !cust.visitFreq) return null;
  if (!cust.lastVisit) return '×œ× ×‘×•×¦×¢ ×‘×™×§×•×¨ ×××– ×¤×ª×™×—×ª ×”×œ×§×•×—!';
  const days = daysDiff(cust.lastVisit);
  const freqDays = { weekly: 7, biweekly: 14, monthly: 30 };
  const expected = freqDays[cust.visitFreq] || 7;
  if (days > expected) return `×‘×™×§×•×¨ ××—×¨×•×Ÿ ×œ×¤× ×™ ${days} ×™××™× â€” × ×“×¨×© ×›×œ ${expected} ×™××™×!`;
  return null;
}

// ===================== COLLECTION ALERTS =====================
function calcPaymentDue(invoiceDate, terms) {
  if (!invoiceDate || !terms) return null;
  const termsNum = parseInt(terms);
  if (isNaN(termsNum)) return null;
  const d = new Date(invoiceDate);
  const endOfMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0);
  const dueDate = new Date(endOfMonth);
  dueDate.setDate(dueDate.getDate() + termsNum);
  return dueDate;
}
function getUpcomingDebts(daysBefore) {
  const alerts = [];
  const now = new Date();
  DB.customers.forEach(c => {
    if (!c.terms || isNaN(parseInt(c.terms))) return;
    DB.debts.filter(d => d.custId === c.id && !d.closed && !d.isCredit).forEach(d => {
      const due = calcPaymentDue(d.date, c.terms);
      if (!due) return;
      const daysLeft = Math.round((due - now) / 86400000);
      if (daysLeft >= 0 && daysLeft <= daysBefore) alerts.push({ cust: c, debt: d, due, daysLeft });
    });
  });
  return alerts;
}
function checkCollectionAlerts() {
  const alerts = getUpcomingDebts(10);
  const el = document.getElementById('alerts-banner'); if (!el) return;
  if (!alerts.length) { el.style.display = 'none'; return; }
  el.style.display = 'block';
  el.innerHTML = '<div style="font-weight:800;margin-bottom:8px;font-size:13px">âš¡ ×”×ª×¨××•×ª ×’×‘×™×™×” (' + alerts.length + ')</div>'
    + alerts.map(a => `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.1)"><div><div style="font-size:13px;font-weight:700">${a.cust.name}</div><div style="font-size:11px;opacity:.8">×©×•×˜×£ ${a.cust.terms} Â· ${fmt(a.debt.amount)}</div></div><div style="text-align:left"><div style="font-size:12px;font-weight:700;color:#ffd700">${fmtDate(a.due.toISOString().split('T')[0])}</div><div style="font-size:10px;opacity:.8">${a.daysLeft === 0 ? '×”×™×•×!' : a.daysLeft + ' ×™××™×'}</div></div></div>`).join('')
    + '<button onclick="document.getElementById(\'alerts-banner\').style.display=\'none\'" style="margin-top:8px;width:100%;padding:7px;border-radius:8px;border:1px solid rgba(255,255,255,.3);background:none;color:#fff;font-size:12px;cursor:pointer">×¡×’×•×¨</button>';
}
function checkVisitAlerts() {
  const today_ = new Date();
  const dow = today_.getDay();
  if (dow === 5 || dow === 6) return;
  const dayNames = { ×¨××©×•×Ÿ: 0, ×©× ×™: 1, ×©×œ×™×©×™: 2, ×¨×‘×™×¢×™: 3, ×—××™×©×™: 4 };
  const alerts = [];
  DB.customers.filter(c => c.active && c.visitDay).forEach(cust => {
    const expectedDow = dayNames[cust.visitDay];
    if (expectedDow === undefined || expectedDow !== dow) return;
    const visitedToday = (DB.visits || []).some(v => v.custId === cust.id && v.date === today());
    if (!visitedToday) alerts.push(cust);
  });
  const el = document.getElementById('visit-alerts-banner'); if (!el) return;
  if (!alerts.length) { el.style.display = 'none'; return; }
  el.style.display = 'block';
  el.innerHTML = '<div style="font-weight:800;margin-bottom:6px">ğŸ“… ×‘×™×§×•×¨×™× ×œ×”×™×•× (' + alerts.length + ')</div>'
    + alerts.map(c => `<div style="display:flex;justify-content:space-between;padding:5px 0;border-top:1px solid rgba(255,255,255,.15);cursor:pointer" onclick="openVisitUpdate('${c.id}')"><span>${c.name}</span><span style="font-size:11px;opacity:.7">${c.visitDay}</span></div>`).join('')
    + '<button onclick="document.getElementById(\'visit-alerts-banner\').style.display=\'none\'" style="margin-top:8px;width:100%;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,.3);background:none;color:#fff;font-size:12px;cursor:pointer">×¡×’×•×¨</button>';
}

// ===================== MONTHLY VIEW =====================
function renderMonthlyCollection() {
  const el = document.getElementById('monthly-list'); if (!el) return;
  const monthMap = {};
  DB.customers.forEach(c => {
    DB.debts.filter(d => d.custId === c.id && !d.closed && !d.isCredit).forEach(d => {
      const terms = c.terms || '30';
      const due = calcPaymentDue(d.date, terms);
      if (!due) return;
      const key = due.getFullYear() + '-' + String(due.getMonth() + 1).padStart(2, '0');
      if (!monthMap[key]) monthMap[key] = [];
      monthMap[key].push({ c, d, due, terms });
    });
  });
  if (!Object.keys(monthMap).length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“…</div><div class="empty-title">××™×Ÿ ×’×‘×™×•×ª ××ª×•×›× × ×•×ª</div></div>'; return; }
  const moNames = ['', '×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
  const now = new Date();
  const curKey = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  let html = '';
  Object.keys(monthMap).sort().forEach(key => {
    const items = monthMap[key];
    const total = items.reduce((s, x) => s + Number(x.d.amount), 0);
    const [yr, mn] = key.split('-');
    const isCurrent = key === curKey;
    const isPast = key < curKey;
    const monthColor = isCurrent ? 'var(--yw)' : isPast ? 'var(--rd)' : 'var(--gr)';
    html += `<div style="background:var(--sf);border:1px solid ${isCurrent ? 'rgba(245,158,11,.4)' : isPast ? 'rgba(239,68,68,.3)' : 'var(--br)'};border-radius:14px;padding:14px;margin-bottom:10px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div><span style="font-size:15px;font-weight:800;color:${monthColor}">${moNames[parseInt(mn)]} ${yr}</span>${isCurrent ? '<span style="font-size:10px;background:rgba(245,158,11,.2);color:var(--yw);border-radius:10px;padding:2px 8px;font-weight:700;margin-right:6px">×”×—×•×“×©</span>' : ''}${isPast ? '<span style="font-size:10px;background:rgba(239,68,68,.2);color:var(--rd);border-radius:10px;padding:2px 8px;font-weight:700;margin-right:6px">×‘××™×—×•×¨</span>' : ''}</div><span style="font-size:17px;font-weight:900;color:${monthColor}">${fmt(total)}</span></div>`;
    items.forEach(x => {
      const daysLeft = Math.round((x.due - now) / 86400000);
      const clr = daysLeft < 0 ? 'var(--rd)' : daysLeft <= 10 ? 'var(--yw)' : 'var(--t2)';
      html += `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-top:1px solid var(--br);cursor:pointer" onclick="openCustDetail('${x.c.id}')"><div style="flex:1"><div style="font-size:13px;font-weight:700">${x.c.name}</div><div style="font-size:11px;color:var(--t2)">×©×•×˜×£ ${x.terms}${x.d.docnum ? ' Â· #' + x.d.docnum : ''}${x.d.desc ? ' Â· ' + x.d.desc : ''}</div></div><div style="text-align:left"><div style="font-size:14px;font-weight:900;color:var(--rd)">${fmt(x.d.amount)}</div><div style="font-size:10px;font-weight:700;color:${clr}">${fmtDate(x.due.toISOString().split('T')[0])}</div></div></div>`;
    });
    html += '</div>';
  });
  el.innerHTML = html;
}

// ===================== PHOTOS =====================
function addPhotoToEquipment(eid) {
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = 'image/*'; inp.capture = 'environment'; inp.style.display = 'none';
  inp.onchange = function() {
    if (!inp.files || !inp.files[0]) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      compressImage(ev.target.result, 800, 0.75, function(compressed) {
        const e = DB.equipment.find(x => x.id === eid); if (!e) return;
        if (!e.photos) e.photos = [];
        e.photos.push({ data: compressed, date: today(), id: uid() });
        save(); closeModal('modal-eq-detail'); setTimeout(() => openEqDetail(eid), 200); showToast('×ª××•× ×” × ×©××¨×” âœ…');
      });
    };
    reader.readAsDataURL(inp.files[0]);
  };
  document.body.appendChild(inp); inp.click(); setTimeout(() => document.body.removeChild(inp), 5000);
}
function deleteEqPhoto(eid, photoId) {
  const e = DB.equipment.find(x => x.id === eid); if (!e || !e.photos) return;
  e.photos = e.photos.filter(p => p.id !== photoId);
  save(); closeModal('modal-eq-detail'); setTimeout(() => openEqDetail(eid), 200); showToast('×ª××•× ×” × ××—×§×”');
}
function compressImage(dataUrl, maxWidth, quality, callback) {
  const img = new Image();
  img.onload = function() {
    let w = img.width, h = img.height;
    if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
    callback(canvas.toDataURL('image/jpeg', quality));
  };
  img.src = dataUrl;
}
function openFullscreen(src, date) {
  document.getElementById('photo-fullscreen-img').src = src;
  document.getElementById('photo-fullscreen-date').textContent = date ? '×¦×•×œ×: ' + fmtDate(date) : '';
  document.getElementById('photo-fullscreen').style.display = 'flex';
}
function closeFullscreen() { document.getElementById('photo-fullscreen').style.display = 'none'; }

// ===================== THURSDAY =====================
function openEnvelopeUpload() {
  document.getElementById('envelope-photo').value = '';
  document.getElementById('envelope-note').value = '';
  document.getElementById('envelope-status').textContent = '';
  openModal('modal-envelope');
}
function saveEnvelope() {
  const photoInput = document.getElementById('envelope-photo');
  if (!photoInput.files || !photoInput.files[0]) { alert('×—×•×‘×” ×œ×¦×¨×£ ×ª××•× ×”'); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    localStorage.setItem('envelope_' + today(), JSON.stringify({ photo: e.target.result, note: document.getElementById('envelope-note').value, date: today() }));
    document.getElementById('envelope-status').textContent = 'âœ… ×”×•×¢×œ×”!';
    const btn = document.getElementById('thu-btn');
    if (btn) { btn.style.background = 'rgba(16,185,129,.2)'; btn.style.border = '1px solid var(--gr)'; }
    setTimeout(() => closeModal('modal-envelope'), 1500);
  };
  reader.readAsDataURL(photoInput.files[0]);
}
function checkThursdayReminder() {
  const btn = document.getElementById('thu-btn'); if (!btn) return;
  const isThursday = new Date().getDay() === 4;
  if (!isThursday) { btn.style.opacity = '0.3'; btn.style.background = ''; btn.style.border = ''; return; }
  btn.style.opacity = '1';
  const uploaded = localStorage.getItem('envelope_' + today());
  if (uploaded) { btn.style.background = 'rgba(16,185,129,.2)'; btn.style.border = '1px solid var(--gr)'; }
  else {
    btn.style.background = 'rgba(245,158,11,.2)'; btn.style.border = '1px solid var(--yw)';
    const key = 'thu_alert_' + today();
    if (!localStorage.getItem(key)) { localStorage.setItem(key, '1'); setTimeout(() => showToast('ğŸ“¬ ×™×•× ×—××™×©×™ â€” ××œ ×ª×©×›×— ×”××¢×˜×¤×”!'), 3000); }
  }
}

// ===================== EXPORT =====================
function csvEscape(v) { if (v === null || v === undefined) return ''; const s = String(v); const needs = s.indexOf(',') >= 0 || s.indexOf('"') >= 0 || s.indexOf('\n') >= 0; if (needs) return '"' + s.replace(/"/g, '""') + '"'; return s; }
function csvRow(arr) { return arr.map(csvEscape).join(','); }
function downloadCSV(filename, rows) {
  const bom = '\uFEFF';
  const csv = bom + rows.join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.style.display = 'none';
  document.body.appendChild(a); a.click();
  setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(a); }, 1000);
}

function exportCSV(type) {
  const d = today();
  if (type === 'customers') {
    const rows = [csvRow(['×©× ×œ×§×•×—', '××™×© ×§×©×¨', '×˜×œ×¤×•×Ÿ', '×¢×™×¨', '×ª× ××™ ×ª×©×œ×•×', '×§×•', '×—×•×‘', '×”×¢×¨×•×ª'])];
    DB.customers.filter(c => c.active).forEach(c => rows.push(csvRow([c.name, c.contact || '', c.phone, c.city || '', c.terms ? '×©×•×˜×£ ' + c.terms : '', c.route || '', totalDebt(c.id), c.notes || ''])));
    downloadCSV('×œ×§×•×—×•×ª_' + d + '.csv', rows); showToast('×™×¦×•× ×œ×§×•×—×•×ª âœ…');
  } else if (type === 'equipment') {
    const rows = [csvRow(['×¡×•×’', '××¡×¤×¨ ×¡×™×“×•×¨×™', '×œ×§×•×—', '×”×¦×‘×”', '××™×¡×•×£', '××¦×‘', '×—×•×‘ ×¦×™×•×“'])];
    DB.equipment.forEach(e => { const c = getCust(e.custId); rows.push(csvRow([e.type, e.serial || '', c ? c.name : 'â€”', e.placed || '', e.collect || '', e.status === 'ok' ? '×ª×§×™×Ÿ' : e.status === 'broken' ? '×ª×§×•×œ' : '×ª×—×–×•×§×”', e.eqDebt || 0])); });
    downloadCSV('×¦×™×•×“_' + d + '.csv', rows); showToast('×™×¦×•× ×¦×™×•×“ âœ…');
  } else if (type === 'payments') {
    const rows = [csvRow(['×œ×§×•×—', '×¡×›×•×', '×ª××¨×™×š', '×××¦×¢×™', '×©×™×§', '×”×¢×¨×”'])];
    [...DB.payments].sort((a, b) => b.date.localeCompare(a.date)).forEach(p => { const c = getCust(p.custId); rows.push(csvRow([c ? c.name : 'â€”', p.amount, p.date, p.method, p.check || '', p.note || ''])); });
    downloadCSV('×ª×©×œ×•××™×_' + d + '.csv', rows); showToast('×™×¦×•× ×ª×©×œ×•××™× âœ…');
  } else if (type === 'debts') {
    const rows = [csvRow(['×œ×§×•×—', '××¡××š', '×¡×›×•×', '×ª××¨×™×š', '×ª×™××•×¨', '×’×™×œ'])];
    [...DB.debts].sort((a, b) => b.date.localeCompare(a.date)).forEach(d => { const c = getCust(d.custId); rows.push(csvRow([c ? c.name : 'â€”', d.docnum || '', d.amount, d.date, d.desc || '', daysDiff(d.date)])); });
    downloadCSV('×—×•×‘×•×ª_' + d + '.csv', rows); showToast('×™×¦×•× ×—×•×‘×•×ª âœ…');
  } else if (type === 'inventory') {
    const rows = [csvRow(['×œ×§×•×—', '×©× ××•×¦×¨', '×§×˜×’×•×¨×™×”', '×›××•×ª', '××™× ×™××•×', '××—×™×¨', '×ª×¤×•×’×”'])];
    DB.customers.forEach(c => {
      (c.inventory || []).forEach(i => rows.push(csvRow([c.name, i.name, catNames[i.category] || '', i.qty, i.minQty || 0, i.salePrice || 0, i.expiry || ''])));
    });
    downloadCSV('××œ××™_' + d + '.csv', rows); showToast('×™×¦×•× ××œ××™ âœ…');
  } else if (type === 'all') {
    const rows = [csvRow(['=== ×œ×§×•×—×•×ª ==='])];
    rows.push(csvRow(['×©×', '×˜×œ×¤×•×Ÿ', '×¢×™×¨', '×ª× ××™×', '×—×•×‘']));
    DB.customers.filter(c => c.active).forEach(c => rows.push(csvRow([c.name, c.phone, c.city || '', c.terms ? '×©×•×˜×£ ' + c.terms : '', totalDebt(c.id)])));
    rows.push(csvRow([''])); rows.push(csvRow(['=== ××œ××™ ===']));
    rows.push(csvRow(['×œ×§×•×—', '××•×¦×¨', '×›××•×ª', '××™× ×™××•×']));
    DB.customers.forEach(c => { (c.inventory || []).forEach(i => rows.push(csvRow([c.name, i.name, i.qty, i.minQty || 0]))); });
    downloadCSV('CRM_××œ×_' + d + '.csv', rows); showToast('×™×¦×•× ××œ× âœ…');
  }
  closeModal('modal-export');
}

function populateExportCustSel() {
  const sel = document.getElementById('export-cust-sel'); if (!sel) return;
  sel.innerHTML = '<option value="">-- ×‘×—×¨ ×œ×§×•×— --</option>' + DB.customers.filter(c => c.active).sort((a, b) => a.name.localeCompare(b.name, 'he')).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}
function exportByCust() {
  const cid = document.getElementById('export-cust-sel').value;
  if (!cid) { alert('× × ×œ×‘×—×•×¨ ×œ×§×•×—'); return; }
  const cust = getCust(cid); if (!cust) return;
  const rows = [csvRow(['×¡×•×’', '××¡××š', '×ª××¨×™×š', '×¡×›×•×', '×ª×™××•×¨', '×¡×˜×˜×•×¡'])];
  const items = [...DB.debts.filter(dd => dd.custId === cid), ...DB.payments.filter(p => p.custId === cid)].sort((a, b) => a.date.localeCompare(b.date));
  items.forEach(item => {
    if (item.docnum !== undefined) rows.push(csvRow([item.isCredit ? '×–×™×›×•×™' : '×—×•×‘', item.docnum || '', item.date, Math.abs(item.amount), item.desc || '', item.closed ? '×¡×’×•×¨' : (item.paidAmount ? '×—×œ×§×™' : '×¤×ª×•×—')]));
    else rows.push(csvRow(['×ª×©×œ×•×', '', item.date, item.amount, item.method + (item.check ? ' #' + item.check : ''), item.note || '']));
  });
  rows.push(csvRow([''])); rows.push(csvRow(['×™×ª×¨×”', '', '', custDebt(cid)]));
  downloadCSV(cust.name + '_' + today() + '.csv', rows); showToast('×™×¦×•× ' + cust.name + ' âœ…'); closeModal('modal-export');
}


// ===================== FULL BACKUP / RESTORE =====================
function exportFullBackup() {
  const backup = {
    version: 2,
    exported: new Date().toISOString(),
    customers: DB.customers,
    debts: DB.debts,
    payments: DB.payments,
    equipment: DB.equipment,
    visits: DB.visits || [],
    inventory_note: '××œ××™ ××•×¦××“ ×‘×ª×•×š customers[].inventory'
  };
  const json = JSON.stringify(backup, null, 2);
  const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'CRM_×’×™×‘×•×™_' + today() + '.json'; a.style.display = 'none';
  document.body.appendChild(a); a.click();
  setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(a); }, 1000);
  showToast('×’×™×‘×•×™ ××œ× ×”×•×¨×“ âœ…');
  closeModal('modal-export');
}

function importFromJSON(input) {
  const file = input.files[0]; if (!file) return;
  document.getElementById('import-json-label').textContent = file.name;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.customers || !Array.isArray(data.customers)) {
        alert('×§×•×‘×¥ JSON ×œ× ×ª×§×™×Ÿ â€” ×—×¡×¨ ××¢×¨×š customers'); return;
      }
      const msg = `×©×—×–×•×¨ ×’×™×‘×•×™ ×-${data.exported ? new Date(data.exported).toLocaleDateString('he') : '×ª××¨×™×š ×œ× ×™×“×•×¢'}

×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ×™×•×—×œ×¤×• ×œ×—×œ×•×˜×™×Ÿ!

×œ×§×•×—×•×ª: ${data.customers.length}
×—×•×‘×•×ª: ${(data.debts||[]).length}
×ª×©×œ×•××™×: ${(data.payments||[]).length}
×¦×™×•×“: ${(data.equipment||[]).length}

×”×× ×œ×”××©×™×š?`;
      if (!confirm(msg)) { input.value = ''; document.getElementById('import-json-label').textContent = '×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×•×‘×¥ JSON...'; return; }
      DB.customers = data.customers;
      DB.debts = data.debts || [];
      DB.payments = data.payments || [];
      DB.equipment = data.equipment || [];
      DB.visits = data.visits || [];
      save(); renderAll();
      closeModal('modal-export');
      showToast('âœ… ×©×•×—×–×¨! ' + DB.customers.length + ' ×œ×§×•×—×•×ª, ' + DB.debts.length + ' ×—×•×‘×•×ª');
    } catch(err) {
      alert('×©×’×™××” ×‘×¤×¢× ×•×— ×”×§×•×‘×¥: ' + err.message);
    }
  };
  reader.readAsText(file, 'utf-8');
}

// ===================== CSV IMPORT =====================
function parseCSVLine(line) {
  const result = []; let cur = ''; let inQ = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') { if (inQ && line[i+1] === '"') { cur += '"'; i++; } else inQ = !inQ; }
    else if (ch === ',' && !inQ) { result.push(cur.trim()); cur = ''; }
    else cur += ch;
  }
  result.push(cur.trim());
  return result;
}

function parseCSV(text) {
  const lines = text.replace(/\r/g, '').split('\n').filter(l => l.trim());
  if (lines.length < 2) return { headers: [], rows: [] };
  const headers = parseCSVLine(lines[0]).map(h => h.replace(/^\uFEFF/, '').trim());
  const rows = lines.slice(1).map(l => {
    const vals = parseCSVLine(l);
    const obj = {};
    headers.forEach((h, i) => obj[h] = (vals[i] || '').trim());
    return obj;
  });
  return { headers, rows };
}

function importFromCSV(input) {
  const file = input.files[0]; if (!file) return;
  document.getElementById('import-csv-label').textContent = file.name;
  const type = document.getElementById('import-csv-type').value;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const { headers, rows } = parseCSV(e.target.result);
      if (!rows.length) { showImportResult('error', '×”×§×•×‘×¥ ×¨×™×§'); return; }
      let imported = 0, skipped = 0, errors = [];

      if (type === 'customers') {
        // Required: ×©× ×œ×§×•×—, ×˜×œ×¤×•×Ÿ
        rows.forEach((r, idx) => {
          const name = r['×©× ×œ×§×•×—'] || r['×©×'];
          const phone = r['×˜×œ×¤×•×Ÿ'];
          if (!name) { skipped++; return; }
          const terms = (r['×ª× ××™ ×ª×©×œ×•×'] || '').replace('×©×•×˜×£ ','');
          const existing = DB.customers.find(c => c.phone === phone || c.name === name);
          if (existing) {
            // update existing
            if (r['××™×© ×§×©×¨']) existing.contact = r['××™×© ×§×©×¨'];
            if (r['×¢×™×¨']) existing.city = r['×¢×™×¨'];
            if (terms) existing.terms = terms;
            if (r['×§×•']) existing.route = r['×§×•'];
            if (r['×”×¢×¨×•×ª']) existing.notes = r['×”×¢×¨×•×ª'];
            imported++;
          } else {
            DB.customers.push({
              id: uid(), name, phone: phone || '', contact: r['××™×© ×§×©×¨'] || '',
              city: r['×¢×™×¨'] || '', terms, route: r['×§×•'] || '',
              notes: r['×”×¢×¨×•×ª'] || '', created: today(), active: true
            });
            imported++;
          }
        });

      } else if (type === 'debts') {
        // Required: ×œ×§×•×—, ×¡×›×•×, ××¡×¤×¨ ××¡××š
        rows.forEach(r => {
          const custName = r['×œ×§×•×—'];
          const amount = Number(r['×¡×›×•×']);
          const docnum = r['××¡××š'] || r['××¡×¤×¨ ××¡××š'];
          if (!custName || !amount) { skipped++; return; }
          const cust = DB.customers.find(c => c.name === custName);
          if (!cust) { errors.push('×œ× × ××¦× ×œ×§×•×—: ' + custName); skipped++; return; }
          if (docnum && DB.debts.find(d => d.docnum === docnum && d.custId === cust.id)) { skipped++; return; }
          DB.debts.push({
            id: uid(), custId: cust.id, amount, docnum: docnum || '',
            date: r['×ª××¨×™×š'] || today(), desc: r['×ª×™××•×¨'] || ''
          });
          imported++;
        });

      } else if (type === 'payments') {
        // Required: ×œ×§×•×—, ×¡×›×•×, ×ª××¨×™×š, ×××¦×¢×™
        rows.forEach(r => {
          const custName = r['×œ×§×•×—'];
          const amount = Number(r['×¡×›×•×']);
          if (!custName || !amount) { skipped++; return; }
          const cust = DB.customers.find(c => c.name === custName);
          if (!cust) { errors.push('×œ× × ××¦× ×œ×§×•×—: ' + custName); skipped++; return; }
          DB.payments.push({
            id: uid(), custId: cust.id, amount,
            method: r['×××¦×¢×™'] || '××–×•××Ÿ',
            date: r['×ª××¨×™×š'] || today(),
            note: r['×”×¢×¨×”'] || '',
            check: r['×©×™×§'] || ''
          });
          imported++;
        });

      } else if (type === 'inventory') {
        // Required: ×œ×§×•×—, ×©× ××•×¦×¨
        rows.forEach(r => {
          const custName = r['×œ×§×•×—'];
          const name = r['×©× ××•×¦×¨'];
          if (!custName || !name) { skipped++; return; }
          const cust = DB.customers.find(c => c.name === custName);
          if (!cust) { errors.push('×œ× × ××¦× ×œ×§×•×—: ' + custName); skipped++; return; }
          if (!cust.inventory) cust.inventory = [];
          const existing = cust.inventory.find(i => i.name === name);
          if (existing) {
            if (r['×›××•×ª']) existing.qty = Number(r['×›××•×ª']) || 0;
            if (r['××™× ×™××•×']) existing.minQty = Number(r['××™× ×™××•×']) || 0;
            if (r['××—×™×¨']) existing.salePrice = Number(r['××—×™×¨']) || 0;
            if (r['×ª×¤×•×’×”']) existing.expiry = r['×ª×¤×•×’×”'];
            imported++;
          } else {
            const catMap = { '×’×œ×™×“×•×ª':'icecream', '×™×¨×§×•×ª':'vegetables', '×‘×¦×§':'dough', '×¤×™×¨×•×ª':'fruit', '××—×¨':'other' };
            cust.inventory.push({
              id: uid(), name,
              category: catMap[r['×§×˜×’×•×¨×™×”']] || 'other',
              qty: Number(r['×›××•×ª']) || 0,
              minQty: Number(r['××™× ×™××•×']) || 0,
              salePrice: Number(r['××—×™×¨']) || 0,
              expiry: r['×ª×¤×•×’×”'] || '',
              created: today()
            });
            imported++;
          }
        });
      }

      save(); renderAll();
      const msg = `âœ… ×™×•×‘××• ${imported} ×¨×©×•××•×ª` + (skipped ? `, ×“×•×œ×’×• ${skipped}` : '') + (errors.length ? `\nâš ï¸ ${errors.slice(0,3).join(', ')}` : '');
      showImportResult('ok', msg);
      if (imported > 0) showToast('âœ… ×™×•×‘××• ' + imported + ' ×¨×©×•××•×ª');

    } catch(err) {
      showImportResult('error', '×©×’×™××”: ' + err.message);
    }
    input.value = '';
  };
  reader.readAsText(file, 'utf-8');
}

function showImportResult(type, msg) {
  const el = document.getElementById('import-result'); if (!el) return;
  el.style.display = 'block';
  el.style.background = type === 'ok' ? 'rgba(16,185,129,.15)' : 'rgba(239,68,68,.15)';
  el.style.color = type === 'ok' ? 'var(--gr)' : 'var(--rd)';
  el.style.border = type === 'ok' ? '1px solid rgba(16,185,129,.3)' : '1px solid rgba(239,68,68,.3)';
  el.textContent = msg;
}

// ===================== TERMS HELPER =====================
function toggleTermsOther(prefix) {
  const val = document.getElementById(prefix + '-terms').value;
  const wrap = document.getElementById(prefix + '-terms-other-wrap');
  if (wrap) wrap.style.display = val === 'other' ? 'block' : 'none';
}

// ===================== LOGIN =====================
const USERS = { tzahi: { pass: 'tzahi12345', name: '×¦×—×™' } };
function doLogin() {
  const u = document.getElementById('login-user').value.trim().toLowerCase();
  const p = document.getElementById('login-pass').value;
  const err = document.getElementById('login-err');
  if (USERS[u] && USERS[u].pass === p) {
    document.getElementById('login-screen').style.display = 'none';
    err.classList.remove('show');
    document.getElementById('tsub').textContent = '×©×œ×•× ' + USERS[u].name + ' Â· ' + DB.customers.length + ' ×œ×§×•×—×•×ª';
    renderAll();
    loadFromCloud();
    checkEndOfMonthReminder();
  } else {
    err.classList.add('show');
    document.getElementById('login-pass').value = '';
  }
}

function checkEndOfMonthReminder() {
  const now = new Date();
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  const daysLeft = lastDay - now.getDate();
  const key = 'eom_reminder_' + now.getFullYear() + '_' + now.getMonth();
  if (daysLeft <= 3 && !localStorage.getItem(key)) {
    localStorage.setItem(key, 'shown');
    const mo = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
    setTimeout(() => {
      const pending = getUpcomingDebts(35);
      const total = pending.reduce((s, a) => s + Number(a.debt.amount), 0);
      if (!total) return;
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)';
      overlay.innerHTML = `<div style="background:var(--sf);border:1px solid var(--br2);border-radius:20px;padding:24px;max-width:340px;width:100%;text-align:center"><div style="font-size:40px;margin-bottom:12px">ğŸ“…</div><div style="font-size:18px;font-weight:900;margin-bottom:8px">×¡×•×£ ×—×•×“×© ${mo[now.getMonth()]}!</div><div style="font-size:14px;color:var(--t2);margin-bottom:16px">${pending.length} ×’×‘×™×•×ª ×××ª×™× ×•×ª<br><span style="font-size:22px;font-weight:900;color:var(--rd)">${fmt(total)}</span></div><button onclick="goPage('monthly',document.getElementById('ni-monthly'));this.closest('[style*=fixed]').remove()" style="width:100%;padding:14px;border-radius:12px;background:var(--ac);color:#fff;border:none;font-size:15px;font-weight:800;cursor:pointer;margin-bottom:8px">×œ×•×— ×’×‘×™×™×” ğŸ“Š</button><button onclick="this.closest('[style*=fixed]').remove()" style="width:100%;padding:10px;border-radius:12px;background:var(--s3);color:var(--tx);border:none;font-size:14px;cursor:pointer">×¡×’×•×¨</button></div>`;
      document.body.appendChild(overlay);
    }, 2000);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  ['login-user', 'login-pass'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
  });
});

// ===================== RENDER ALL =====================
function renderAll() {
  renderDashboard();
  if (curPage === 'cust') renderCustomers();
  if (curPage === 'eq') renderEquipment();
  if (curPage === 'debt') renderDebts();
  if (curPage === 'inv') renderInventory();
  if (curPage === 'orders') renderOrders();
  if (curPage === 'hist') renderHistory();
  if (curPage === 'monthly') renderMonthlyCollection();
}

document.getElementById('fab-btn').style.display = 'none';
</script>

</body>
</html>