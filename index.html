<!DOCTYPE html>

<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CRM ×× ×”×œ ×©×˜×—</title>
<meta name="theme-color" content="#0f0f1a">
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg0:#0a0a14;--bg1:#0f0f1a;--bg2:#1a1a2e;--bg3:#16213e;--acc:#e94560;--acc2:#ff6b81;--grn:#00d2a0;--ylw:#f5a623;--blu:#4ea8de;--txt:#eaeaea;--tx2:#8899aa;--tx3:#556677;--brd:#2a2a4a;--r:14px;--rs:8px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Heebo',sans-serif;background:var(--bg0);color:var(--txt);min-height:100vh;overflow-x:hidden;-webkit-tap-highlight-color:transparent}
input,select,textarea,button{font-family:inherit}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg0)}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:4px}
#loginScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#0a0a14,#1a1a2e,#16213e);padding:20px}
.lbox{background:var(--bg3);border:1px solid var(--brd);border-radius:20px;padding:48px 36px;width:100%;max-width:380px;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,.4)}
.llogo{width:72px;height:72px;background:linear-gradient(135deg,var(--acc),var(--acc2));border-radius:18px;display:flex;align-items:center;justify-content:center;margin:0 auto 18px;font-size:32px;font-weight:800;color:#fff}
.lbox h1{font-size:24px;font-weight:700;margin-bottom:4px}
.lbox>p{color:var(--tx2);font-size:13px;margin-bottom:28px}
.lbox input{width:100%;padding:13px 16px;background:var(--bg2);border:1px solid var(--brd);border-radius:var(--rs);color:var(--txt);font-size:14px;margin-bottom:12px;outline:none;transition:.2s}
.lbox input:focus{border-color:var(--acc)}
.lbox button{width:100%;padding:13px;background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;border-radius:var(--rs);color:#fff;font-size:15px;font-weight:600;cursor:pointer;margin-top:6px;transition:.15s}
.lbox button:active{transform:scale(.97)}
#app{display:none;min-height:100vh;padding-bottom:76px}
#app.on{display:block}
.tbar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg2);border-bottom:1px solid var(--brd);position:sticky;top:0;z-index:100}
.tbar h2{font-size:17px;font-weight:700}
.tbar-b{display:flex;gap:8px}
.tbar-b button{background:var(--bg3);border:1px solid var(--brd);border-radius:var(--rs);padding:7px 11px;color:var(--txt);font-size:12px;cursor:pointer;transition:.2s}
.tbar-b button:hover{border-color:var(--acc);color:var(--acc)}
.bnav{position:fixed;bottom:0;left:0;right:0;display:flex;background:var(--bg2);border-top:1px solid var(--brd);z-index:200;padding:6px 0;padding-bottom:max(env(safe-area-inset-bottom),6px)}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 2px;cursor:pointer;color:var(--tx3);font-size:10px;font-weight:500;transition:.2s;text-decoration:none}
.ni.on{color:var(--acc)}
.ni svg{width:20px;height:20px}
.pg{display:none;padding:14px 16px;animation:fi .2s}
.pg.on{display:block}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.sts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.st{background:var(--bg3);border:1px solid var(--brd);border-radius:var(--r);padding:16px;text-align:center}
.st .v{font-size:26px;font-weight:800}.st .l{font-size:11px;color:var(--tx2);margin-top:2px}
.st.red .v{color:var(--acc)}.st.grn .v{color:var(--grn)}.st.ylw .v{color:var(--ylw)}.st.blu .v{color:var(--blu)}
.cd{background:var(--bg3);border:1px solid var(--brd);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:.2s}
.cd:hover{border-color:var(--acc)}
.cr{display:flex;justify-content:space-between;align-items:center}
.ct{font-weight:600;font-size:14px}.cs{color:var(--tx2);font-size:12px;margin-top:3px}
.bg{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.bgr{background:rgba(233,69,96,.12);color:var(--acc)}
.bgg{background:rgba(0,210,160,.12);color:var(--grn)}
.bgy{background:rgba(245,166,35,.12);color:var(--ylw)}
.bgb{background:rgba(78,168,222,.12);color:var(--blu)}
.sh{display:flex;justify-content:space-between;align-items:center;margin:18px 0 10px;font-size:15px;font-weight:600}
.sh a{color:var(--acc);font-size:12px;cursor:pointer;text-decoration:none}
.btn{display:inline-flex;align-items:center;gap:6px;padding:11px 18px;border:none;border-radius:var(--rs);font-size:13px;font-weight:600;cursor:pointer;transition:.2s}
.bp{background:var(--acc);color:#fff}.bp:hover{background:var(--acc2)}
.bg2{background:var(--grn);color:#fff}
.bo{background:transparent;border:1px solid var(--brd);color:var(--txt)}.bo:hover{border-color:var(--acc);color:var(--acc)}
.bd{background:var(--acc);color:#fff}
.bw{width:100%;justify-content:center}
.bs{padding:7px 12px;font-size:12px}
.fab{position:fixed;bottom:86px;left:18px;width:52px;height:52px;background:linear-gradient(135deg,var(--acc),var(--acc2));border:none;border-radius:50%;color:#fff;font-size:26px;cursor:pointer;box-shadow:0 4px 20px rgba(233,69,96,.35);z-index:150;display:flex;align-items:center;justify-content:center;transition:.15s}
.fab:active{transform:scale(.9)}
.mbg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.65);z-index:300;align-items:flex-end;justify-content:center}
.mbg.on{display:flex}
.mdl{background:var(--bg2);border-radius:18px 18px 0 0;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;padding:22px 18px 36px;animation:su .25s}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mdl h3{font-size:18px;font-weight:700;margin-bottom:18px;text-align:center}
.fg{margin-bottom:14px}
.fg label{display:block;font-size:12px;font-weight:500;color:var(--tx2);margin-bottom:5px}
.rq{color:var(--acc)}
.fc{width:100%;padding:11px 13px;background:var(--bg1);border:1px solid var(--brd);border-radius:var(--rs);color:var(--txt);font-size:13px;outline:none;transition:.2s}
.fc:focus{border-color:var(--acc)}
select.fc{appearance:none;cursor:pointer}
textarea.fc{resize:vertical;min-height:70px}
.sch{position:relative;margin-bottom:14px}
.sch input{width:100%;padding:11px 14px 11px 38px;background:var(--bg3);border:1px solid var(--brd);border-radius:var(--r);color:var(--txt);font-size:13px;outline:none}
.sch svg{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--tx3);width:16px;height:16px}
.dtabs{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.dtab{padding:9px 14px;border-radius:var(--rs);background:var(--bg3);border:1px solid var(--brd);font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;transition:.2s;color:var(--tx2)}
.dtab.on{background:var(--acc);color:#fff;border-color:var(--acc)}
.al{background:rgba(233,69,96,.08);border:1px solid rgba(233,69,96,.25);border-radius:var(--rs);padding:10px 14px;margin-bottom:10px;font-size:12px;color:var(--acc);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.al svg{width:16px;height:16px;flex-shrink:0}
.hi{background:var(--bg3);border:1px solid var(--brd);border-radius:var(--r);padding:12px 14px;margin-bottom:8px}
.hi.hg{border-right:4px solid var(--grn)}.hi.hr{border-right:4px solid var(--acc)}
.hi .ha{font-size:16px;font-weight:700}.hi .hd{color:var(--tx2);font-size:12px;margin-top:3px}
.emp{text-align:center;padding:36px 20px;color:var(--tx3)}.emp p{font-size:13px;margin-top:8px}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
.chip{padding:7px 13px;border-radius:20px;border:1px solid var(--brd);background:var(--bg3);font-size:12px;cursor:pointer;transition:.2s;color:var(--tx2)}
.chip.on{border-color:var(--acc);color:var(--acc);background:rgba(233,69,96,.08)}
.cbg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.65);z-index:400;align-items:center;justify-content:center}
.cbg.on{display:flex}
.cfm{background:var(--bg2);border:1px solid var(--brd);border-radius:var(--r);padding:28px 22px;width:90%;max-width:340px;text-align:center}
.cfm p{margin-bottom:18px;font-size:14px;line-height:1.6}
.cfm .cbb{display:flex;gap:10px}
.cfm .cbb button{flex:1}
.tst{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--brd);border-radius:var(--rs);padding:12px 22px;font-size:13px;z-index:500;box-shadow:0 4px 24px rgba(0,0,0,.3);animation:ti .25s;white-space:nowrap}
.tst.tok{border-color:var(--grn);color:var(--grn)}
.tst.ter{border-color:var(--acc);color:var(--acc)}
@keyframes ti{from{opacity:0;transform:translateX(-50%) translateY(-16px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@media(min-width:600px){.sts{grid-template-columns:repeat(4,1fr)}}
</style>
</head>
<body>
<div id="loginScreen"><div class="lbox"><div class="llogo">C</div><h1>CRM ×× ×”×œ ×©×˜×—</h1><p>××¢×¨×›×ª × ×™×”×•×œ ×œ×§×•×—×•×ª ×•×¦×™×•×“</p><input type="text" id="lu" placeholder="×©× ××©×ª××©"><input type="password" id="lp" placeholder="×¡×™×¡××"><button onclick="doLogin()">×›× ×™×¡×” ×œ××¢×¨×›×ª</button></div></div>

<div id="app">
<div class="tbar"><h2 id="ptitle">×¨××©×™</h2><div class="tbar-b"><button onclick="exportRoutes()">ğŸ“Š ×§×•×•×™×</button><button onclick="document.getElementById('csvIn').click()">ğŸ“¥ CSV</button><button onclick="doLogout()">×™×¦×™××”</button></div><input type="file" id="csvIn" accept=".csv" style="display:none" onchange="importCSV(event)"></div>

<div class="pg on" id="pg-home">
<div class="sts"><div class="st red"><div class="v" id="s1">0</div><div class="l">×œ×§×•×—×•×ª ×¤×¢×™×œ×™×</div></div><div class="st ylw"><div class="v" id="s2">â‚ª0</div><div class="l">×¡×”"×› ×—×•×‘×•×ª</div></div><div class="st grn"><div class="v" id="s3">â‚ª0</div><div class="l">×’×‘×™×™×” ×”×—×•×“×©</div></div><div class="st blu"><div class="v" id="s4">0</div><div class="l">×¦×™×•×“ ×‘×©×˜×—</div></div></div>
<div id="hAlerts"></div>
<div class="sh">×—×•×‘×•×ª ×“×—×•×¤×™× <a onclick="nav('collect')">×”×›×œ â†</a></div><div id="hUrg"></div>
<div class="sh">×œ×§×•×—×•×ª ××—×¨×•× ×™× <a onclick="nav('clients')">×”×›×œ â†</a></div><div id="hRec"></div>
</div>

<div class="pg" id="pg-clients"><div class="sch"><input placeholder="×—×™×¤×•×© ×œ×§×•×—..." oninput="rClients(this.value)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div><div class="chips" id="cdf"></div><div id="cList"></div></div>

<div class="pg" id="pg-equip"><div class="sch"><input placeholder="×—×™×¤×•×© ×¦×™×•×“..." oninput="rEquip(this.value)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div><div id="eList"></div></div>

<div class="pg" id="pg-collect"><div class="sch"><input placeholder="×—×™×¤×•×©..." oninput="rCollect(this.value)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div><div id="coList"></div></div>

<div class="pg" id="pg-history"><div class="sch"><input placeholder="×—×™×¤×•×© ×‘×”×™×¡×˜×•×¨×™×”..." oninput="rHistory(this.value)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div><div id="hiList"></div></div>

<div class="pg" id="pg-routes"><div class="dtabs" id="rTabs"></div><div id="rAlerts"></div><div id="rList"></div></div>

<button class="fab" onclick="openNewClient()">+</button>

<div class="bnav">
<div class="ni on" onclick="nav('home')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>×¨××©×™</div>
<div class="ni" onclick="nav('clients')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>×œ×§×•×—×•×ª</div>
<div class="ni" onclick="nav('equip')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>×¦×™×•×“</div>
<div class="ni" onclick="nav('collect')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>×’×‘×™×™×”</div>
<div class="ni" onclick="nav('history')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>×”×™×¡×˜×•×¨×™×”</div>
<div class="ni" onclick="nav('routes')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>×œ×•×— ×§×•×•×™×</div>
</div>
</div>

<!-- Client Modal -->

<div class="mbg" id="mClient"><div class="mdl"><h3 id="mcT">×œ×§×•×— ×—×“×©</h3><input type="hidden" id="ecId">
<div class="fg"><label>×©× ×¢×¡×§ <span class="rq">*</span></label><input class="fc" id="cN"></div>
<div class="fg"><label>×©× ××™×© ×§×©×¨ <span class="rq">*</span></label><input class="fc" id="cC"></div>
<div class="fg"><label>×˜×œ×¤×•×Ÿ</label><input class="fc" id="cP" type="tel"></div>
<div class="fg"><label>×¢×™×¨ <span class="rq">*</span></label><input class="fc" id="cCi"></div>
<div class="fg"><label>×›×ª×•×‘×ª</label><input class="fc" id="cA"></div>
<div class="fg"><label>×ª× ××™ ×ª×©×œ×•× <span class="rq">*</span></label><select class="fc" id="cPT"><option value="">×‘×—×¨</option><option>×©×•×˜×£</option><option>×©×•×˜×£+30</option><option>×©×•×˜×£+60</option><option>×©×•×˜×£+90</option><option>××–×•××Ÿ</option></select></div>
<div class="fg"><label>×ª×“×™×¨×•×ª ×›× ×™×¡×” <span class="rq">*</span></label><select class="fc" id="cVF"><option value="">×‘×—×¨</option><option value="×©×‘×•×¢×™">×¤×¢× ×‘×©×‘×•×¢</option><option value="×“×•-×©×‘×•×¢×™">×¤×¢× ×‘×©×‘×•×¢×™×™×</option><option value="×—×•×“×©×™">×¤×¢× ×‘×—×•×“×©</option></select></div>
<div class="fg"><label>×™×•× ×›× ×™×¡×” <span class="rq">*</span></label><select class="fc" id="cVD"><option value="">×‘×—×¨</option><option>×¨××©×•×Ÿ</option><option>×©× ×™</option><option>×©×œ×™×©×™</option><option>×¨×‘×™×¢×™</option><option>×—××™×©×™</option></select></div>
<div class="fg"><label>×ª×“×™×¨×•×ª ×ª××•× ×•×ª <span class="rq">*</span></label><select class="fc" id="cPF"><option value="">×‘×—×¨</option><option value="×©×‘×•×¢×™">×©×‘×•×¢×™</option><option value="×“×•-×©×‘×•×¢×™">×“×•-×©×‘×•×¢×™</option><option value="×—×•×“×©×™">×—×•×“×©×™</option></select></div>
<div class="fg"><label>×”×¢×¨×•×ª</label><textarea class="fc" id="cNo"></textarea></div>
<button class="btn bp bw" onclick="saveClient()" style="margin-top:8px">ğŸ’¾ ×©××™×¨×”</button>
<button class="btn bo bw" onclick="cm('mClient')" style="margin-top:8px">×‘×™×˜×•×œ</button>
</div></div>

<!-- Client Detail -->

<div class="mbg" id="mDetail"><div class="mdl" id="detC"></div></div>

<!-- Payment -->

<div class="mbg" id="mPay"><div class="mdl"><h3>×¨×™×©×•× ×ª×©×œ×•×</h3><input type="hidden" id="pyCI">
<div class="fg"><label>×‘×—×™×¨×ª ××¡××›×™× ×œ×¡×’×™×¨×” <span class="rq">*</span></label><div id="pyDocs"></div></div>
<div class="fg"><label>×¡×›×•× <span class="rq">*</span></label><input class="fc" id="pyAm" type="number"></div>
<div class="fg"><label>×××¦×¢×™ ×ª×©×œ×•× <span class="rq">*</span></label><select class="fc" id="pyMe" onchange="pyMC()"><option value="">×‘×—×¨</option><option>××–×•××Ÿ</option><option>×”×¢×‘×¨×”</option><option>×©×™×§</option><option>×–×™×›×•×™</option></select></div>
<div class="fg" id="pyChk" style="display:none"><label>××¡×¤×¨ ×©×™×§ <span class="rq">*</span></label><input class="fc" id="pyCN"><label style="margin-top:10px;display:block">×ª××¨×™×š ×©×™×§ <span class="rq">*</span></label><input class="fc" id="pyCD" type="date"></div>
<div class="fg" id="pyCrd" style="display:none"><label>××¡×¤×¨ ××¡××š ×–×™×›×•×™ <span class="rq">*</span></label><input class="fc" id="pyCrN"></div>
<div class="fg"><label>×ª××¨×™×š ×ª×©×œ×•×</label><input class="fc" id="pyDt" type="date"></div>
<div class="fg"><label>×”×¢×¨×” <span class="rq">*</span></label><textarea class="fc" id="pyNo" placeholder="×—×•×‘×”"></textarea></div>
<button class="btn bg2 bw" onclick="savePay()">ğŸ’° ×¨×™×©×•× ×ª×©×œ×•×</button>
<button class="btn bo bw" onclick="cm('mPay')" style="margin-top:8px">×‘×™×˜×•×œ</button>
</div></div>

<!-- Document -->

<div class="mbg" id="mDoc"><div class="mdl"><h3>×”×•×¡×¤×ª ××¡××š ×—×•×‘</h3><input type="hidden" id="dcCI">
<div class="fg"><label>×¡×•×’ ××¡××š <span class="rq">*</span></label><select class="fc" id="dcTy"><option>×—×©×‘×•× ×™×ª</option><option>×ª×¢×•×“×ª ××©×œ×•×—</option><option>×–×™×›×•×™</option></select></div>
<div class="fg"><label>××¡×¤×¨ ××¡××š <span class="rq">*</span></label><input class="fc" id="dcNu"></div>
<div class="fg"><label>×¡×›×•× <span class="rq">*</span></label><input class="fc" id="dcAm" type="number"></div>
<div class="fg"><label>×ª××¨×™×š ××¡××š</label><input class="fc" id="dcDt" type="date"></div>
<div class="fg"><label>×”×¢×¨×”</label><textarea class="fc" id="dcNo"></textarea></div>
<button class="btn bp bw" onclick="saveDoc()">ğŸ“„ ×”×•×¡×¤×ª ××¡××š</button>
<button class="btn bo bw" onclick="cm('mDoc')" style="margin-top:8px">×‘×™×˜×•×œ</button>
</div></div>

<!-- Equipment -->

<div class="mbg" id="mEq"><div class="mdl"><h3 id="meT">×¦×™×•×“ ×—×“×©</h3><input type="hidden" id="eqEI">
<div class="fg"><label>×œ×§×•×— <span class="rq">*</span></label><select class="fc" id="eqCl"></select></div>
<div class="fg"><label>×¡×•×’ ×¦×™×•×“ <span class="rq">*</span></label><select class="fc" id="eqTy"><option value="">×‘×—×¨</option><option>××§×¤×™× ×¢×•××“</option><option>××§×¤×™× ×©×•×›×‘</option><option>××§×¨×¨</option><option>××“×£</option><option>××—×¨</option></select></div>
<div class="fg"><label>××¡×¤×¨ ×¡×™×“×•×¨×™ <span class="rq">*</span></label><input class="fc" id="eqSe"></div>
<div class="fg"><label>××¦×‘</label><select class="fc" id="eqSt"><option>×ª×§×™×Ÿ</option><option>×“×•×¨×© ×ª×™×§×•×Ÿ</option><option>×”×•×—×–×¨</option></select></div>
<div class="fg"><label>×”×¢×¨×•×ª</label><textarea class="fc" id="eqNo"></textarea></div>
<button class="btn bp bw" onclick="saveEq()">ğŸ’¾ ×©××™×¨×”</button>
<button class="btn bo bw" onclick="cm('mEq')" style="margin-top:8px">×‘×™×˜×•×œ</button>
</div></div>

<!-- Visit -->

<div class="mbg" id="mVisit"><div class="mdl"><h3 id="mvT">×¢×“×›×•×Ÿ ×‘×™×§×•×¨</h3><input type="hidden" id="mvCI"><div id="mvC"></div></div></div>

<!-- Confirm -->

<div class="cbg" id="cfD"><div class="cfm"><p id="cfM"></p><div class="cbb"><button class="btn bp" id="cfY">××™×©×•×¨</button><button class="btn bo" onclick="ccf()">×‘×™×˜×•×œ</button></div></div></div>

<script>
const K='crm_v3';
const DAYS=['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™'];
function ld(){try{return JSON.parse(localStorage.getItem(K))||dd();}catch(e){return dd();}}
function sv(d){localStorage.setItem(K,JSON.stringify(d));}
function dd(){return{clients:[],equipment:[],payments:[],documents:[],visits:[],nid:1};}
function gid(){let d=ld();let i=d.nid||1;d.nid=i+1;sv(d);return i;}
function td(){return new Date().toISOString().split('T')[0];}
function fd(d){if(!d)return'';let p=d.split('-');return p[2]+'/'+p[1]+'/'+p[0];}
function fm(n){return'â‚ª'+Number(n||0).toLocaleString();}
function hday(){let j=new Date().getDay();return j>=0&&j<=4?DAYS[j]:null;}
function esc(s){let d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

// Auth
function doLogin(){let u=document.getElementById('lu').value.trim(),p=document.getElementById('lp').value.trim();if(!u||!p){tst('× × ×œ××œ× ×©× ×•×¡×™×¡××',1);return;}localStorage.setItem('crm_u',u);document.getElementById('loginScreen').style.display='none';document.getElementById('app').classList.add('on');ra();}
function doLogout(){localStorage.removeItem('crm_u');location.reload();}
function chkA(){if(localStorage.getItem('crm_u')){document.getElementById('loginScreen').style.display='none';document.getElementById('app').classList.add('on');ra();}}

// Nav
let cp='home';
function nav(p){cp=p;document.querySelectorAll('.pg').forEach(x=>x.classList.remove('on'));document.getElementById('pg-'+p).classList.add('on');let ni=document.querySelectorAll('.ni');let ps=['home','clients','equip','collect','history','routes'];ni.forEach((n,i)=>n.classList.toggle('on',ps[i]===p));let t={home:'×¨××©×™',clients:'×œ×§×•×—×•×ª',equip:'×¦×™×•×“',collect:'×’×‘×™×™×”',history:'×”×™×¡×˜×•×¨×™×”',routes:'×œ×•×— ×§×•×•×™×'};document.getElementById('ptitle').textContent=t[p]||'';rp(p);}
function ra(){rp('home');}
function rp(p){if(p==='home')rHome();if(p==='clients')rClients();if(p==='equip')rEquip();if(p==='collect')rCollect();if(p==='history')rHistory();if(p==='routes')rRoutes();}

// Debt calc
function gDebt(cid,d){if(!d)d=ld();let docs=d.documents.filter(x=>x.cid===cid&&!x.closed);let t=0;docs.forEach(x=>{t+=x.type==='×–×™×›×•×™'?-Number(x.amount||0):Number(x.amount||0);});return Math.max(0,t);}

// Visit alerts
function vAlerts(d){let al=[];let hd=hday();if(!hd)return al;d.clients.filter(c=>!c.del).forEach(c=>{if(c.vday!==hd)return;let ws=new Date();ws.setDate(ws.getDate()-ws.getDay());let wss=ws.toISOString().split('T')[0];if(!d.visits.some(v=>v.cid===c.id&&v.date>=wss&&v.type==='×‘×™×§×•×¨'))al.push({msg:'×—×•×‘×ª ×‘×™×§×•×¨ ×”×™×•×: <b>'+esc(c.name)+'</b> - '+esc(c.city||''),cid:c.id});});return al;}

// HOME
function rHome(){let d=ld(),ac=d.clients.filter(c=>!c.del);document.getElementById('s1').textContent=ac.length;let td2=0;ac.forEach(c=>td2+=gDebt(c.id,d));document.getElementById('s2').textContent=fm(td2);let n=new Date(),tm=n.getFullYear()+'-'+String(n.getMonth()+1).padStart(2,'0');let col=d.payments.filter(p=>p.date&&p.date.startsWith(tm)).reduce((s,p)=>s+Number(p.amount||0),0);document.getElementById('s3').textContent=fm(col);document.getElementById('s4').textContent=d.equipment.filter(e=>e.status!=='×”×•×—×–×¨').length;
let als=vAlerts(d),ah='';als.forEach(a=>{ah+='<div class="al"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'+a.msg+'</div>';});document.getElementById('hAlerts').innerHTML=ah;
let urg=ac.filter(c=>gDebt(c.id,d)>0).sort((a,b)=>gDebt(b.id,d)-gDebt(a.id,d)).slice(0,5),uh='';if(!urg.length)uh='<div class="emp"><p>××™×Ÿ ×—×•×‘×•×ª ×“×—×•×¤×™× ğŸ‰</p></div>';urg.forEach(c=>{let db=gDebt(c.id,d);uh+='<div class="cd" onclick="openDet('+c.id+')"><div class="cr"><div><div class="ct">'+esc(c.name)+'</div><div class="cs">'+esc(c.city||'')+'</div></div><span class="bg bgr">'+fm(db)+'</span></div></div>';});document.getElementById('hUrg').innerHTML=uh;
let rec=[...ac].sort((a,b)=>(b.id||0)-(a.id||0)).slice(0,5),rh='';rec.forEach(c=>{rh+='<div class="cd" onclick="openDet('+c.id+')"><div class="cr"><div><div class="ct">'+esc(c.name)+'</div><div class="cs">'+esc(c.contact||'')+' | '+esc(c.city||'')+'</div></div><span class="bg bgb">'+esc(c.vday||'')+'</span></div></div>';});document.getElementById('hRec').innerHTML=rh||'<div class="emp"><p>××™×Ÿ ×œ×§×•×—×•×ª</p></div>';}

// CLIENTS
let cdf='';
function rClients(s){let d=ld(),cl=d.clients.filter(c=>!c.del);let ch='<span class="chip '+(cdf===''?'on':'')+'" onclick="cdf=\'\';rClients()">×”×›×œ</span>';DAYS.forEach(dy=>{ch+='<span class="chip '+(cdf===dy?'on':'')+'" onclick="cdf=\''+dy+'\';rClients()">'+dy+'</span>';});document.getElementById('cdf').innerHTML=ch;if(cdf)cl=cl.filter(c=>c.vday===cdf);if(s)cl=cl.filter(c=>(c.name||'').includes(s)||(c.city||'').includes(s)||(c.contact||'').includes(s)||(c.phone||'').includes(s));let h='';if(!cl.length)h='<div class="emp"><p>×œ× × ××¦××• ×œ×§×•×—×•×ª</p></div>';cl.forEach(c=>{let db=gDebt(c.id,d),badge=db>0?'<span class="bg bgr">'+fm(db)+'</span>':'<span class="bg bgg">×××•×–×Ÿ</span>';h+='<div class="cd" onclick="openDet('+c.id+')"><div class="cr"><div><div class="ct">'+esc(c.name)+'</div><div class="cs">'+esc(c.contact||'')+' | '+esc(c.city||'')+' | '+esc(c.vday||'')+' ('+esc(c.vfreq||'')+')</div></div>'+badge+'</div></div>';});document.getElementById('cList').innerHTML=h;}

// Client modal
function openNewClient(){document.getElementById('mcT').textContent='×œ×§×•×— ×—×“×©';document.getElementById('ecId').value='';['cN','cC','cP','cCi','cA','cNo'].forEach(i=>document.getElementById(i).value='');['cPT','cVF','cVD','cPF'].forEach(i=>document.getElementById(i).value='');om('mClient');}
function openEditC(id){let d=ld(),c=d.clients.find(x=>x.id===id);if(!c)return;document.getElementById('mcT').textContent='×¢×¨×™×›×ª ×œ×§×•×—';document.getElementById('ecId').value=id;document.getElementById('cN').value=c.name||'';document.getElementById('cC').value=c.contact||'';document.getElementById('cP').value=c.phone||'';document.getElementById('cCi').value=c.city||'';document.getElementById('cA').value=c.address||'';document.getElementById('cPT').value=c.pterms||'';document.getElementById('cVF').value=c.vfreq||'';document.getElementById('cVD').value=c.vday||'';document.getElementById('cPF').value=c.pfreq||'';document.getElementById('cNo').value=c.notes||'';om('mClient');}

function saveClient(){let nm=gi('cN'),co=gi('cC'),ci=gi('cCi'),pt=gi('cPT'),vf=gi('cVF'),vd=gi('cVD'),pf=gi('cPF');let er=[];if(!nm)er.push('×©× ×¢×¡×§');if(!co)er.push('××™×© ×§×©×¨');if(!ci)er.push('×¢×™×¨');if(!pt)er.push('×ª× ××™ ×ª×©×œ×•×');if(!vf)er.push('×ª×“×™×¨×•×ª ×›× ×™×¡×”');if(!vd)er.push('×™×•× ×›× ×™×¡×”');if(!pf)er.push('×ª×“×™×¨×•×ª ×ª××•× ×•×ª');if(er.length){tst('×—×¡×¨: '+er.join(', '),1);return;}let d=ld(),eid=document.getElementById('ecId').value;if(eid){let c=d.clients.find(x=>x.id===Number(eid));if(c){c.name=nm;c.contact=co;c.phone=gi('cP');c.city=ci;c.address=gi('cA');c.pterms=pt;c.vfreq=vf;c.vday=vd;c.pfreq=pf;c.notes=gi('cNo');c.upd=td();}}else{d.clients.push({id:gid(),name:nm,contact:co,phone:gi('cP'),city:ci,address:gi('cA'),pterms:pt,vfreq:vf,vday:vd,pfreq:pf,notes:gi('cNo'),cre:td(),del:false});}sv(d);cm('mClient');tst(eid?'×œ×§×•×— ×¢×•×“×›×Ÿ':'×œ×§×•×— × ×•×¡×£');rp(cp);}
function gi(id){return document.getElementById(id).value.trim();}

function delClient(id){scf('×”×× ×œ××—×•×§ ××ª ×”×œ×§×•×—?',()=>{let d=ld(),c=d.clients.find(x=>x.id===id);if(c)c.del=true;sv(d);cm('mDetail');tst('×œ×§×•×— × ××—×§');rp(cp);});}

// Client Detail
function openDet(id){let d=ld(),c=d.clients.find(x=>x.id===id);if(!c)return;let db=gDebt(id,d),docs=d.documents.filter(x=>x.cid===id),od=docs.filter(x=>!x.closed),cd2=docs.filter(x=>x.closed),pays=d.payments.filter(x=>x.cid===id),eqs=d.equipment.filter(x=>x.cid===id&&x.status!=='×”×•×—×–×¨');
let h='<h3>'+esc(c.name)+'</h3><div style="text-align:center;margin-bottom:16px"><span class="bg '+(db>0?'bgr':'bgg')+'" style="font-size:16px;padding:6px 16px">'+(db>0?'×—×•×‘: '+fm(db):'×××•×–×Ÿ')+'</span></div>';
h+='<div style="background:var(--bg1);border-radius:var(--rs);padding:12px;margin-bottom:14px;font-size:13px;line-height:2"><div><b>××™×© ×§×©×¨:</b> '+esc(c.contact||'-')+'</div><div><b>×˜×œ×¤×•×Ÿ:</b> <a href="tel:'+esc(c.phone||'')+'" style="color:var(--blu)">'+esc(c.phone||'-')+'</a></div><div><b>×¢×™×¨:</b> '+esc(c.city||'-')+'</div><div><b>×›×ª×•×‘×ª:</b> '+esc(c.address||'-')+'</div><div><b>×ª× ××™ ×ª×©×œ×•×:</b> '+esc(c.pterms||'-')+'</div><div><b>×ª×“×™×¨×•×ª ×›× ×™×¡×”:</b> '+esc(c.vfreq||'-')+' | ×™×•× '+esc(c.vday||'-')+'</div><div><b>×ª×“×™×¨×•×ª ×ª××•× ×•×ª:</b> '+esc(c.pfreq||'-')+'</div>'+(c.notes?'<div><b>×”×¢×¨×•×ª:</b> '+esc(c.notes)+'</div>':'')+'</div>';
h+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px"><button class="btn bp bs" onclick="cm(\'mDetail\');openEditC('+c.id+')">âœï¸ ×¢×¨×™×›×”</button><button class="btn bg2 bs" onclick="cm(\'mDetail\');openPay('+c.id+')">ğŸ’° ×ª×©×œ×•×</button><button class="btn bo bs" onclick="cm(\'mDetail\');openDocM('+c.id+')">ğŸ“„ ××¡××š</button><button class="btn bo bs" onclick="cm(\'mDetail\');openEqM('+c.id+')">ğŸ“¦ ×¦×™×•×“</button><button class="btn bo bs" onclick="cm(\'mDetail\');openVis('+c.id+')">ğŸ“‹ ×‘×™×§×•×¨</button><button class="btn bd bs" onclick="delClient('+c.id+')">ğŸ—‘ï¸ ××—×™×§×”</button></div>';

if(od.length){h+='<div class="sh" style="margin-top:8px">××¡××›×™× ×¤×ª×•×—×™× ('+od.length+')</div>';od.forEach(x=>{let sg=x.type==='×–×™×›×•×™'?'+':'';let cl=x.type==='×–×™×›×•×™'?'bgg':'bgr';h+='<div class="hi '+(x.type==='×–×™×›×•×™'?'hg':'hr')+'"><div class="cr"><div><div class="ha">'+sg+fm(x.amount)+'</div><div class="hd">'+esc(x.type)+' #'+esc(x.number)+' | '+fd(x.date)+'</div>'+(x.note?'<div class="hd">'+esc(x.note)+'</div>':'')+'</div><span class="bg '+cl+'">'+esc(x.type)+'</span></div></div>';});}
if(cd2.length){h+='<div class="sh" style="margin-top:12px">××¡××›×™× ×©× ×¡×’×¨×• ('+cd2.length+')</div>';cd2.forEach(x=>{h+='<div class="hi hg"><div class="cr"><div><div class="ha" style="color:var(--grn)">'+fm(x.amount)+'</div><div class="hd">'+esc(x.type)+' #'+esc(x.number)+' | '+fd(x.date)+' | × ×¡×’×¨: '+fd(x.clDate||'')+'</div></div><span class="bg bgg">× ×¡×’×¨</span></div></div>';});}
if(pays.length){h+='<div class="sh" style="margin-top:12px">×”×™×¡×˜×•×¨×™×™×ª ×ª×©×œ×•××™× ('+pays.length+')</div>';pays.sort((a,b)=>(b.date||'').localeCompare(a.date||''));pays.forEach(p=>{let ck=p.method==='×©×™×§'?' | ×©×™×§ #'+esc(p.chkNum||'')+' '+fd(p.chkDate||''):'';let cr=p.method==='×–×™×›×•×™'?' | ××¡××š #'+esc(p.crNum||''):'';let dd2=(p.method==='×©×™×§'&&p.chkDate)?p.chkDate:p.date;h+='<div class="hi hg"><div><div class="ha" style="color:var(--grn)">+'+fm(p.amount)+'</div><div class="hd">'+esc(p.method)+' | '+fd(dd2)+ck+cr+'</div><div class="hd">××¡××›×™×: '+(p.docNums||[]).join(', ')+'</div>'+(p.note?'<div class="hd">×”×¢×¨×”: '+esc(p.note)+'</div>':'')+'</div></div>';});}
if(eqs.length){h+='<div class="sh" style="margin-top:12px">×¦×™×•×“ ('+eqs.length+')</div>';eqs.forEach(e=>{h+='<div class="hi"><div class="hd"><b>'+esc(e.type)+'</b> | ×¡×™×“×•×¨×™: '+esc(e.serial)+' | '+esc(e.status)+'</div></div>';});}
h+='<button class="btn bo bw" onclick="cm(\'mDetail\')" style="margin-top:16px">×¡×’×™×¨×”</button>';
document.getElementById('detC').innerHTML=h;om('mDetail');}

// Documents
function openDocM(cid){document.getElementById('dcCI').value=cid;document.getElementById('dcTy').value='×—×©×‘×•× ×™×ª';document.getElementById('dcNu').value='';document.getElementById('dcAm').value='';document.getElementById('dcDt').value=td();document.getElementById('dcNo').value='';om('mDoc');}
function saveDoc(){let cid=Number(gi('dcCI')),ty=gi('dcTy'),nu=gi('dcNu'),am=gi('dcAm'),dt=gi('dcDt'),no=gi('dcNo');if(!nu){tst('××¡×¤×¨ ××¡××š ×—×•×‘×”',1);return;}if(!am||Number(am)<=0){tst('×¡×›×•× ×—×•×‘×”',1);return;}let d=ld();d.documents.push({id:gid(),cid:cid,type:ty,number:nu,amount:Number(am),date:dt||td(),note:no,closed:false,clDate:null});sv(d);cm('mDoc');tst('××¡××š × ×•×¡×£');rp(cp);}

// Payment
function openPay(cid){document.getElementById('pyCI').value=cid;document.getElementById('pyAm').value='';document.getElementById('pyMe').value='';document.getElementById('pyDt').value=td();document.getElementById('pyNo').value='';document.getElementById('pyCN').value='';document.getElementById('pyCD').value='';document.getElementById('pyCrN').value='';document.getElementById('pyChk').style.display='none';document.getElementById('pyCrd').style.display='none';
let d=ld(),od=d.documents.filter(x=>x.cid===cid&&!x.closed),h='';if(!od.length)h='<div class="emp" style="padding:10px"><p>××™×Ÿ ××¡××›×™× ×¤×ª×•×—×™×</p></div>';else od.forEach(x=>{let sg=x.type==='×–×™×›×•×™'?'(×–×™×›×•×™) +':'';h+='<label style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--brd);font-size:13px;cursor:pointer"><input type="checkbox" class="pdc" value="'+x.id+'" data-am="'+x.amount+'" data-ty="'+x.type+'"><span>'+esc(x.type)+' #'+esc(x.number)+' - '+sg+fm(x.amount)+' ('+fd(x.date)+')</span></label>';});
document.getElementById('pyDocs').innerHTML=h;setTimeout(()=>{document.querySelectorAll('.pdc').forEach(cb=>{cb.onchange=()=>{let t=0;document.querySelectorAll('.pdc:checked').forEach(c=>{let a=Number(c.dataset.am);t+=c.dataset.ty==='×–×™×›×•×™'?-a:a;});document.getElementById('pyAm').value=Math.max(0,t);};});},50);om('mPay');}
function pyMC(){let m=gi('pyMe');document.getElementById('pyChk').style.display=m==='×©×™×§'?'block':'none';document.getElementById('pyCrd').style.display=m==='×–×™×›×•×™'?'block':'none';}
function savePay(){let cid=Number(gi('pyCI')),am=gi('pyAm'),me=gi('pyMe'),dt=gi('pyDt')||td(),no=gi('pyNo');let sids=[],snums=[];document.querySelectorAll('.pdc:checked').forEach(cb=>{sids.push(Number(cb.value));let d=ld(),doc=d.documents.find(x=>x.id===Number(cb.value));if(doc)snums.push(doc.number);});
if(!sids.length){tst('×™×© ×œ×‘×—×•×¨ ××¡××›×™×',1);return;}if(!am||Number(am)<=0){tst('×¡×›×•× ×—×•×‘×”',1);return;}if(!me){tst('×××¦×¢×™ ×ª×©×œ×•× ×—×•×‘×”',1);return;}if(!no){tst('×”×¢×¨×” ×—×•×‘×” ×‘×›×œ ×ª×©×œ×•×',1);return;}
if(me==='×©×™×§'){if(!gi('pyCN')){tst('××¡×¤×¨ ×©×™×§ ×—×•×‘×”',1);return;}if(!gi('pyCD')){tst('×ª××¨×™×š ×©×™×§ ×—×•×‘×”',1);return;}}
if(me==='×–×™×›×•×™'&&!gi('pyCrN')){tst('××¡×¤×¨ ××¡××š ×–×™×›×•×™ ×—×•×‘×”',1);return;}
let d=ld();sids.forEach(did=>{let doc=d.documents.find(x=>x.id===did);if(doc){doc.closed=true;doc.clDate=td();}});
let pay={id:gid(),cid:cid,amount:Number(am),method:me,date:dt,note:no,docIds:sids,docNums:snums,cre:td()};
if(me==='×©×™×§'){pay.chkNum=gi('pyCN');pay.chkDate=gi('pyCD');}
if(me==='×–×™×›×•×™'){pay.crNum=gi('pyCrN');}
d.payments.push(pay);sv(d);cm('mPay');tst('×ª×©×œ×•× × ×¨×©× - ××¡××›×™× × ×¡×’×¨×•');rp(cp);}

// Equipment
function rEquip(s){let d=ld(),eq=d.equipment.filter(e=>e.status!=='×”×•×—×–×¨');if(s)eq=eq.filter(e=>{let c=d.clients.find(x=>x.id===e.cid);return(e.type||'').includes(s)||(e.serial||'').includes(s)||(c?c.name:'').includes(s);});let h='';if(!eq.length)h='<div class="emp"><p>××™×Ÿ ×¦×™×•×“</p></div>';eq.forEach(e=>{let c=d.clients.find(x=>x.id===e.cid);let sb=e.status==='×ª×§×™×Ÿ'?'bgg':'bgy';h+='<div class="cd"><div class="cr"><div><div class="ct">'+esc(e.type)+' - '+esc(e.serial)+'</div><div class="cs">'+esc(c?c.name:'×œ× ××©×•×™×š')+'</div></div><span class="bg '+sb+'">'+esc(e.status)+'</span></div></div>';});document.getElementById('eList').innerHTML=h;}
function openEqM(cid){document.getElementById('meT').textContent='×¦×™×•×“ ×—×“×©';document.getElementById('eqEI').value='';document.getElementById('eqSe').value='';document.getElementById('eqTy').value='';document.getElementById('eqSt').value='×ª×§×™×Ÿ';document.getElementById('eqNo').value='';let d=ld(),o='<option value="">×‘×—×¨ ×œ×§×•×—</option>';d.clients.filter(c=>!c.del).forEach(c=>{o+='<option value="'+c.id+'"'+(c.id===cid?' selected':'')+'>'+esc(c.name)+'</option>';});document.getElementById('eqCl').innerHTML=o;om('mEq');}
function saveEq(){let cid=Number(gi('eqCl')),ty=gi('eqTy'),se=gi('eqSe'),st=gi('eqSt'),no=gi('eqNo');if(!cid){tst('×™×© ×œ×‘×—×•×¨ ×œ×§×•×—',1);return;}if(!ty){tst('×¡×•×’ ×¦×™×•×“ ×—×•×‘×”',1);return;}if(!se){tst('××¡×¤×¨ ×¡×™×“×•×¨×™ ×—×•×‘×”',1);return;}let d=ld();d.equipment.push({id:gid(),cid:cid,type:ty,serial:se,status:st,notes:no,cre:td()});sv(d);cm('mEq');tst('×¦×™×•×“ × ×•×¡×£');rp(cp);}

// Collection
function rCollect(s){let d=ld(),cl=d.clients.filter(c=>!c.del),li=[];cl.forEach(c=>{let db=gDebt(c.id,d);if(db>0)li.push({...c,debt:db});});li.sort((a,b)=>b.debt-a.debt);if(s)li=li.filter(c=>(c.name||'').includes(s)||(c.city||'').includes(s));let h='';if(!li.length)h='<div class="emp"><p>××™×Ÿ ×—×•×‘×•×ª ×¤×ª×•×—×™× ğŸ‰</p></div>';li.forEach(c=>{h+='<div class="cd" onclick="openDet('+c.id+')"><div class="cr"><div><div class="ct">'+esc(c.name)+'</div><div class="cs">'+esc(c.city||'')+' | '+esc(c.pterms||'')+'</div></div><div style="text-align:left"><span class="bg bgr">'+fm(c.debt)+'</span><br><button class="btn bg2 bs" style="margin-top:6px" onclick="event.stopPropagation();openPay('+c.id+')">ğŸ’° ×ª×©×œ×•×</button></div></div></div>';});document.getElementById('coList').innerHTML=h;}

// History
function rHistory(s){let d=ld(),it=[];d.payments.forEach(p=>{let c=d.clients.find(x=>x.id===p.cid);let dd2=(p.method==='×©×™×§'&&p.chkDate)?p.chkDate:p.date;it.push({tp:'pay',date:dd2,cn:c?c.name:'',am:p.amount,me:p.method,no:p.note,chkNum:p.chkNum,chkDate:p.chkDate,crNum:p.crNum,docNums:p.docNums||[]});});
d.documents.forEach(x=>{let c=d.clients.find(z=>z.id===x.cid);it.push({tp:x.type==='×–×™×›×•×™'?'cred':'doc',date:x.date,cn:c?c.name:'',am:x.amount,dty:x.type,dnu:x.number,cl:x.closed,clDt:x.clDate,no:x.note});});
it.sort((a,b)=>(b.date||'').localeCompare(a.date||''));if(s)it=it.filter(i=>(i.cn||'').includes(s)||(i.no||'').includes(s));
let h='';if(!it.length)h='<div class="emp"><p>××™×Ÿ ×”×™×¡×˜×•×¨×™×”</p></div>';it.forEach(i=>{if(i.tp==='pay'){let ck=i.me==='×©×™×§'?' | ×©×™×§ #'+esc(i.chkNum||''):'';let cr=i.me==='×–×™×›×•×™'?' | ××¡××š #'+esc(i.crNum||''):'';h+='<div class="hi hg"><div class="cr"><div><div class="ha" style="color:var(--grn)">+'+fm(i.am)+'</div><div class="hd">'+esc(i.cn)+' | '+esc(i.me)+ck+cr+' | '+fd(i.date)+'</div><div class="hd">××¡××›×™× ×©× ×¡×’×¨×•: '+(i.docNums||[]).join(', ')+'</div>'+(i.no?'<div class="hd">'+esc(i.no)+'</div>':'')+'</div><span class="bg bgg">×ª×©×œ×•×</span></div></div>';}else{let sg=i.tp==='cred'?'+':'-';let cls=i.cl?'hg':'hr';let bdg=i.cl?'<span class="bg bgg">× ×¡×’×¨</span>':'<span class="bg bgr">'+esc(i.dty||'')+'</span>';h+='<div class="hi '+cls+'"><div class="cr"><div><div class="ha">'+sg+fm(i.am)+'</div><div class="hd">'+esc(i.cn)+' | '+esc(i.dty||'')+' #'+esc(i.dnu||'')+' | '+fd(i.date)+'</div>'+(i.cl?'<div class="hd">× ×¡×’×¨: '+fd(i.clDt||'')+'</div>':'')+(i.no?'<div class="hd">'+esc(i.no)+'</div>':'')+'</div>'+bdg+'</div></div>';}});document.getElementById('hiList').innerHTML=h;}

// Routes
let rsd=null;
function rRoutes(){let d=ld();if(!rsd)rsd=hday()||'×¨××©×•×Ÿ';let th='';DAYS.forEach(dy=>{th+='<div class="dtab '+(rsd===dy?'on':'')+'" onclick="rsd=\''+dy+'\';rRoutes()">'+dy+'</div>';});document.getElementById('rTabs').innerHTML=th;
let cl=d.clients.filter(c=>!c.del&&c.vday===rsd),ah='';if(rsd===hday()){cl.forEach(c=>{let ws=new Date();ws.setDate(ws.getDate()-ws.getDay());let wss=ws.toISOString().split('T')[0];if(!d.visits.some(v=>v.cid===c.id&&v.date>=wss&&v.type==='×‘×™×§×•×¨'))ah+='<div class="al"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>×—×•×‘×ª ×‘×™×§×•×¨: <b>'+esc(c.name)+'</b> <button class="btn bs bp" style="margin-right:auto;margin-left:8px" onclick="openVis('+c.id+')">×¢×“×›×Ÿ</button></div>';});}document.getElementById('rAlerts').innerHTML=ah;
let h='';if(!cl.length)h='<div class="emp"><p>××™×Ÿ ×œ×§×•×—×•×ª ×‘×™×•× '+rsd+'</p></div>';cl.forEach(c=>{let db=gDebt(c.id,d);let lv=d.visits.filter(v=>v.cid===c.id).sort((a,b)=>(b.date||'').localeCompare(a.date||'')).shift();let lvs=lv?fd(lv.date)+(lv.type==='×¡×™×‘×”'?' (×œ× ×‘×•×¦×¢)':''):'×˜×¨× ×‘×•×§×¨';h+='<div class="cd" onclick="openDet('+c.id+')"><div class="cr"><div><div class="ct">'+esc(c.name)+'</div><div class="cs">'+esc(c.city||'')+' | '+esc(c.vfreq||'')+' | ××—×¨×•×Ÿ: '+lvs+'</div></div>'+(db>0?'<span class="bg bgr">'+fm(db)+'</span>':'<span class="bg bgg">×××•×–×Ÿ</span>')+'</div></div>';});document.getElementById('rList').innerHTML=h;}

// Visit
function openVis(cid){let d=ld(),c=d.clients.find(x=>x.id===cid);if(!c)return;document.getElementById('mvT').textContent='×¢×“×›×•×Ÿ ×‘×™×§×•×¨ - '+c.name;document.getElementById('mvCI').value=cid;
document.getElementById('mvC').innerHTML='<p style="font-size:13px;color:var(--tx2);margin-bottom:14px;text-align:center">×”×× ×‘×™×¦×¢×ª ×‘×™×§×•×¨ ××¦×œ ×”×œ×§×•×—?</p><div style="display:flex;gap:10px;margin-bottom:16px"><button class="btn bg2" style="flex:1" onclick="recVis('+cid+',true)">âœ… ×›×Ÿ, ×‘×™×§×¨×ª×™</button><button class="btn bd" style="flex:1" onclick="showNVR('+cid+')">âŒ ×œ× ×‘×™×§×¨×ª×™</button></div><div id="nvr" style="display:none"><div class="fg"><label>×¡×™×‘×” ×œ××™ ×‘×™×§×•×¨ <span class="rq">*</span></label><textarea class="fc" id="vreason" placeholder="×—×•×‘×” ×œ×¦×™×™×Ÿ ×¡×™×‘×”"></textarea></div><button class="btn bp bw" onclick="recVis('+cid+',false)">×©××™×¨×”</button></div><button class="btn bo bw" onclick="cm(\'mVisit\')" style="margin-top:8px">×‘×™×˜×•×œ</button>';

om(â€˜mVisitâ€™);}
function showNVR(){document.getElementById(â€˜nvrâ€™).style.display=â€˜blockâ€™;}
function recVis(cid,did){if(!did){let r=document.getElementById(â€˜vreasonâ€™).value.trim();if(!r){tst(â€˜×—×•×‘×” ×œ×¦×™×™×Ÿ ×¡×™×‘×” - ××™×Ÿ ××¤×©×¨×•×ª ×œ×“×œ×’â€™,1);return;}let d=ld();d.visits.push({id:gid(),cid:cid,type:â€˜×¡×™×‘×”â€™,reason:r,date:td()});sv(d);}else{let d=ld();d.visits.push({id:gid(),cid:cid,type:â€˜×‘×™×§×•×¨â€™,date:td()});sv(d);}cm(â€˜mVisitâ€™);tst(did?â€˜×‘×™×§×•×¨ × ×¨×©×â€™:â€˜×¡×™×‘×” × ×¨×©××”â€™);rp(cp);}

// Export
function exportRoutes(){let d=ld(),cl=d.clients.filter(c=>!c.del);let csv=â€™\ufeffâ€™;csv+=â€˜×©× ×¢×¡×§,××™×© ×§×©×¨,×˜×œ×¤×•×Ÿ,×¢×™×¨,×›×ª×•×‘×ª,×ª× ××™ ×ª×©×œ×•×,×™×•× ×›× ×™×¡×”,×ª×“×™×¨×•×ª ×›× ×™×¡×”,×ª×“×™×¨×•×ª ×ª××•× ×•×ª,×—×•×‘\nâ€™;DAYS.forEach(dy=>{cl.filter(c=>c.vday===dy).forEach(c=>{let db=gDebt(c.id,d);csv+=â€™â€â€™+(c.name||â€™â€™)+â€™â€,â€â€™+(c.contact||â€™â€™)+â€™â€,â€â€™+(c.phone||â€™â€™)+â€™â€,â€â€™+(c.city||â€™â€™)+â€™â€,â€â€™+(c.address||â€™â€™)+â€™â€,â€â€™+(c.pterms||â€™â€™)+â€™â€,â€â€™+(c.vday||â€™â€™)+â€™â€,â€â€™+(c.vfreq||â€™â€™)+â€™â€,â€â€™+(c.pfreq||â€™â€™)+â€™â€,â€â€™+db+â€™â€\nâ€™;});});dlf(csv,â€˜×§×•×•×™×_×œ×§×•×—×•×ª.csvâ€™,â€˜text/csv;charset=utf-8;â€™);tst(â€˜×§×•×‘×¥ ×§×•×•×™× ×™×•×¦×â€™);}

// Import CSV
function importCSV(ev){let f=ev.target.files[0];if(!f)return;let r=new FileReader();r.onload=function(e){try{let t=e.target.result,ls=t.split(â€™\nâ€™).filter(l=>l.trim());if(ls.length<2){tst(â€˜×§×•×‘×¥ ×¨×™×§â€™,1);return;}let d=ld(),cnt=0;for(let i=1;i<ls.length;i++){let co=pcsv(ls[i]);if(co.length<7)continue;let nm=co[0]?.trim();if(!nm)continue;let ex=d.clients.find(c=>c.name===nm&&!c.del);if(ex){ex.contact=co[1]?.trim()||ex.contact;ex.phone=co[2]?.trim()||ex.phone;ex.city=co[3]?.trim()||ex.city;ex.address=co[4]?.trim()||ex.address;ex.pterms=co[5]?.trim()||ex.pterms;ex.vday=co[6]?.trim()||ex.vday;if(co[7])ex.vfreq=co[7].trim();if(co[8])ex.pfreq=co[8].trim();ex.upd=td();}else{d.clients.push({id:gid(),name:nm,contact:co[1]?.trim()||â€™â€™,phone:co[2]?.trim()||â€™â€™,city:co[3]?.trim()||â€™â€™,address:co[4]?.trim()||â€™â€™,pterms:co[5]?.trim()||â€™â€™,vday:co[6]?.trim()||â€™â€™,vfreq:co[7]?.trim()||â€˜×©×‘×•×¢×™â€™,pfreq:co[8]?.trim()||â€˜×©×‘×•×¢×™â€™,notes:â€™â€™,cre:td(),del:false});cnt++;}}sv(d);tst(â€˜×™×•×‘××• â€˜+cnt+â€™ ×œ×§×•×—×•×ª ×—×“×©×™×â€™);rp(cp);}catch(er){tst(â€˜×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥â€™,1);}};r.readAsText(f,â€˜UTF-8â€™);ev.target.value=â€™â€™;}
function pcsv(l){let r=[],c=â€™â€™,q=false;for(let i=0;i<l.length;i++){let ch=l[i];if(ch===â€™â€â€™){q=!q;continue;}if(ch===â€™,â€™&&!q){r.push(c);c=â€™â€™;continue;}c+=ch;}r.push(c);return r;}

// Utils
function om(id){document.getElementById(id).classList.add(â€˜onâ€™);}
function cm(id){document.getElementById(id).classList.remove(â€˜onâ€™);}
function tst(m,e){let t=document.createElement(â€˜divâ€™);t.className=â€™tst â€™+(e?â€˜terâ€™:â€˜tokâ€™);t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),2500);}
function scf(m,fn){document.getElementById(â€˜cfMâ€™).textContent=m;document.getElementById(â€˜cfDâ€™).classList.add(â€˜onâ€™);document.getElementById(â€˜cfYâ€™).onclick=()=>{ccf();fn();};}
function ccf(){document.getElementById(â€˜cfDâ€™).classList.remove(â€˜onâ€™);}
function dlf(c,n,m){let b=new Blob([c],{type:m}),u=URL.createObjectURL(b),a=document.createElement(â€˜aâ€™);a.href=u;a.download=n;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}

// Close modals on backdrop
document.querySelectorAll(â€™.mbgâ€™).forEach(bg=>{bg.addEventListener(â€˜clickâ€™,e=>{if(e.target===bg)bg.classList.remove(â€˜onâ€™);});});

chkA();
</script>

</body>
</html>